<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>如何选择 zip 和 tar 文件格式 | STARRY-S' Blog</title><meta name=keywords content="Archive"><meta name=description content="最近遇到了一个归档文件格式选择的问题，于是顺手记录下来水一篇博客。"><meta name=author content="STARRY-S"><link rel=canonical href=https://blog.starry-s.moe/posts/2023/zip-tar/><link crossorigin=anonymous href=/assets/css/stylesheet.978b487620cdaa9841f016801a4ed4a9688209b5ae15d6e2471aea1229f85389.css integrity="sha256-l4tIdiDNqphB8BaAGk7UqWiCCbWuFdbiRxrqEin4U4k=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.starry-s.moe/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://blog.starry-s.moe/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.starry-s.moe/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.starry-s.moe/apple-touch-icon.png><link rel=mask-icon href=https://blog.starry-s.moe/apple-touch-icon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://blog.starry-s.moe/posts/2023/zip-tar/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src=//cdn.jsdelivr.net/gh/sukkaw/busuanzi@2.3/bsz.pure.mini.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-70DHXLE02Z"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-70DHXLE02Z",{anonymize_ip:!1})}</script><meta property="og:title" content="如何选择 zip 和 tar 文件格式"><meta property="og:description" content="最近遇到了一个归档文件格式选择的问题，于是顺手记录下来水一篇博客。"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.starry-s.moe/posts/2023/zip-tar/"><meta property="og:image" content="https://blog.starry-s.moe/avatar.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-11-12T01:35:41+08:00"><meta property="article:modified_time" content="2023-11-12T12:21:22+08:00"><meta property="og:site_name" content="STARRY-S' Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.starry-s.moe/avatar.png"><meta name=twitter:title content="如何选择 zip 和 tar 文件格式"><meta name=twitter:description content="最近遇到了一个归档文件格式选择的问题，于是顺手记录下来水一篇博客。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.starry-s.moe/posts/"},{"@type":"ListItem","position":2,"name":"2023","item":"https://blog.starry-s.moe/posts/2023/"},{"@type":"ListItem","position":3,"name":"如何选择 zip 和 tar 文件格式","item":"https://blog.starry-s.moe/posts/2023/zip-tar/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"如何选择 zip 和 tar 文件格式","name":"如何选择 zip 和 tar 文件格式","description":"最近遇到了一个归档文件格式选择的问题，于是顺手记录下来水一篇博客。\n","keywords":["Archive"],"articleBody":"最近遇到了一个归档文件格式选择的问题，于是顺手记录下来水一篇博客。\ntar 文件格式 tar 格式早期是为了将数据记录在磁带上的（现在貌似也可以？），这种归档格式很简单，要将一个文件写入 tar 包的时候，首先写入记录文件信息的 header，在 header 之后记录文件的数据（tar 格式不支持压缩所以是直接把文件数据拷贝在了 header 后面）。\n+--------+ | header | +--------+ | data | +--------+ | header | +--------+ | data | +--------+ ... +--------+ | header | +--------+ | data | +--------+ | end | +--------+ tar 有多种不同格式的 header。这里可以看 Linux 系统上常用的 tar 工具（GNU tar）代码， GNU tar 中实现的 header 结构定义文档参考这个 Basic Tar Format。\nGNU tar 的源码可以通过下面的方式克隆下载下来。\n$ git clone https://git.savannah.gnu.org/git/tar.git 在 src/tar.h 源码中可以找到 header 结构定义，其中 posix_header 的定义为：\nstruct posix_header {\t/* byte offset */ char name[100];\t/* 0 */ char mode[8];\t/* 100 */ char uid[8];\t/* 108 */ char gid[8];\t/* 116 */ char size[12];\t/* 124 */ char mtime[12];\t/* 136 */ char chksum[8];\t/* 148 */ char typeflag;\t/* 156 */ char linkname[100];\t/* 157 */ char magic[6];\t/* 257 */ char version[2];\t/* 263 */ char uname[32];\t/* 265 */ char gname[32];\t/* 297 */ char devmajor[8];\t/* 329 */ char devminor[8];\t/* 337 */ char prefix[155];\t/* 345 */ /* 500 */ }; 上面 header 结构可以看出默认情况下文件名 name 长度不能超过 99 (最后一位要存储 \\0)，但似乎后面 tar 协议支持了长文件名的情况，至于如何支持的各位感兴趣的可以自行去搜一下。\n除了 posix_header 之外，还有 star_header、gnu_header 等 header 结构，header 结构体占据的空间小于 512 字节，而 tar 的每个 block 都是 512 字节，所以一个 header block 占据 512 字节，末尾空余的字节填写 \\0，文件也以 512 字节为单位写在 header block 后面，多出来的空间填写 \\0：\n/* tar files are made in basic blocks of this size. */ #define BLOCKSIZE 512 union block { char buffer[BLOCKSIZE]; struct posix_header header; struct star_header star_header; struct oldgnu_header oldgnu_header; struct sparse_header sparse_header; struct star_in_header star_in_header; struct star_ext_header star_ext_header; }; tar 文件的 end 是由至少两个 block size （1024字节）的空白（\\0）组成，但是 GNU tar 创建出来的 tar 包的 end 长度可能大于两个 block size，因为似乎它创建的 tar 包的文件体积以 10K 为单位进行了对齐，可以用下面的方式验证一下：\n$ echo \"hello world\" \u003e 1.txt $ tar -cv 1.txt -f test.tar 1.txt $ ls -al test.tar -rw-r--r-- 1 starry-s starry-s 10K Nov 12 11:42 test.tar 用 hexdump 可以看一下创建的 tar 包中包含的数据：\n$ hexdump -C ./test.tar 0000000 1 . t x t \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 0000010 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 * 0000060 \\0 \\0 \\0 \\0 0 0 0 0 6 4 4 \\0 0 0 0 1 0000070 7 5 0 \\0 0 0 0 1 7 5 0 \\0 0 0 0 0 0000080 0 0 0 0 0 1 4 \\0 1 4 5 2 4 0 4 5 0000090 3 5 4 \\0 0 1 2 1 1 2 \\0 0 \\0 \\0 \\0 00000a0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 * 0000100 \\0 u s t a r \\0 s t a r r y - 0000110 s \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 0000120 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 s t a r r y - 0000130 s \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 0000140 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 * 0000200 h e l l o w o r l d \\n \\0 \\0 \\0 \\0 0000210 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 \\0 * 0002800 其中前 0x200 长度 (512 bytes) 存储的是 header，0x200 ~ 0x2800 (10240 bytes) 区域存储了文件的数据 (hello world\\n)，文件数据后面均为空白 \\0，整体的 tar 包文件大小对齐到了 10K。\n栗子 因此这里可以用上面的 posix_header 结构体简单的写一个创建 tar 归档的程序。\n因为 header 中还包含了简易的计算 header 校验和的步骤，所以代码比较长，可以在 这里 找到。\n压缩 在创建 tar 格式的文件时是不支持压缩的，文件的数据直接写在了 header 后面（除非你想魔改创建 tar 格式的步骤，但没这个必要）。如果需要压缩的话是把整个 tar 归档用 gzip/bzip2/zstd 等其他压缩格式进行压缩，文件后缀为 tar.gz/tar.bz2/tar.zstd 等。因为是先将文件写入 tar 归档，再将 tar 归档进行压缩，所以压缩的效果会比把文件单独压缩再合并成一个 tar 包效果要好一些。\n特点 从上面的 tar 归档文件格式可以看出，tar 包中的文件是一个一个顺序排列起来的，因此 tar 包中是允许两个相同名称的文件存在的。\n如果想向 tar 包末尾附加新的文件的话也很简单，只需要找到末尾的 end block，将其覆盖重写新的文件的 header，之后再写入新文件的数据即可，因此向未压缩的 tar 包附加新的文件（甚至是覆盖掉末尾的一些文件）都是可行的。但是如果想向已压缩的 tar 包（例如 tar.gz）附加文件就不太可行了，除非先把 tar.gz 解压为 tar 格式，附加新的文件后再重新压缩成 tar.gz，但这样如果 tar 文件体积很大的话会造成额外的磁盘空间浪费和性能、时间的浪费。\n还有一点是 tar 中存储的文件是顺序排列起来的，但他没有一个 index 索引记录了每个文件的 header 所处的 offset。所以如果想知道一个 tar 包里面存了哪些文件的话，要从头到尾的遍历一遍 tar 包，因此如果这个 tar 包文件体积很大且包含很多零散的小文件的话，每次都要遍历读取 tar 包中的所有 header，会很麻烦。\n因此 tar 包不适合随机读取，未压缩的 tar 包还好，只要在首次打开文件时遍历一下把每个文件的 header 和 offset 记录下来就行，但如果是压缩过的例如 tar.gz 格式的压缩包，几乎就没办法随机读取（除非你得再去折腾 gzip 数据流，但几乎没人去这么做），如果想随机解压 tar.gz 中的某个文件，要从头开始先解压 gzip 数据流，从解压的数据流中遍历每个 tar header，在查找到待解压的文件 header 后再将其解压存储下来，麻烦得很！\n所以 tar 以及 tar.gz 等压缩的 tar 归档格式通常适合用在不需要随机读取，不需要向归档末尾附加文件的场景。\nzip 文件格式 睡觉，明天再写。\n","wordCount":"1943","inLanguage":"zh","datePublished":"2023-11-12T01:35:41+08:00","dateModified":"2023-11-12T12:21:22+08:00","author":{"@type":"Person","name":"STARRY-S"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.starry-s.moe/posts/2023/zip-tar/"},"publisher":{"@type":"Organization","name":"STARRY-S' Blog","logo":{"@type":"ImageObject","url":"https://blog.starry-s.moe/favicon-32x32.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.starry-s.moe/ accesskey=h title="STARRY-S' Blog (Alt + H)">STARRY-S' Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://blog.starry-s.moe/en/ title=English aria-label=English>En</a></li></ul></div></div><ul id=menu><li><a href=https://starry-s.moe title=主页><span>主页</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://blog.starry-s.moe/gallery/ title=相册><span>相册</span></a></li><li><a href=https://blog.starry-s.moe/archives/ title=归档><span>归档</span></a></li><li><a href=https://blog.starry-s.moe/tags/ title=标签><span>标签</span></a></li><li><a href=https://blog.starry-s.moe/categories/ title=分类><span>分类</span></a></li><li><a href=https://blog.starry-s.moe/search/ title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li><li><a href=https://blog.starry-s.moe/about/ title=关于><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.starry-s.moe/>主页</a>&nbsp;»&nbsp;<a href=https://blog.starry-s.moe/posts/>Posts</a>&nbsp;»&nbsp;<a href=https://blog.starry-s.moe/posts/2023/>2023</a></div><h1 class=post-title>如何选择 zip 和 tar 文件格式</h1><div class=post-meta><span title='2023-11-12 01:35:41 +0800 +0800'>2023-11-12 01:35:41 +0800</span>&nbsp;·&nbsp;4 分钟&nbsp;·&nbsp;1943 字&nbsp;·&nbsp;STARRY-S&nbsp;|&nbsp;<a href=https://github.com/STARRY-S/blog/tree/main/content/posts/2023/zip-tar/index.md rel="noopener noreferrer" target=_blank>Edit Text</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#tar-文件格式>tar 文件格式</a><ul><li><a href=#栗子>栗子</a></li><li><a href=#压缩>压缩</a></li><li><a href=#特点>特点</a></li></ul></li><li><a href=#zip-文件格式>zip 文件格式</a></li></ul></nav></div></details></div><div class=post-content><p>最近遇到了一个归档文件格式选择的问题，于是顺手记录下来水一篇博客。</p><hr><h2 id=tar-文件格式>tar 文件格式<a hidden class=anchor aria-hidden=true href=#tar-文件格式>#</a></h2><p>tar 格式早期是为了将数据记录在磁带上的（现在貌似也可以？），这种归档格式很简单，要将一个文件写入 tar 包的时候，首先写入记录文件信息的 header，在 header 之后记录文件的数据（tar 格式不支持压缩所以是直接把文件数据拷贝在了 header 后面）。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>+--------+
</span></span><span class=line><span class=cl>| header |
</span></span><span class=line><span class=cl>+--------+
</span></span><span class=line><span class=cl>|  data  |
</span></span><span class=line><span class=cl>+--------+
</span></span><span class=line><span class=cl>| header |
</span></span><span class=line><span class=cl>+--------+
</span></span><span class=line><span class=cl>|  data  |
</span></span><span class=line><span class=cl>+--------+
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>+--------+
</span></span><span class=line><span class=cl>| header |
</span></span><span class=line><span class=cl>+--------+
</span></span><span class=line><span class=cl>|  data  |
</span></span><span class=line><span class=cl>+--------+
</span></span><span class=line><span class=cl>|  end   |
</span></span><span class=line><span class=cl>+--------+
</span></span></code></pre></div><p>tar 有多种不同格式的 header。这里可以看 Linux 系统上常用的 <code>tar</code> 工具（GNU tar）代码，
GNU tar 中实现的 header 结构定义文档参考这个 <a href=https://www.gnu.org/software/tar/manual/html_node/Standard.html>Basic Tar Format</a>。</p><p>GNU tar 的源码可以通过下面的方式克隆下载下来。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> git clone https://git.savannah.gnu.org/git/tar.git
</span></span></code></pre></div><p>在 <code>src/tar.h</code> 源码中可以找到 header 结构定义，其中 <code>posix_header</code> 的定义为：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>posix_header</span>
</span></span><span class=line><span class=cl><span class=p>{</span>				<span class=cm>/* byte offset */</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>name</span><span class=p>[</span><span class=mi>100</span><span class=p>];</span>		<span class=cm>/*   0 */</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>mode</span><span class=p>[</span><span class=mi>8</span><span class=p>];</span>			<span class=cm>/* 100 */</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>uid</span><span class=p>[</span><span class=mi>8</span><span class=p>];</span>			<span class=cm>/* 108 */</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>gid</span><span class=p>[</span><span class=mi>8</span><span class=p>];</span>			<span class=cm>/* 116 */</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>size</span><span class=p>[</span><span class=mi>12</span><span class=p>];</span>		<span class=cm>/* 124 */</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>mtime</span><span class=p>[</span><span class=mi>12</span><span class=p>];</span>		<span class=cm>/* 136 */</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>chksum</span><span class=p>[</span><span class=mi>8</span><span class=p>];</span>		<span class=cm>/* 148 */</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>typeflag</span><span class=p>;</span>		<span class=cm>/* 156 */</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>linkname</span><span class=p>[</span><span class=mi>100</span><span class=p>];</span>		<span class=cm>/* 157 */</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>magic</span><span class=p>[</span><span class=mi>6</span><span class=p>];</span>		<span class=cm>/* 257 */</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>version</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>		<span class=cm>/* 263 */</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>uname</span><span class=p>[</span><span class=mi>32</span><span class=p>];</span>		<span class=cm>/* 265 */</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>gname</span><span class=p>[</span><span class=mi>32</span><span class=p>];</span>		<span class=cm>/* 297 */</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>devmajor</span><span class=p>[</span><span class=mi>8</span><span class=p>];</span>		<span class=cm>/* 329 */</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>devminor</span><span class=p>[</span><span class=mi>8</span><span class=p>];</span>		<span class=cm>/* 337 */</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>prefix</span><span class=p>[</span><span class=mi>155</span><span class=p>];</span>		<span class=cm>/* 345 */</span>
</span></span><span class=line><span class=cl>				<span class=cm>/* 500 */</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>上面 header 结构可以看出默认情况下文件名 <code>name</code> 长度不能超过 99 (最后一位要存储 <code>\0</code>)，但似乎后面 tar 协议支持了长文件名的情况，至于如何支持的各位感兴趣的可以自行去搜一下。</p><p>除了 <code>posix_header</code> 之外，还有 <code>star_header</code>、<code>gnu_header</code> 等 header 结构，header 结构体占据的空间小于 512 字节，而 tar 的每个 block 都是 512 字节，所以一个 header block 占据 512 字节，末尾空余的字节填写 <code>\0</code>，文件也以 512 字节为单位写在 header block 后面，多出来的空间填写 <code>\0</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/* tar files are made in basic blocks of this size.  */</span>
</span></span><span class=line><span class=cl><span class=cp>#define BLOCKSIZE 512
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>union</span> <span class=n>block</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>buffer</span><span class=p>[</span><span class=n>BLOCKSIZE</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>posix_header</span> <span class=n>header</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>star_header</span> <span class=n>star_header</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>oldgnu_header</span> <span class=n>oldgnu_header</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>sparse_header</span> <span class=n>sparse_header</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>star_in_header</span> <span class=n>star_in_header</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>star_ext_header</span> <span class=n>star_ext_header</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>tar 文件的 end 是由至少两个 block size （1024字节）的空白（<code>\0</code>）组成，但是 GNU tar 创建出来的 tar 包的 end 长度可能大于两个 block size，因为似乎它创建的 tar 包的文件体积以 10K 为单位进行了对齐，可以用下面的方式验证一下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> <span class=nb>echo</span> <span class=s2>&#34;hello world&#34;</span> &gt; 1.txt
</span></span><span class=line><span class=cl><span class=gp>$</span> tar -cv 1.txt -f test.tar
</span></span><span class=line><span class=cl><span class=go>1.txt
</span></span></span><span class=line><span class=cl><span class=go></span><span class=gp>$</span> ls -al test.tar
</span></span><span class=line><span class=cl><span class=go>-rw-r--r-- 1 starry-s starry-s 10K Nov 12 11:42 test.tar
</span></span></span></code></pre></div><p>用 <code>hexdump</code> 可以看一下创建的 tar 包中包含的数据：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> hexdump -C ./test.tar
</span></span><span class=line><span class=cl><span class=go>0000000   1   .   t   x   t  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0
</span></span></span><span class=line><span class=cl><span class=go>0000010  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0
</span></span></span><span class=line><span class=cl><span class=go>*
</span></span></span><span class=line><span class=cl><span class=go>0000060  \0  \0  \0  \0   0   0   0   0   6   4   4  \0   0   0   0   1
</span></span></span><span class=line><span class=cl><span class=go>0000070   7   5   0  \0   0   0   0   1   7   5   0  \0   0   0   0   0
</span></span></span><span class=line><span class=cl><span class=go>0000080   0   0   0   0   0   1   4  \0   1   4   5   2   4   0   4   5
</span></span></span><span class=line><span class=cl><span class=go>0000090   3   5   4  \0   0   1   2   1   1   2  \0       0  \0  \0  \0
</span></span></span><span class=line><span class=cl><span class=go>00000a0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0
</span></span></span><span class=line><span class=cl><span class=go>*
</span></span></span><span class=line><span class=cl><span class=go>0000100  \0   u   s   t   a   r          \0   s   t   a   r   r   y   -
</span></span></span><span class=line><span class=cl><span class=go>0000110   s  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0
</span></span></span><span class=line><span class=cl><span class=go>0000120  \0  \0  \0  \0  \0  \0  \0  \0  \0   s   t   a   r   r   y   -
</span></span></span><span class=line><span class=cl><span class=go>0000130   s  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0
</span></span></span><span class=line><span class=cl><span class=go>0000140  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0
</span></span></span><span class=line><span class=cl><span class=go>*
</span></span></span><span class=line><span class=cl><span class=go>0000200   h   e   l   l   o       w   o   r   l   d  \n  \0  \0  \0  \0
</span></span></span><span class=line><span class=cl><span class=go>0000210  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0
</span></span></span><span class=line><span class=cl><span class=go>*
</span></span></span><span class=line><span class=cl><span class=go>0002800
</span></span></span></code></pre></div><p>其中前 <code>0x200</code> 长度 (512 bytes) 存储的是 header，<code>0x200</code> ~ <code>0x2800</code> (10240 bytes) 区域存储了文件的数据 (<code>hello world\n</code>)，文件数据后面均为空白 <code>\0</code>，整体的 tar 包文件大小对齐到了 10K。</p><h3 id=栗子>栗子<a hidden class=anchor aria-hidden=true href=#栗子>#</a></h3><p>因此这里可以用上面的 <code>posix_header</code> 结构体简单的写一个创建 tar 归档的程序。</p><p>因为 header 中还包含了简易的计算 header 校验和的步骤，所以代码比较长，可以在 <a href=https://github.com/STARRY-S/tar-example-c>这里</a> 找到。</p><h3 id=压缩>压缩<a hidden class=anchor aria-hidden=true href=#压缩>#</a></h3><p>在创建 tar 格式的文件时是不支持压缩的，文件的数据直接写在了 header 后面（除非你想魔改创建 tar 格式的步骤，但没这个必要）。如果需要压缩的话是把整个 tar 归档用 gzip/bzip2/zstd 等其他压缩格式进行压缩，文件后缀为 <code>tar.gz/tar.bz2/tar.zstd</code> 等。因为是先将文件写入 tar 归档，再将 tar 归档进行压缩，所以压缩的效果会比把文件单独压缩再合并成一个 tar 包效果要好一些。</p><h3 id=特点>特点<a hidden class=anchor aria-hidden=true href=#特点>#</a></h3><p>从上面的 tar 归档文件格式可以看出，tar 包中的文件是一个一个顺序排列起来的，因此 tar 包中是允许两个相同名称的文件存在的。</p><p>如果想向 tar 包末尾附加新的文件的话也很简单，只需要找到末尾的 end block，将其覆盖重写新的文件的 header，之后再写入新文件的数据即可，因此向未压缩的 tar 包附加新的文件（甚至是覆盖掉末尾的一些文件）都是可行的。但是如果想向已压缩的 tar 包（例如 <code>tar.gz</code>）附加文件就不太可行了，除非先把 <code>tar.gz</code> 解压为 <code>tar</code> 格式，附加新的文件后再重新压缩成 <code>tar.gz</code>，但这样如果 tar 文件体积很大的话会造成额外的磁盘空间浪费和性能、时间的浪费。</p><p>还有一点是 tar 中存储的文件是顺序排列起来的，但他没有一个 index 索引记录了每个文件的 header 所处的 offset。所以如果想知道一个 tar 包里面存了哪些文件的话，要从头到尾的遍历一遍 tar 包，因此如果这个 tar 包文件体积很大且包含很多零散的小文件的话，每次都要遍历读取 tar 包中的所有 header，会很麻烦。</p><p>因此 tar 包不适合随机读取，未压缩的 tar 包还好，只要在首次打开文件时遍历一下把每个文件的 header 和 offset 记录下来就行，但如果是压缩过的例如 <code>tar.gz</code> 格式的压缩包，几乎就没办法随机读取（除非你得再去折腾 <code>gzip</code> 数据流，但几乎没人去这么做），如果想随机解压 <code>tar.gz</code> 中的某个文件，要从头开始先解压 <code>gzip</code> 数据流，从解压的数据流中遍历每个 tar header，在查找到待解压的文件 header 后再将其解压存储下来，麻烦得很！</p><p>所以 <code>tar</code> 以及 <code>tar.gz</code> 等压缩的 <code>tar</code> 归档格式通常适合用在不需要随机读取，不需要向归档末尾附加文件的场景。</p><h2 id=zip-文件格式>zip 文件格式<a hidden class=anchor aria-hidden=true href=#zip-文件格式>#</a></h2><blockquote><p>睡觉，明天再写。</p></blockquote></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.starry-s.moe/tags/archive/>Archive</a></li></ul><nav class=paginav><a class=next href=https://blog.starry-s.moe/posts/2023/fix-shrunken-disk-broken-partition-table/><span class=title>下一页 »</span><br><span>修复缩小磁盘空间后受损的 GPT 分区表</span></a></nav></footer><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//starry-s-blog.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>© 2016 - 2023 STARRY-S | <a href=https://creativecommons.org/licenses/by-nc-nd/4.0/>CC BY-NC-ND 4.0</a> | Hosted on <a href=https://pages.github.com>GitHub Pages</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>const images=document.querySelectorAll("img");Array.from(images).forEach(e=>{e.addEventListener("load",()=>fitImage(e)),e.complete&&e.naturalWidth!==0&&fitImage(e)});function fitImage(e){const t=window.location.pathname;if(!t.includes("/posts/"))return;e.style.marginLeft="auto",e.style.marginRight="auto",e.naturalWidth/e.naturalHeight<1.1&&(e.style.maxWidth="60%",e.style.height="auto")}</script><script src=/js/home-info.js></script>
<script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>