<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>容器镜像 Manifest 相关内容整理 | STARRY-S' Blog</title>
<meta name=keywords content="Container"><meta name=description content="最近总在弄些容器镜像相关的东西，于是分享一些咱自己总结的有关容器镜像 Manifest 格式、常用工具以及代码相关的芝士。"><meta name=author content="STARRY-S"><link rel=canonical href=https://blog.starry-s.moe/posts/2023/container-manifest/><link crossorigin=anonymous href=/assets/css/stylesheet.82243f2445c1f83101fee8f6753a80b2b140ea4c8ea2f729a484fe488b619f89.css integrity="sha256-giQ/JEXB+DEB/uj2dTqAsrFA6kyOovcppIT+SIthn4k=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.starry-s.moe/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://blog.starry-s.moe/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.starry-s.moe/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.starry-s.moe/apple-touch-icon.png><link rel=mask-icon href=https://blog.starry-s.moe/apple-touch-icon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://blog.starry-s.moe/posts/2023/container-manifest/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/aplayer/dist/APlayer.min.css><script src=https://fastly.jsdelivr.net/npm/aplayer/dist/APlayer.min.js></script><script src=https://fastly.jsdelivr.net/npm/meting/dist/Meting.min.js></script><script>var meting_api="https://api.injahow.cn/meting/?server=:server&type=:type&id=:id&auth=:auth&r=:r"</script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#232323"><meta property="og:url" content="https://blog.starry-s.moe/posts/2023/container-manifest/"><meta property="og:site_name" content="STARRY-S' Blog"><meta property="og:title" content="容器镜像 Manifest 相关内容整理"><meta property="og:description" content="最近总在弄些容器镜像相关的东西，于是分享一些咱自己总结的有关容器镜像 Manifest 格式、常用工具以及代码相关的芝士。"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-05-21T01:50:27+08:00"><meta property="article:modified_time" content="2023-05-21T01:50:27+08:00"><meta property="article:tag" content="Container"><meta property="og:image" content="https://blog.starry-s.moe/avatar.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.starry-s.moe/avatar.png"><meta name=twitter:title content="容器镜像 Manifest 相关内容整理"><meta name=twitter:description content="最近总在弄些容器镜像相关的东西，于是分享一些咱自己总结的有关容器镜像 Manifest 格式、常用工具以及代码相关的芝士。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.starry-s.moe/posts/"},{"@type":"ListItem","position":2,"name":"容器镜像 Manifest 相关内容整理","item":"https://blog.starry-s.moe/posts/2023/container-manifest/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"容器镜像 Manifest 相关内容整理","name":"容器镜像 Manifest 相关内容整理","description":"最近总在弄些容器镜像相关的东西，于是分享一些咱自己总结的有关容器镜像 Manifest 格式、常用工具以及代码相关的芝士。\n","keywords":["Container"],"articleBody":"最近总在弄些容器镜像相关的东西，于是分享一些咱自己总结的有关容器镜像 Manifest 格式、常用工具以及代码相关的芝士。\nskopeo skopeo 是一个肥肠好用的容器镜像的辅助工具，常用到的功能有镜像拷贝 (skopeo copy)、镜像 Manifest 查询 (skopeo inspect)等……\nskopeo 仅支持 Linux 和 macOS 系统。\n安装 skopeo # ArchLinux sudo pacman -S skopeo # macOS brew install skopeo 除此之外还可以使用 skopeo 的容器镜像：\n$ docker run docker://quay.io/skopeo/stable:latest copy --help skopeo 由 Go 编写，但它启用了 cgo，编译的二进制文件需要动态链接第三方依赖，所以不同的系统编译的 skopeo 二进制文件并不一定互相通用，如果你的发行版的官方源没有提供 skopeo 软件包的话，只能手动安装 Go 和 skopeo 的一些依赖，然后 自行编译 skopeo 二进制文件。\nskopeo copy copy 可以灵活的拷贝容器镜像，它可以将容器镜像从 Registry Server 之间拷贝，还可以将镜像从 Registry Server 拷贝到本地的文件夹中，或者像 docker pull 那样拷贝到 Docker Daemon 中。\n在执行 skopeo copy 时还可以用 --format 参数指定拷贝过去的容器镜像的格式，用参数 --dest-compress-format 可以指定压缩格式。\n将容器镜像从第三方 DockerHub Registry Server 拷贝到自建的 Private Registry Server：\n$ skopeo copy docker://docker.io/library/nginx:latest docker://private.registry.io/library/nginx:latest --all 将镜像从 DockerHub Registry Server 拷贝到本地文件夹中：\n$ mkdir -p nginx $ skopeo copy docker://docker.io/library/nginx:latest dir:./nginx 将镜像从本地文件夹中拷贝到 Docker Daemon 中：\n$ skopeo copy dir:./nginx docker-daemon:nginx:latest $ docker images REPOSITORY TAG IMAGE ID CREATED SIZE nginx latest 448a08f1d2f9 13 days ago 142MB skopeo inspect skopeo inspect 查看容器镜像的信息，例如镜像的 Manifest、Config。\n$ skopeo inspect docker://docker.io/library/nginx:latest $ skopeo inspect docker://docker.io/library/nginx:latest --raw $ skopeo inspect docker://docker.io/library/nginx:latest --raw --config skopeo inspect 不加任何参数时，查询的是容器镜像相关的信息，输出的内容包括镜像 Digest、该镜像其他的所有 Tag 等一系列信息。\n在添加 --raw 参数时，输出的是该镜像的 Manifest 原始信息，因为是 RAW，所以输出的 Json 可能格式不是很友好，通常与 jq 一起使用。\n添加 --raw 和 --config 参数后，输出的是该镜像的 Config 的原始信息，Config 中包括容器运行时的一些配置项等信息。\nManifest Docker 文档 Registry image manifests 中介绍了几种常见的 Docker 镜像的 Manifest 格式。\n可以通过 skopeo 工具，从 Docker Hub 上挑一个容器镜像 (例如 nginx:latest)，查看这个镜像的 Manifest。\n// skopeo inspect docker://nginx:latest --raw | jq { \"manifests\": [ { \"digest\": \"sha256:3f01b0094e21f7d55b9eb7179d01c49fdf9c3e1e3419d315b81a9e0bae1b6a90\", \"mediaType\": \"application/vnd.docker.distribution.manifest.v2+json\", \"platform\": { \"architecture\": \"amd64\", \"os\": \"linux\" }, \"size\": 1570 }, { \"digest\": \"sha256:bc4cb92540db42f21dd806c4451f33b623a9b6441c882e8554325f3a3702da76\", \"mediaType\": \"application/vnd.docker.distribution.manifest.v2+json\", \"platform\": { \"architecture\": \"arm\", \"os\": \"linux\", \"variant\": \"v5\" }, \"size\": 1570 }, ...... ], \"mediaType\": \"application/vnd.docker.distribution.manifest.list.v2+json\", \"schemaVersion\": 2 } 这里输出的 json object 的 schemaVersion 为 2，mediaType 为 application/vnd.docker.distribution.manifest.list.v2+json。\nschemaVersion \u0026 mediaType 容器镜像的 Manifest 有很多种不同的格式，先列举一下常见的 Docker 镜像的 Manifest 格式：\nschemaVersion: 1, mediaType: \"application/vnd.docker.distribution.manifest.v1+json\"\n旧版本的 Docker 使用这种 Manifest 格式，现已被弃用，有些旧的容器镜像依旧是这种格式的 Manifest。\n// skopeo inspect docker://mysql:5.5.40 --raw | jq { \"name\": \"library/mysql\", \"tag\": \"5.5.40\", \"architecture\": \"amd64\", \"fsLayers\": [ { \"blobSum\": \"sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4\" } ...... ], \"history\": [ ...... ], \"schemaVersion\": 1, \"signatures\": [ { ...... } ] } (输出太长了所以我把不关键的内容省略掉了……)\n这里用 docker.io/library/mysql:5.5.40 这个镜像举例，实际这个镜像的 Manifest 格式为 schemaVersion: 1，mediaType: \"application/vnd.docker.distribution.manifest.v1+prettyjws\"，因为包含了签名信息。\nschemaVersion: 2, mediaType: \"application/vnd.docker.distribution.manifest.v2+json\"\n这个是现在常见的 Docker 镜像的 Manifest 格式。\n// skopeo inspect docker://hxstarrys/nginx:1.22-amd64 --raw | jq { \"schemaVersion\": 2, \"mediaType\": \"application/vnd.docker.distribution.manifest.v2+json\", \"config\": { \"mediaType\": \"application/vnd.docker.container.image.v1+json\", \"size\": 7898, \"digest\": \"sha256:0f8498f13f3adef3f3c8b52cdf069ecc880b081159be6349163d144e8aa5fb29\" }, \"layers\": [ { \"mediaType\": \"application/vnd.docker.image.rootfs.diff.tar.gzip\", \"size\": 31411405, \"digest\": \"sha256:f1f26f5702560b7e591bef5c4d840f76a232bf13fd5aefc4e22077a1ae4440c7\" }, { \"mediaType\": \"application/vnd.docker.image.rootfs.diff.tar.gzip\", \"size\": 25573496, \"digest\": \"sha256:fd03b214f77493ccb73705ac5417f16c7625a7ea7ea997e939c9241a3296763b\" }, ...... ] } 这个格式的 Manifest 包含了镜像的 Config 的信息以及 Layer 的格式和 Digest 信息。\nschemaVersion: 2, mediaType: \"application/vnd.docker.distribution.manifest.list.v2+json\"\n这个格式的 Manifest List 包含一个 manifests 列表：\n// skopeo inspect docker://docker.io/library/nginx:1.22 --raw | jq { \"mediaType\": \"application/vnd.docker.distribution.manifest.list.v2+json\", \"schemaVersion\": 2, \"manifests\": [ { \"mediaType\": \"application/vnd.docker.distribution.manifest.v2+json\", \"digest\": \"sha256:9081064712674ffcff7b7bdf874c75bcb8e5fb933b65527026090dacda36ea8b\", \"size\": 1570, \"platform\": { \"architecture\": \"amd64\", \"os\": \"linux\" } }, { \"mediaType\": \"application/vnd.docker.distribution.manifest.v2+json\", \"digest\": \"sha256:cf4ffe24f08a167176c84f2779c9fc35c2f7ce417b411978e384cbe63525b420\", \"size\": 1570, \"platform\": { \"architecture\": \"arm64\", \"os\": \"linux\" } } ] } 例如在 x86_64 (amd64) 架构的 Linux 主机上拉取 TAG docker.io/library/nginx:1.22 时，会根据此 Manifest List，拉取 Digest 为 sha256:9081064712674ffcff7b7bdf874c75bcb8e5fb933b65527026090dacda36ea8b 的镜像。在 aarch64 (arm64v8) 架构的 Linux 主机上拉取此 TAG 时，会根据 Manifest List，拉取 Digest 为 sha256:cf4ffe24f08a167176c84f2779c9fc35c2f7ce417b411978e384cbe63525b420 的镜像，在其他 OS 的主机上无法拉取这个 TAG 对应的镜像 (例如在 arm32v7 的 Linux 主机上拉取会失败)。\nmanifests 列表中，每个 digest 字段存储的是这个镜像的 Manifest 内容的 sha256 校验和。\n可以用 skopeo inspect 查看一下这个 digest 的镜像的 Manifest 内容，其格式为 schemaVersion: 2, mediaType: \"application/vnd.docker.distribution.manifest.v2+json\"\n// skopeo inspect docker://nginx@sha256:9081064712674ffcff7b7bdf874c75bcb8e5fb933b65527026090dacda36ea8b --raw | jq { \"schemaVersion\": 2, \"mediaType\": \"application/vnd.docker.distribution.manifest.v2+json\", \"config\": { \"mediaType\": \"application/vnd.docker.container.image.v1+json\", \"size\": 7898, \"digest\": \"sha256:0f8498f13f3adef3f3c8b52cdf069ecc880b081159be6349163d144e8aa5fb29\" }, \"layers\": [ { \"mediaType\": \"application/vnd.docker.image.rootfs.diff.tar.gzip\", \"size\": 31411405, \"digest\": \"sha256:f1f26f5702560b7e591bef5c4d840f76a232bf13fd5aefc4e22077a1ae4440c7\" }, { \"mediaType\": \"application/vnd.docker.image.rootfs.diff.tar.gzip\", \"size\": 25573496, \"digest\": \"sha256:fd03b214f77493ccb73705ac5417f16c7625a7ea7ea997e939c9241a3296763b\" }, { \"mediaType\": \"application/vnd.docker.image.rootfs.diff.tar.gzip\", \"size\": 626, \"digest\": \"sha256:ef2fc869b944b87eaf25f4c92953dc69736d5d05aa09f66f54b0eea598e13c9c\" }, { \"mediaType\": \"application/vnd.docker.image.rootfs.diff.tar.gzip\", \"size\": 958, \"digest\": \"sha256:ac713a9ef2cca7a82e27f0277e4e3d25c64d1cf31e4acd798562d5532742f5ef\" }, { \"mediaType\": \"application/vnd.docker.image.rootfs.diff.tar.gzip\", \"size\": 773, \"digest\": \"sha256:fd071922d543e072b21cb41a513634657049d632fe48cfed240be2369f998403\" }, { \"mediaType\": \"application/vnd.docker.image.rootfs.diff.tar.gzip\", \"size\": 1405, \"digest\": \"sha256:2a9f38700bb5a0462e326fe3541b45f24a677ac3cd386c4922d48da5fbb6f0a8\" } ] } 镜像的 Digest 实际上是这个镜像的 Manifest 内容的 sha256sum 校验和：\n$ skopeo inspect --raw docker://nginx@sha256:9081064712674ffcff7b7bdf874c75bcb8e5fb933b65527026090dacda36ea8b { \"schemaVersion\": 2, \"mediaType\": \"application/vnd.docker.distribution.manifest.v2+json\", \"config\": { \"mediaType\": \"application/vnd.docker.container.image.v1+json\", \"size\": 7898, \"digest\": \"sha256:0f8498f13f3adef3f3c8b52cdf069ecc880b081159be6349163d144e8aa5fb29\" }, ...... $ skopeo inspect --raw docker://nginx@sha256:9081064712674ffcff7b7bdf874c75bcb8e5fb933b65527026090dacda36ea8b | sha256sum 9081064712674ffcff7b7bdf874c75bcb8e5fb933b65527026090dacda36ea8b - 同理，Config 的 Digest 为镜像的 Config 内容的 sha256sum 校验和：\n$ skopeo inspect --raw --config docker://nginx@sha256:9081064712674ffcff7b7bdf874c75bcb8e5fb933b65527026090dacda36ea8b | sha256sum 0f8498f13f3adef3f3c8b52cdf069ecc880b081159be6349163d144e8aa5fb29 - 除了上面的几种 Docker 镜像的 Manifest 格式外，还有 OCI 容器镜像 这种格式的 Manifest:\nschemaVersion: 2, mediaType: \"application/vnd.oci.image.manifest.v1+json\" // skopeo inspect docker://quay.io/skopeo/stable@sha256:9da6763a4d35592a6279e851738472d9cdaa8ff5a5da3c50b560f065d22c2bff --raw | jq { \"schemaVersion\": 2, \"mediaType\": \"application/vnd.oci.image.manifest.v1+json\", \"config\": { \"mediaType\": \"application/vnd.oci.image.config.v1+json\", \"digest\": \"sha256:6acf3c9f5dd48704618fa7ec2b95968a45c9e7809926a1f90f383bea4e9b3ede\", \"size\": 3032 }, \"layers\": [ { \"mediaType\": \"application/vnd.oci.image.layer.v1.tar+gzip\", \"digest\": \"sha256:529411ad578ab92819185dd8ef493eaa1eecc4f62b2ed2199db99ae23e6bf4cd\", \"size\": 73881106 }, { \"mediaType\": \"application/vnd.oci.image.layer.v1.tar+gzip\", \"digest\": \"sha256:eeaa0b0d534352a9398996bcff9dc1184a78d310c22800aa6de07a6e2b1f8864\", \"size\": 54520878 }, { \"mediaType\": \"application/vnd.oci.image.layer.v1.tar+gzip\", \"digest\": \"sha256:5ebf46cd2e6b356313b1dce504191fefce45df90dd8b5df7fe6b8cdd0fd06667\", \"size\": 1849 }, { \"mediaType\": \"application/vnd.oci.image.layer.v1.tar+gzip\", \"digest\": \"sha256:d4779f97b4911cd73b8bbe8b96c6759b6f5c210928020e0c351294e7136aeb94\", \"size\": 4061 }, { \"mediaType\": \"application/vnd.oci.image.layer.v1.tar+gzip\", \"digest\": \"sha256:f2e09c14b28b7453b48d13aace7cef657580e3b1cfdc0be8cfb9e685862a068f\", \"size\": 228 } ], \"annotations\": { \"org.opencontainers.image.base.digest\": \"sha256:7acf70fa27721ef08357823d79324a19d7e9b0d34873c93f33a1b654d784e3c4\", \"org.opencontainers.image.base.name\": \"registry.fedoraproject.org/fedora:latest\" } } schemaVersion: 2, mediaType: \"application/vnd.oci.image.index.v1+json\" // skopeo inspect docker://quay.io/skopeo/stable:latest --raw | jq { \"schemaVersion\": 2, \"mediaType\": \"application/vnd.oci.image.index.v1+json\", \"manifests\": [ { \"mediaType\": \"application/vnd.oci.image.manifest.v1+json\", \"digest\": \"sha256:3f678eca3035c64243c70598efeb4f60ef06a07b156444e21feed9488d47944b\", \"size\": 1239, \"platform\": { \"architecture\": \"arm64\", \"os\": \"linux\" } }, { \"mediaType\": \"application/vnd.oci.image.manifest.v1+json\", \"digest\": \"sha256:72464a265722c05436b5f46b9247929a882e73462f33ac1c000f4a34094fc90c\", \"size\": 1239, \"platform\": { \"architecture\": \"amd64\", \"os\": \"linux\" } } ] } Library containers 和 opencontainers Org 提供了许多容器镜像相关的 Go Library，例如：\ncontainers/image containers/common opencontainers/image-spec Docker Manifest 格式的定义位于代码：containers/image/v5/manifest\nOCI 容器镜像的 Manifest 格式定义位于代码：opencontainers/image-spec/specs-go/v1\nskopeo inspect 的代码位于 containers/skopeo/cmd/skopeo/inspect.go，skopeo 用了 cobra 框架来处理用户的命令行参数（这里悄悄安利一下 cobra 框架真的很好用，尤其是当你的程序有许多的子命令，每个子命令需要处理的参数还都不一样的情况），执行查询镜像 Manifest 的代码都在 run 函数里面。\n下面是咱写的一个栗子，使用上述的 Library 模拟一下 skopeo inspect 查看容器镜像 Manifest 的功能，其实查看容器镜像 Manifest 的代码实现还是蛮简单的：\npackage example import ( \"context\" \"encoding/json\" \"fmt\" \"testing\" \"github.com/containers/image/v5/transports/alltransports\" \"github.com/containers/image/v5/types\" ) func Test_Inspect(t *testing.T) { // reference name format: docker://: refName := \"docker://docker.io/library/nginx:latest\" ref, err := alltransports.ParseImageName(refName) if err != nil { t.Errorf(\"ParseImageName: %v\", err) return } sysCtx := \u0026types.SystemContext{ DockerAuthConfig: \u0026types.DockerAuthConfig{ Username: \"\", // docker username (optional) Password: \"\", // docker password (optional) }, // set to true if server is HTTP or using insecure certificate OCIInsecureSkipTLSVerify: false, DockerInsecureSkipTLSVerify: types.NewOptionalBool(false), } source, err := ref.NewImageSource(context.TODO(), sysCtx) if err != nil { t.Errorf(\"NewImageSource: %v\", err) return } data, mime, err := source.GetManifest(context.TODO(), nil) if err != nil { t.Errorf(\"GetManifest: %v\", err) return } fmt.Printf(\"Manifest mediaType: %v\\n\", mime) fmt.Printf(\"Manifest RAW data: \\n%v\\n\", string(data)) // reformat output var obj any if err = json.Unmarshal(data, \u0026obj); err != nil { t.Errorf(\"Unmarshal: %v\", err) return } if data, err = json.MarshalIndent(obj, \"\", \" \"); err != nil { t.Errorf(\"MarshalIndent: %v\", err) return } fmt.Printf(\"===================================\\n\") fmt.Printf(\"Manifest data: \\n%v\\n\", string(data)) } 接下来，是构建 Manifest List 索引的一个简单栗子，假设你分别向 Registry Server 上传了 /example:v1.0.0-amd64 和 /example:v1.0.0-arm64 两个不同架构的容器镜像，你希望用户在 AMD64 架构的主机上拉取 /example:v1.0.0 的 TAG 时，自动拉取 /example:v1.0.0-amd64 这个镜像，而在 ARM64 架构的主机上拉取时，自动拉取 /example:v1.0.0-arm64 这个镜像。\n这里说的 Manifest List 实际是 schemaVersion 2, mediaType: \"application/vnd.docker.distribution.manifest.list.v2+json\"\n基本上你可以使用任何的 Registry Server，但 Harbor V1 除外，因为 Harbor V1 不支持 Manifest List。\npackage example import ( \"context\" \"crypto/sha256\" \"encoding/json\" \"fmt\" \"testing\" \"github.com/containers/image/v5/manifest\" \"github.com/containers/image/v5/transports/alltransports\" \"github.com/containers/image/v5/types\" \"github.com/opencontainers/go-digest\" ) func sha256sum(data []byte) string { sum := sha256.Sum256(data) return fmt.Sprintf(\"%x\", sum) } func getManifest(refName string, ctx *types.SystemContext) ([]byte, string, error) { // reference name format: docker://: ref, err := alltransports.ParseImageName(refName) if err != nil { return nil, \"\", fmt.Errorf(\"ParseImageName: %w\", err) } source, err := ref.NewImageSource(context.TODO(), ctx) if err != nil { return nil, \"\", fmt.Errorf(\"NewImageSource: %v\", err) } return source.GetManifest(context.TODO(), nil) } func Test_BuildManifest(t *testing.T) { // reference name format: docker://: refName := \"docker:////example:v1.0.0\" ref, err := alltransports.ParseImageName(refName) if err != nil { t.Errorf(\"ParseImageName: %v\", err) return } sysCtx := \u0026types.SystemContext{ DockerAuthConfig: \u0026types.DockerAuthConfig{ Username: \"\", // registry username (required) Password: \"\", // registry password (required) }, // set to true if server is HTTP or using insecure certificate OCIInsecureSkipTLSVerify: false, DockerInsecureSkipTLSVerify: types.NewOptionalBool(false), } manifestList := manifest.Schema2List{ SchemaVersion: 2, MediaType: manifest.DockerV2ListMediaType, Manifests: []manifest.Schema2ManifestDescriptor{}, } // add amd64 data data, mime, err := getManifest(\"docker:////example:v1.0.0-amd64\", sysCtx) if err != nil { t.Errorf(\"getManifest: %v\", err) return } manifestList.Manifests = append(manifestList.Manifests, manifest.Schema2ManifestDescriptor{ Schema2Descriptor: manifest.Schema2Descriptor{ MediaType: mime, Size: int64(len(data)), Digest: digest.Digest(sha256sum(data)), }, Platform: manifest.Schema2PlatformSpec{ Architecture: \"amd64\", OS: \"linux\", OSVersion: \"\", Variant: \"\", }, }) // add arm64 data data, mime, err = getManifest(\"docker:////example:v1.0.0-arm64\", sysCtx) if err != nil { t.Errorf(\"getManifest: %v\", err) return } manifestList.Manifests = append(manifestList.Manifests, manifest.Schema2ManifestDescriptor{ Schema2Descriptor: manifest.Schema2Descriptor{ MediaType: mime, Size: int64(len(data)), Digest: digest.Digest(sha256sum(data)), }, Platform: manifest.Schema2PlatformSpec{ Architecture: \"arm64\", OS: \"linux\", OSVersion: \"\", Variant: \"v8\", }, }) dest, err := ref.NewImageDestination(context.TODO(), sysCtx) if err != nil { t.Errorf(\"NewImageSource: %v\", err) return } if data, err = json.MarshalIndent(manifestList, \"\", \" \"); err != nil { t.Errorf(\"MarshalIndent: %v\", err) return } if err = dest.PutManifest(context.TODO(), data, nil); err != nil { t.Errorf(\"PutManifest: %v\", err) return } } 构建 Manifest 的栗子中，用到了一部分 Manifest 的代码，用来获取 amd64 架构的镜像和 arm64 架构镜像的 Manifest 文本长度，并计算 Digest。\n","wordCount":"2731","inLanguage":"zh","image":"https://blog.starry-s.moe/avatar.png","datePublished":"2023-05-21T01:50:27+08:00","dateModified":"2023-05-21T01:50:27+08:00","author":{"@type":"Person","name":"STARRY-S"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.starry-s.moe/posts/2023/container-manifest/"},"publisher":{"@type":"Organization","name":"STARRY-S' Blog","logo":{"@type":"ImageObject","url":"https://blog.starry-s.moe/favicon-32x32.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.starry-s.moe/ accesskey=h title="Blog (Alt + H)"><img src=https://blog.starry-s.moe/apple-touch-icon.png alt aria-label=logo height=24>Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.starry-s.moe/gallery/ title=相册><span>相册</span></a></li><li><a href=https://blog.starry-s.moe/archives/ title=归档><span>归档</span></a></li><li><a href=https://blog.starry-s.moe/tags/ title=标签><span>标签</span></a></li><li><a href=https://blog.starry-s.moe/categories/ title=分类><span>分类</span></a></li><li><a href=https://blog.starry-s.moe/search/ title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li><li><a href=https://blog.starry-s.moe/projects/ title=项目><span>项目</span></a></li><li><a href=https://blog.starry-s.moe/about/ title=关于><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.starry-s.moe/>主页</a>&nbsp;»&nbsp;<a href=https://blog.starry-s.moe/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">容器镜像 Manifest 相关内容整理</h1><div class=post-meta><span title='2023-05-21 01:50:27 +0800 +0800'>2023-05-21 01:50:27 +0800</span>&nbsp;·&nbsp;6 分钟&nbsp;·&nbsp;2731 字&nbsp;·&nbsp;STARRY-S&nbsp;|&nbsp;<a href=https://github.com/STARRY-S/blog/edit/main/content/posts/2023/container-manifest/index.md rel="noopener noreferrer" target=_blank>Edit Text</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#skopeo>skopeo</a><ul><li><a href=#安装-skopeo>安装 skopeo</a></li><li><a href=#skopeo-copy>skopeo copy</a></li><li><a href=#skopeo-inspect>skopeo inspect</a></li></ul></li><li><a href=#manifest>Manifest</a><ul><li><a href=#schemaversion--mediatype>schemaVersion & mediaType</a></li></ul></li><li><a href=#library>Library</a></li></ul></nav></div></details></div><div class=post-content><p>最近总在弄些容器镜像相关的东西，于是分享一些咱自己总结的有关容器镜像 Manifest 格式、常用工具以及代码相关的芝士。</p><meting-js server=netease type=song id=590414 theme=#233333></meting-js><h2 id=skopeo>skopeo<a hidden class=anchor aria-hidden=true href=#skopeo>#</a></h2><p><a href=https://github.com/containers/skopeo>skopeo</a> 是一个肥肠好用的容器镜像的辅助工具，常用到的功能有镜像拷贝 (<code>skopeo copy</code>)、镜像 Manifest 查询 (<code>skopeo inspect</code>)等……</p><p><code>skopeo</code> 仅支持 Linux 和 macOS 系统。</p><h3 id=安装-skopeo>安装 skopeo<a hidden class=anchor aria-hidden=true href=#安装-skopeo>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># ArchLinux</span>
</span></span><span class=line><span class=cl>sudo pacman -S skopeo
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># macOS</span>
</span></span><span class=line><span class=cl>brew install skopeo
</span></span></code></pre></div><p>除此之外还可以使用 <code>skopeo</code> 的容器镜像：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> docker run docker://quay.io/skopeo/stable:latest copy --help
</span></span></code></pre></div><blockquote><p><code>skopeo</code> 由 Go 编写，但它启用了 <code>cgo</code>，编译的二进制文件需要动态链接第三方依赖，所以不同的系统编译的 skopeo 二进制文件并不一定互相通用，如果你的发行版的官方源没有提供 <code>skopeo</code> 软件包的话，只能手动安装 Go 和 <code>skopeo</code> 的一些依赖，然后 <a href=https://github.com/containers/skopeo/blob/main/install.md#building-from-source>自行编译 skopeo 二进制文件</a>。</p></blockquote><h3 id=skopeo-copy>skopeo copy<a hidden class=anchor aria-hidden=true href=#skopeo-copy>#</a></h3><p><code>copy</code> 可以灵活的拷贝容器镜像，它可以将容器镜像从 Registry Server 之间拷贝，还可以将镜像从 Registry Server 拷贝到本地的文件夹中，或者像 <code>docker pull</code> 那样拷贝到 Docker Daemon 中。</p><p>在执行 <code>skopeo copy</code> 时还可以用 <code>--format</code> 参数指定拷贝过去的容器镜像的格式，用参数 <code>--dest-compress-format</code> 可以指定压缩格式。</p><p>将容器镜像从第三方 DockerHub Registry Server 拷贝到自建的 Private Registry Server：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> skopeo copy docker://docker.io/library/nginx:latest docker://private.registry.io/library/nginx:latest --all
</span></span></code></pre></div><p>将镜像从 DockerHub Registry Server 拷贝到本地文件夹中：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> mkdir -p nginx
</span></span><span class=line><span class=cl><span class=gp>$</span> skopeo copy docker://docker.io/library/nginx:latest dir:./nginx
</span></span></code></pre></div><p>将镜像从本地文件夹中拷贝到 Docker Daemon 中：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> skopeo copy dir:./nginx docker-daemon:nginx:latest
</span></span><span class=line><span class=cl><span class=gp>$</span> docker images
</span></span><span class=line><span class=cl><span class=go>REPOSITORY  TAG       IMAGE ID       CREATED        SIZE
</span></span></span><span class=line><span class=cl><span class=go>nginx       latest    448a08f1d2f9   13 days ago    142MB
</span></span></span></code></pre></div><h3 id=skopeo-inspect>skopeo inspect<a hidden class=anchor aria-hidden=true href=#skopeo-inspect>#</a></h3><p><code>skopeo inspect</code> 查看容器镜像的信息，例如镜像的 Manifest、Config。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> skopeo inspect docker://docker.io/library/nginx:latest
</span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>$</span> skopeo inspect docker://docker.io/library/nginx:latest --raw
</span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>$</span> skopeo inspect docker://docker.io/library/nginx:latest --raw --config
</span></span></code></pre></div><p><code>skopeo inspect</code> 不加任何参数时，查询的是容器镜像相关的信息，输出的内容包括镜像 Digest、该镜像其他的所有 Tag 等一系列信息。</p><p>在添加 <code>--raw</code> 参数时，输出的是该镜像的 Manifest 原始信息，因为是 RAW，所以输出的 Json 可能格式不是很友好，通常与 <code>jq</code> 一起使用。</p><p>添加 <code>--raw</code> 和 <code>--config</code> 参数后，输出的是该镜像的 Config 的原始信息，Config 中包括容器运行时的一些配置项等信息。</p><h2 id=manifest>Manifest<a hidden class=anchor aria-hidden=true href=#manifest>#</a></h2><p>Docker 文档 <a href=https://docs.docker.com/registry/spec/manifest-v2-1/>Registry image manifests</a> 中介绍了几种常见的 Docker 镜像的 Manifest 格式。</p><hr><p>可以通过 <a href=https://github.com/containers/skopeo>skopeo</a> 工具，从 Docker Hub 上挑一个容器镜像 (例如 <code>nginx:latest</code>)，查看这个镜像的 Manifest。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=c1>// skopeo inspect docker://nginx:latest --raw | jq
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;manifests&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;digest&#34;</span><span class=p>:</span> <span class=s2>&#34;sha256:3f01b0094e21f7d55b9eb7179d01c49fdf9c3e1e3419d315b81a9e0bae1b6a90&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;mediaType&#34;</span><span class=p>:</span> <span class=s2>&#34;application/vnd.docker.distribution.manifest.v2+json&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;platform&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;architecture&#34;</span><span class=p>:</span> <span class=s2>&#34;amd64&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;os&#34;</span><span class=p>:</span> <span class=s2>&#34;linux&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>1570</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;digest&#34;</span><span class=p>:</span> <span class=s2>&#34;sha256:bc4cb92540db42f21dd806c4451f33b623a9b6441c882e8554325f3a3702da76&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;mediaType&#34;</span><span class=p>:</span> <span class=s2>&#34;application/vnd.docker.distribution.manifest.v2+json&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;platform&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;architecture&#34;</span><span class=p>:</span> <span class=s2>&#34;arm&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;os&#34;</span><span class=p>:</span> <span class=s2>&#34;linux&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;variant&#34;</span><span class=p>:</span> <span class=s2>&#34;v5&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>1570</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=err>......</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;mediaType&#34;</span><span class=p>:</span> <span class=s2>&#34;application/vnd.docker.distribution.manifest.list.v2+json&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;schemaVersion&#34;</span><span class=p>:</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>这里输出的 json object 的 <code>schemaVersion</code> 为 2，<code>mediaType</code> 为 <code>application/vnd.docker.distribution.manifest.list.v2+json</code>。</p><h3 id=schemaversion--mediatype>schemaVersion & mediaType<a hidden class=anchor aria-hidden=true href=#schemaversion--mediatype>#</a></h3><p>容器镜像的 Manifest 有很多种不同的格式，先列举一下常见的 Docker 镜像的 Manifest 格式：</p><ol><li><p><code>schemaVersion: 1</code>, <code>mediaType: "application/vnd.docker.distribution.manifest.v1+json"</code></p><p>旧版本的 Docker 使用这种 Manifest 格式，现已被弃用，有些旧的容器镜像依旧是这种格式的 Manifest。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=c1>// skopeo inspect docker://mysql:5.5.40 --raw | jq
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;library/mysql&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;tag&#34;</span><span class=p>:</span> <span class=s2>&#34;5.5.40&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;architecture&#34;</span><span class=p>:</span> <span class=s2>&#34;amd64&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;fsLayers&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;blobSum&#34;</span><span class=p>:</span> <span class=s2>&#34;sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=err>......</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;history&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=err>......</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;schemaVersion&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;signatures&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=err>......</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>(输出太长了所以我把不关键的内容省略掉了……)</p><p>这里用 <code>docker.io/library/mysql:5.5.40</code> 这个镜像举例，实际这个镜像的 Manifest 格式为 <code>schemaVersion: 1</code>，<code>mediaType: "application/vnd.docker.distribution.manifest.v1+prettyjws"</code>，因为包含了签名信息。</p></li><li><p><code>schemaVersion: 2</code>, <code>mediaType: "application/vnd.docker.distribution.manifest.v2+json"</code></p><p>这个是现在常见的 Docker 镜像的 Manifest 格式。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=c1>// skopeo inspect docker://hxstarrys/nginx:1.22-amd64 --raw | jq
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nt>&#34;schemaVersion&#34;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nt>&#34;mediaType&#34;</span><span class=p>:</span> <span class=s2>&#34;application/vnd.docker.distribution.manifest.v2+json&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nt>&#34;config&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;mediaType&#34;</span><span class=p>:</span> <span class=s2>&#34;application/vnd.docker.container.image.v1+json&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>7898</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;digest&#34;</span><span class=p>:</span> <span class=s2>&#34;sha256:0f8498f13f3adef3f3c8b52cdf069ecc880b081159be6349163d144e8aa5fb29&#34;</span>
</span></span><span class=line><span class=cl><span class=p>},</span>
</span></span><span class=line><span class=cl><span class=nt>&#34;layers&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;mediaType&#34;</span><span class=p>:</span> <span class=s2>&#34;application/vnd.docker.image.rootfs.diff.tar.gzip&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>31411405</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;digest&#34;</span><span class=p>:</span> <span class=s2>&#34;sha256:f1f26f5702560b7e591bef5c4d840f76a232bf13fd5aefc4e22077a1ae4440c7&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;mediaType&#34;</span><span class=p>:</span> <span class=s2>&#34;application/vnd.docker.image.rootfs.diff.tar.gzip&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>25573496</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;digest&#34;</span><span class=p>:</span> <span class=s2>&#34;sha256:fd03b214f77493ccb73705ac5417f16c7625a7ea7ea997e939c9241a3296763b&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=err>......</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>这个格式的 Manifest 包含了镜像的 Config 的信息以及 Layer 的格式和 Digest 信息。</p></li><li><p><code>schemaVersion: 2</code>, <code>mediaType: "application/vnd.docker.distribution.manifest.list.v2+json"</code></p><p>这个格式的 Manifest List 包含一个 <code>manifests</code> 列表：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=c1>// skopeo inspect docker://docker.io/library/nginx:1.22 --raw | jq
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nt>&#34;mediaType&#34;</span><span class=p>:</span> <span class=s2>&#34;application/vnd.docker.distribution.manifest.list.v2+json&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nt>&#34;schemaVersion&#34;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nt>&#34;manifests&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;mediaType&#34;</span><span class=p>:</span> <span class=s2>&#34;application/vnd.docker.distribution.manifest.v2+json&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;digest&#34;</span><span class=p>:</span> <span class=s2>&#34;sha256:9081064712674ffcff7b7bdf874c75bcb8e5fb933b65527026090dacda36ea8b&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>1570</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;platform&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;architecture&#34;</span><span class=p>:</span> <span class=s2>&#34;amd64&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;os&#34;</span><span class=p>:</span> <span class=s2>&#34;linux&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;mediaType&#34;</span><span class=p>:</span> <span class=s2>&#34;application/vnd.docker.distribution.manifest.v2+json&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;digest&#34;</span><span class=p>:</span> <span class=s2>&#34;sha256:cf4ffe24f08a167176c84f2779c9fc35c2f7ce417b411978e384cbe63525b420&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>1570</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;platform&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;architecture&#34;</span><span class=p>:</span> <span class=s2>&#34;arm64&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;os&#34;</span><span class=p>:</span> <span class=s2>&#34;linux&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>例如在 x86_64 (amd64) 架构的 Linux 主机上拉取 TAG <code>docker.io/library/nginx:1.22</code> 时，会根据此 Manifest List，拉取 Digest 为 <code>sha256:9081064712674ffcff7b7bdf874c75bcb8e5fb933b65527026090dacda36ea8b</code> 的镜像。在 aarch64 (arm64v8) 架构的 Linux 主机上拉取此 TAG 时，会根据 Manifest List，拉取 Digest 为 <code>sha256:cf4ffe24f08a167176c84f2779c9fc35c2f7ce417b411978e384cbe63525b420</code> 的镜像，在其他 OS 的主机上无法拉取这个 TAG 对应的镜像 (例如在 arm32v7 的 Linux 主机上拉取会失败)。</p><p><code>manifests</code> 列表中，每个 <code>digest</code> 字段存储的是这个镜像的 Manifest 内容的 sha256 校验和。</p><p>可以用 <code>skopeo inspect</code> 查看一下这个 digest 的镜像的 Manifest 内容，其格式为
<code>schemaVersion: 2</code>, <code>mediaType: "application/vnd.docker.distribution.manifest.v2+json"</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=c1>// skopeo inspect docker://nginx@sha256:9081064712674ffcff7b7bdf874c75bcb8e5fb933b65527026090dacda36ea8b --raw | jq
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;schemaVersion&#34;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;mediaType&#34;</span><span class=p>:</span> <span class=s2>&#34;application/vnd.docker.distribution.manifest.v2+json&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;config&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;mediaType&#34;</span><span class=p>:</span> <span class=s2>&#34;application/vnd.docker.container.image.v1+json&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>7898</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;digest&#34;</span><span class=p>:</span> <span class=s2>&#34;sha256:0f8498f13f3adef3f3c8b52cdf069ecc880b081159be6349163d144e8aa5fb29&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;layers&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;mediaType&#34;</span><span class=p>:</span> <span class=s2>&#34;application/vnd.docker.image.rootfs.diff.tar.gzip&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>31411405</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;digest&#34;</span><span class=p>:</span> <span class=s2>&#34;sha256:f1f26f5702560b7e591bef5c4d840f76a232bf13fd5aefc4e22077a1ae4440c7&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;mediaType&#34;</span><span class=p>:</span> <span class=s2>&#34;application/vnd.docker.image.rootfs.diff.tar.gzip&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>25573496</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;digest&#34;</span><span class=p>:</span> <span class=s2>&#34;sha256:fd03b214f77493ccb73705ac5417f16c7625a7ea7ea997e939c9241a3296763b&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;mediaType&#34;</span><span class=p>:</span> <span class=s2>&#34;application/vnd.docker.image.rootfs.diff.tar.gzip&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>626</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;digest&#34;</span><span class=p>:</span> <span class=s2>&#34;sha256:ef2fc869b944b87eaf25f4c92953dc69736d5d05aa09f66f54b0eea598e13c9c&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;mediaType&#34;</span><span class=p>:</span> <span class=s2>&#34;application/vnd.docker.image.rootfs.diff.tar.gzip&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>958</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;digest&#34;</span><span class=p>:</span> <span class=s2>&#34;sha256:ac713a9ef2cca7a82e27f0277e4e3d25c64d1cf31e4acd798562d5532742f5ef&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;mediaType&#34;</span><span class=p>:</span> <span class=s2>&#34;application/vnd.docker.image.rootfs.diff.tar.gzip&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>773</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;digest&#34;</span><span class=p>:</span> <span class=s2>&#34;sha256:fd071922d543e072b21cb41a513634657049d632fe48cfed240be2369f998403&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;mediaType&#34;</span><span class=p>:</span> <span class=s2>&#34;application/vnd.docker.image.rootfs.diff.tar.gzip&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>1405</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;digest&#34;</span><span class=p>:</span> <span class=s2>&#34;sha256:2a9f38700bb5a0462e326fe3541b45f24a677ac3cd386c4922d48da5fbb6f0a8&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>镜像的 Digest 实际上是这个镜像的 Manifest 内容的 sha256sum 校验和：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> skopeo inspect --raw docker://nginx@sha256:9081064712674ffcff7b7bdf874c75bcb8e5fb933b65527026090dacda36ea8b
</span></span><span class=line><span class=cl><span class=go>{
</span></span></span><span class=line><span class=cl><span class=go>    &#34;schemaVersion&#34;: 2,
</span></span></span><span class=line><span class=cl><span class=go>    &#34;mediaType&#34;: &#34;application/vnd.docker.distribution.manifest.v2+json&#34;,
</span></span></span><span class=line><span class=cl><span class=go>    &#34;config&#34;: {
</span></span></span><span class=line><span class=cl><span class=go>        &#34;mediaType&#34;: &#34;application/vnd.docker.container.image.v1+json&#34;,
</span></span></span><span class=line><span class=cl><span class=go>        &#34;size&#34;: 7898,
</span></span></span><span class=line><span class=cl><span class=go>        &#34;digest&#34;: &#34;sha256:0f8498f13f3adef3f3c8b52cdf069ecc880b081159be6349163d144e8aa5fb29&#34;
</span></span></span><span class=line><span class=cl><span class=go>    },
</span></span></span><span class=line><span class=cl><span class=go>    ......
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>$</span> skopeo inspect --raw docker://nginx@sha256:9081064712674ffcff7b7bdf874c75bcb8e5fb933b65527026090dacda36ea8b <span class=p>|</span> sha256sum
</span></span><span class=line><span class=cl><span class=go>9081064712674ffcff7b7bdf874c75bcb8e5fb933b65527026090dacda36ea8b  -
</span></span></span></code></pre></div><p>同理，Config 的 Digest 为镜像的 Config 内容的 sha256sum 校验和：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> skopeo inspect --raw --config docker://nginx@sha256:9081064712674ffcff7b7bdf874c75bcb8e5fb933b65527026090dacda36ea8b <span class=p>|</span> sha256sum
</span></span><span class=line><span class=cl><span class=go>0f8498f13f3adef3f3c8b52cdf069ecc880b081159be6349163d144e8aa5fb29  -
</span></span></span></code></pre></div></li></ol><hr><p>除了上面的几种 Docker 镜像的 Manifest 格式外，还有 <a href=https://github.com/opencontainers/image-spec/blob/main/manifest.md>OCI 容器镜像</a> 这种格式的 Manifest:</p><ol><li><code>schemaVersion: 2</code>, <code>mediaType: "application/vnd.oci.image.manifest.v1+json"</code><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=c1>// skopeo inspect docker://quay.io/skopeo/stable@sha256:9da6763a4d35592a6279e851738472d9cdaa8ff5a5da3c50b560f065d22c2bff --raw | jq
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;schemaVersion&#34;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;mediaType&#34;</span><span class=p>:</span> <span class=s2>&#34;application/vnd.oci.image.manifest.v1+json&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;config&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;mediaType&#34;</span><span class=p>:</span> <span class=s2>&#34;application/vnd.oci.image.config.v1+json&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;digest&#34;</span><span class=p>:</span> <span class=s2>&#34;sha256:6acf3c9f5dd48704618fa7ec2b95968a45c9e7809926a1f90f383bea4e9b3ede&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>3032</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;layers&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;mediaType&#34;</span><span class=p>:</span> <span class=s2>&#34;application/vnd.oci.image.layer.v1.tar+gzip&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;digest&#34;</span><span class=p>:</span> <span class=s2>&#34;sha256:529411ad578ab92819185dd8ef493eaa1eecc4f62b2ed2199db99ae23e6bf4cd&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>73881106</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;mediaType&#34;</span><span class=p>:</span> <span class=s2>&#34;application/vnd.oci.image.layer.v1.tar+gzip&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;digest&#34;</span><span class=p>:</span> <span class=s2>&#34;sha256:eeaa0b0d534352a9398996bcff9dc1184a78d310c22800aa6de07a6e2b1f8864&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>54520878</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;mediaType&#34;</span><span class=p>:</span> <span class=s2>&#34;application/vnd.oci.image.layer.v1.tar+gzip&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;digest&#34;</span><span class=p>:</span> <span class=s2>&#34;sha256:5ebf46cd2e6b356313b1dce504191fefce45df90dd8b5df7fe6b8cdd0fd06667&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>1849</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;mediaType&#34;</span><span class=p>:</span> <span class=s2>&#34;application/vnd.oci.image.layer.v1.tar+gzip&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;digest&#34;</span><span class=p>:</span> <span class=s2>&#34;sha256:d4779f97b4911cd73b8bbe8b96c6759b6f5c210928020e0c351294e7136aeb94&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>4061</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;mediaType&#34;</span><span class=p>:</span> <span class=s2>&#34;application/vnd.oci.image.layer.v1.tar+gzip&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;digest&#34;</span><span class=p>:</span> <span class=s2>&#34;sha256:f2e09c14b28b7453b48d13aace7cef657580e3b1cfdc0be8cfb9e685862a068f&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>228</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;annotations&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;org.opencontainers.image.base.digest&#34;</span><span class=p>:</span> <span class=s2>&#34;sha256:7acf70fa27721ef08357823d79324a19d7e9b0d34873c93f33a1b654d784e3c4&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;org.opencontainers.image.base.name&#34;</span><span class=p>:</span> <span class=s2>&#34;registry.fedoraproject.org/fedora:latest&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div></li><li><code>schemaVersion: 2</code>, <code>mediaType: "application/vnd.oci.image.index.v1+json"</code><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=c1>// skopeo inspect docker://quay.io/skopeo/stable:latest --raw | jq
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;schemaVersion&#34;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;mediaType&#34;</span><span class=p>:</span> <span class=s2>&#34;application/vnd.oci.image.index.v1+json&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;manifests&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;mediaType&#34;</span><span class=p>:</span> <span class=s2>&#34;application/vnd.oci.image.manifest.v1+json&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;digest&#34;</span><span class=p>:</span> <span class=s2>&#34;sha256:3f678eca3035c64243c70598efeb4f60ef06a07b156444e21feed9488d47944b&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>1239</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;platform&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;architecture&#34;</span><span class=p>:</span> <span class=s2>&#34;arm64&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;os&#34;</span><span class=p>:</span> <span class=s2>&#34;linux&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;mediaType&#34;</span><span class=p>:</span> <span class=s2>&#34;application/vnd.oci.image.manifest.v1+json&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;digest&#34;</span><span class=p>:</span> <span class=s2>&#34;sha256:72464a265722c05436b5f46b9247929a882e73462f33ac1c000f4a34094fc90c&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>1239</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;platform&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;architecture&#34;</span><span class=p>:</span> <span class=s2>&#34;amd64&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;os&#34;</span><span class=p>:</span> <span class=s2>&#34;linux&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div></li></ol><h2 id=library>Library<a hidden class=anchor aria-hidden=true href=#library>#</a></h2><p><a href=https://github.com/containers>containers</a> 和 <a href=https://github.com/opencontainers>opencontainers</a> Org 提供了许多容器镜像相关的 Go Library，例如：</p><ul><li><a href=https://github.com/containers/image>containers/image</a></li><li><a href=https://github.com/containers/common>containers/common</a></li><li><a href=https://github.com/opencontainers/image-spec>opencontainers/image-spec</a></li></ul><p>Docker Manifest 格式的定义位于代码：<a href=https://github.com/containers/image/blob/main/manifest/manifest.go>containers/image/v5/manifest</a></p><p>OCI 容器镜像的 Manifest 格式定义位于代码：<a href=https://github.com/opencontainers/image-spec/blob/main/specs-go/v1/mediatype.go>opencontainers/image-spec/specs-go/v1</a></p><p><code>skopeo inspect</code> 的代码位于 <a href=https://github.com/containers/skopeo/blob/main/cmd/skopeo/inspect.go>containers/skopeo/cmd/skopeo/inspect.go</a>，<code>skopeo</code> 用了 <a href=https://github.com/spf13/cobra>cobra</a> 框架来处理用户的命令行参数（这里悄悄安利一下 <code>cobra</code> 框架真的很好用，尤其是当你的程序有许多的子命令，每个子命令需要处理的参数还都不一样的情况），执行查询镜像 Manifest 的代码都在 <code>run</code> 函数里面。</p><hr><p>下面是咱写的一个栗子，使用上述的 Library 模拟一下 <code>skopeo inspect</code> 查看容器镜像 Manifest 的功能，其实查看容器镜像 Manifest 的代码实现还是蛮简单的：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>example</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;encoding/json&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;testing&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/containers/image/v5/transports/alltransports&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/containers/image/v5/types&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Test_Inspect</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// reference name format: docker://&lt;image&gt;:&lt;tag&gt;
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>refName</span> <span class=o>:=</span> <span class=s>&#34;docker://docker.io/library/nginx:latest&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>ref</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>alltransports</span><span class=p>.</span><span class=nf>ParseImageName</span><span class=p>(</span><span class=nx>refName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>t</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;ParseImageName: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>sysCtx</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>types</span><span class=p>.</span><span class=nx>SystemContext</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>DockerAuthConfig</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>types</span><span class=p>.</span><span class=nx>DockerAuthConfig</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Username</span><span class=p>:</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=c1>// docker username (optional)
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>Password</span><span class=p>:</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=c1>// docker password (optional)
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=c1>// set to true if server is HTTP or using insecure certificate
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>OCIInsecureSkipTLSVerify</span><span class=p>:</span>    <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>DockerInsecureSkipTLSVerify</span><span class=p>:</span> <span class=nx>types</span><span class=p>.</span><span class=nf>NewOptionalBool</span><span class=p>(</span><span class=kc>false</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>source</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ref</span><span class=p>.</span><span class=nf>NewImageSource</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>TODO</span><span class=p>(),</span> <span class=nx>sysCtx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>t</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;NewImageSource: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>data</span><span class=p>,</span> <span class=nx>mime</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>source</span><span class=p>.</span><span class=nf>GetManifest</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>TODO</span><span class=p>(),</span> <span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>t</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;GetManifest: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Manifest mediaType: %v\n&#34;</span><span class=p>,</span> <span class=nx>mime</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Manifest RAW data: \n%v\n&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>data</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// reformat output
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kd>var</span> <span class=nx>obj</span> <span class=nx>any</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=nx>data</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>obj</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>t</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Unmarshal: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>data</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>MarshalIndent</span><span class=p>(</span><span class=nx>obj</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=s>&#34;  &#34;</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>t</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;MarshalIndent: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;===================================\n&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Manifest data: \n%v\n&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>data</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><hr><p>接下来，是构建 Manifest List 索引的一个简单栗子，假设你分别向 Registry Server 上传了 <code>&lt;namespace>/example:v1.0.0-amd64</code> 和 <code>&lt;namespace>/example:v1.0.0-arm64</code> 两个不同架构的容器镜像，你希望用户在 AMD64 架构的主机上拉取 <code>&lt;namespace>/example:v1.0.0</code> 的 TAG 时，自动拉取 <code>&lt;namespace>/example:v1.0.0-amd64</code> 这个镜像，而在 ARM64 架构的主机上拉取时，自动拉取 <code>&lt;namespace>/example:v1.0.0-arm64</code> 这个镜像。</p><blockquote><p>这里说的 Manifest List 实际是 <code>schemaVersion 2</code>, <code>mediaType: "application/vnd.docker.distribution.manifest.list.v2+json"</code></p><p>基本上你可以使用任何的 Registry Server，但 Harbor V1 除外，因为 Harbor V1 不支持 Manifest List。</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>example</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;crypto/sha256&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;encoding/json&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;testing&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/containers/image/v5/manifest&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/containers/image/v5/transports/alltransports&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/containers/image/v5/types&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/opencontainers/go-digest&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>sha256sum</span><span class=p>(</span><span class=nx>data</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>)</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>sum</span> <span class=o>:=</span> <span class=nx>sha256</span><span class=p>.</span><span class=nf>Sum256</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%x&#34;</span><span class=p>,</span> <span class=nx>sum</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>getManifest</span><span class=p>(</span><span class=nx>refName</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>ctx</span> <span class=o>*</span><span class=nx>types</span><span class=p>.</span><span class=nx>SystemContext</span><span class=p>)</span> <span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// reference name format: docker://&lt;image&gt;:&lt;tag&gt;
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>ref</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>alltransports</span><span class=p>.</span><span class=nf>ParseImageName</span><span class=p>(</span><span class=nx>refName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;ParseImageName: %w&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>source</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ref</span><span class=p>.</span><span class=nf>NewImageSource</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>TODO</span><span class=p>(),</span> <span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;NewImageSource: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>source</span><span class=p>.</span><span class=nf>GetManifest</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>TODO</span><span class=p>(),</span> <span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Test_BuildManifest</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// reference name format: docker://&lt;image&gt;:&lt;tag&gt;
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>refName</span> <span class=o>:=</span> <span class=s>&#34;docker://&lt;REGISTRY_URL:PORT&gt;/&lt;NAMESPACE&gt;/example:v1.0.0&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>ref</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>alltransports</span><span class=p>.</span><span class=nf>ParseImageName</span><span class=p>(</span><span class=nx>refName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>t</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;ParseImageName: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>sysCtx</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>types</span><span class=p>.</span><span class=nx>SystemContext</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>DockerAuthConfig</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>types</span><span class=p>.</span><span class=nx>DockerAuthConfig</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Username</span><span class=p>:</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=c1>// registry username (required)
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>Password</span><span class=p>:</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=c1>// registry password (required)
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=c1>// set to true if server is HTTP or using insecure certificate
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>OCIInsecureSkipTLSVerify</span><span class=p>:</span>    <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>DockerInsecureSkipTLSVerify</span><span class=p>:</span> <span class=nx>types</span><span class=p>.</span><span class=nf>NewOptionalBool</span><span class=p>(</span><span class=kc>false</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>manifestList</span> <span class=o>:=</span> <span class=nx>manifest</span><span class=p>.</span><span class=nx>Schema2List</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>SchemaVersion</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>MediaType</span><span class=p>:</span>     <span class=nx>manifest</span><span class=p>.</span><span class=nx>DockerV2ListMediaType</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Manifests</span><span class=p>:</span>     <span class=p>[]</span><span class=nx>manifest</span><span class=p>.</span><span class=nx>Schema2ManifestDescriptor</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// add amd64 data
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>data</span><span class=p>,</span> <span class=nx>mime</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>getManifest</span><span class=p>(</span><span class=s>&#34;docker://&lt;REGISTRY_URL:PORT&gt;/&lt;NAMESPACE&gt;/example:v1.0.0-amd64&#34;</span><span class=p>,</span> <span class=nx>sysCtx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>t</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;getManifest: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>manifestList</span><span class=p>.</span><span class=nx>Manifests</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>manifestList</span><span class=p>.</span><span class=nx>Manifests</span><span class=p>,</span> <span class=nx>manifest</span><span class=p>.</span><span class=nx>Schema2ManifestDescriptor</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Schema2Descriptor</span><span class=p>:</span> <span class=nx>manifest</span><span class=p>.</span><span class=nx>Schema2Descriptor</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>MediaType</span><span class=p>:</span> <span class=nx>mime</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Size</span><span class=p>:</span>      <span class=nb>int64</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>data</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>			<span class=nx>Digest</span><span class=p>:</span>    <span class=nx>digest</span><span class=p>.</span><span class=nf>Digest</span><span class=p>(</span><span class=nf>sha256sum</span><span class=p>(</span><span class=nx>data</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=nx>Platform</span><span class=p>:</span> <span class=nx>manifest</span><span class=p>.</span><span class=nx>Schema2PlatformSpec</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Architecture</span><span class=p>:</span> <span class=s>&#34;amd64&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>OS</span><span class=p>:</span>           <span class=s>&#34;linux&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>OSVersion</span><span class=p>:</span>    <span class=s>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Variant</span><span class=p>:</span>      <span class=s>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// add arm64 data
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>data</span><span class=p>,</span> <span class=nx>mime</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nf>getManifest</span><span class=p>(</span><span class=s>&#34;docker://&lt;REGISTRY_URL:PORT&gt;/&lt;NAMESPACE&gt;/example:v1.0.0-arm64&#34;</span><span class=p>,</span> <span class=nx>sysCtx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>t</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;getManifest: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>manifestList</span><span class=p>.</span><span class=nx>Manifests</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>manifestList</span><span class=p>.</span><span class=nx>Manifests</span><span class=p>,</span> <span class=nx>manifest</span><span class=p>.</span><span class=nx>Schema2ManifestDescriptor</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Schema2Descriptor</span><span class=p>:</span> <span class=nx>manifest</span><span class=p>.</span><span class=nx>Schema2Descriptor</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>MediaType</span><span class=p>:</span> <span class=nx>mime</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Size</span><span class=p>:</span>      <span class=nb>int64</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>data</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>			<span class=nx>Digest</span><span class=p>:</span>    <span class=nx>digest</span><span class=p>.</span><span class=nf>Digest</span><span class=p>(</span><span class=nf>sha256sum</span><span class=p>(</span><span class=nx>data</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=nx>Platform</span><span class=p>:</span> <span class=nx>manifest</span><span class=p>.</span><span class=nx>Schema2PlatformSpec</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Architecture</span><span class=p>:</span> <span class=s>&#34;arm64&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>OS</span><span class=p>:</span>           <span class=s>&#34;linux&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>OSVersion</span><span class=p>:</span>    <span class=s>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Variant</span><span class=p>:</span>      <span class=s>&#34;v8&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>dest</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ref</span><span class=p>.</span><span class=nf>NewImageDestination</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>TODO</span><span class=p>(),</span> <span class=nx>sysCtx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>t</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;NewImageSource: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>data</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>MarshalIndent</span><span class=p>(</span><span class=nx>manifestList</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=s>&#34;  &#34;</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>t</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;MarshalIndent: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>dest</span><span class=p>.</span><span class=nf>PutManifest</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>TODO</span><span class=p>(),</span> <span class=nx>data</span><span class=p>,</span> <span class=kc>nil</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>t</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;PutManifest: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>构建 Manifest 的栗子中，用到了一部分 Manifest 的代码，用来获取 amd64 架构的镜像和 arm64 架构镜像的 Manifest 文本长度，并计算 Digest。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.starry-s.moe/tags/container/>Container</a></li></ul><nav class=paginav><a class=prev href=https://blog.starry-s.moe/posts/2023/harbor-helm-chart/><span class=title>« 上一页</span><br><span>使用 Helm Chart 方式部署 Harbor</span>
</a><a class=next href=https://blog.starry-s.moe/posts/2023/2023-05-01/><span class=title>下一页 »</span><br><span>咱今年的五一旅行游记</span></a></nav></footer><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//starry-s-blog.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>© 2016 - 2025 STARRY-S | <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a> | Hosted on <a href=https://pages.github.com>GitHub Pages</a><br></span>·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>const pathname=window.location.pathname,images=document.querySelectorAll("img");Array.from(images).forEach(e=>{if(!pathname.includes("/posts/"))return;if(e.src.indexOf("images")<0)return;e.addEventListener("load",()=>fitImage(e)),e.complete&&e.naturalWidth!==0&&fitImage(e)});function fitImage(e){e.style.marginLeft="auto",e.style.marginRight="auto",e.naturalWidth/e.naturalHeight<1.1&&(e.style.maxWidth="60%",e.style.height="auto")}</script><script src=/js/home-info.js></script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>