<!DOCTYPE html>
<html lang="zh" dir="auto" data-theme="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>入手一台家用级 APC UPS | STARRY-S&#39; Blog</title>
<meta name="keywords" content="碎碎念, 日常">
<meta name="description" content="为了让咱的 NAS 长时间稳定运行，斥巨资买了一台 APC BK650M2-CH，在 Arch Wiki 上看 APC 的 UPS 对 Linux 的支持比较友好，于是挑了个最便宜的带停电自动关机的 APC UPS，防止咱啥时候忘了交电费导致停电数据受损。">
<meta name="author" content="STARRY-S">
<link rel="canonical" href="https://blog.starry-s.moe/posts/2023/apc-ups/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.5ea96d65090d903c4b3b57af33f9766457193cbe3c48470b654d56684cce3656.css" integrity="sha256-XqltZQkNkDxLO1evM/l2ZFcZPL48SEcLZU1WaEzONlY=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://blog.starry-s.moe/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://blog.starry-s.moe/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://blog.starry-s.moe/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://blog.starry-s.moe/apple-touch-icon.png">
<link rel="mask-icon" href="https://blog.starry-s.moe/apple-touch-icon.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://blog.starry-s.moe/posts/2023/apc-ups/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
                color-scheme: dark;
            }

            .list {
                background: var(--theme);
            }

            .toc {
                background: var(--entry);
            }
        }

        @media (prefers-color-scheme: light) {
            .list::-webkit-scrollbar-thumb {
                border-color: var(--code-bg);
            }
        }

    </style>
</noscript>
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.querySelector("html").dataset.theme = 'dark';
    } else if (localStorage.getItem("pref-theme") === "light") {
       document.querySelector("html").dataset.theme = 'light';
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.querySelector("html").dataset.theme = 'dark';
    } else {
        document.querySelector("html").dataset.theme = 'light';
    }

</script><link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
<link rel="shortcut icon" href="/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
<link rel="manifest" href="/site.webmanifest" />

<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#232323">
<meta property="og:url" content="https://blog.starry-s.moe/posts/2023/apc-ups/">
  <meta property="og:site_name" content="STARRY-S&#39; Blog">
  <meta property="og:title" content="入手一台家用级 APC UPS">
  <meta property="og:description" content="为了让咱的 NAS 长时间稳定运行，斥巨资买了一台 APC BK650M2-CH，在 Arch Wiki 上看 APC 的 UPS 对 Linux 的支持比较友好，于是挑了个最便宜的带停电自动关机的 APC UPS，防止咱啥时候忘了交电费导致停电数据受损。">
  <meta property="og:locale" content="zh">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-01-08T11:05:02+08:00">
    <meta property="article:modified_time" content="2023-01-08T11:05:02+08:00">
    <meta property="article:tag" content="碎碎念">
    <meta property="article:tag" content="日常">
      <meta property="og:image" content="https://blog.starry-s.moe/web-app-manifest-512x512.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog.starry-s.moe/web-app-manifest-512x512.png">
<meta name="twitter:title" content="入手一台家用级 APC UPS">
<meta name="twitter:description" content="为了让咱的 NAS 长时间稳定运行，斥巨资买了一台 APC BK650M2-CH，在 Arch Wiki 上看 APC 的 UPS 对 Linux 的支持比较友好，于是挑了个最便宜的带停电自动关机的 APC UPS，防止咱啥时候忘了交电费导致停电数据受损。">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://blog.starry-s.moe/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "入手一台家用级 APC UPS",
      "item": "https://blog.starry-s.moe/posts/2023/apc-ups/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "入手一台家用级 APC UPS",
  "name": "入手一台家用级 APC UPS",
  "description": "为了让咱的 NAS 长时间稳定运行，斥巨资买了一台 APC BK650M2-CH，在 Arch Wiki 上看 APC 的 UPS 对 Linux 的支持比较友好，于是挑了个最便宜的带停电自动关机的 APC UPS，防止咱啥时候忘了交电费导致停电数据受损。\n",
  "keywords": [
    "碎碎念", "日常"
  ],
  "articleBody": "为了让咱的 NAS 长时间稳定运行，斥巨资买了一台 APC BK650M2-CH，在 Arch Wiki 上看 APC 的 UPS 对 Linux 的支持比较友好，于是挑了个最便宜的带停电自动关机的 APC UPS，防止咱啥时候忘了交电费导致停电数据受损。\n参烤链接: APC UPS - ArchWiki\nUPS 到手后花了半个多小时读使用说明书，然后第一件事是把 UPS 的断电报警蜂鸣器关掉，省得我不在公寓的时候停电了 UPS 叫个没完吵到邻居。\n之后在装 UPS 之前先把我电脑支架背面一团电线重新整理了一遍，现在是台式机、显示器、NAS、光猫、路由器、无线 AP 都放在一起了，他们的电源线、网线、数据线、显示器线都团在了一起，整理起来炒鸡麻烦。\n先把漏油器、光猫和 NAS 的电源都插 UPS 上，然后接好 UPS 的 USB 数据线到 NAS 上。\n安装 apcupsd 安装 apcupsd，然后 systemctl enable --now apcupsd.service。\n$ sudo apcaccess status APC : 001,036,0869 DATE : 2023-01-08 11:09:23 +0800 HOSTNAME : ApertureNAS VERSION : 3.14.14 (31 May 2016) unknown UPSNAME : ApertureNAS CABLE : USB Cable DRIVER : USB UPS Driver UPSMODE : Stand Alone STARTTIME: 2023-01-02 23:57:44 +0800 MODEL : Back-UPS BK650M2-CH STATUS : ONLINE ...... 先把 NAS 里所有的应用都停掉，之后编辑 /etc/apcupsd/apcupsd.conf，把 TIMEOUT 改为 1，然后给 UPS 断电，这时 NAS 会自动关机。\nUPS 重新连接电源后，NAS 可能会自动开机，我的 NAS 是这样，但不确定所有 NAS 都这样。\n配置自动休眠 按照 Wiki 配置停电后自动休眠 (Hibernate / 休眠到硬盘)。\n在此之前，需要创建 swap 分区 (或 swap file)，然后配置休眠需要的内核参数并重构 initramfs。\n以 root 用户创建 /usr/local/bin/hibernate：\n#!/bin/bash # Hibernate the system - designed to be called via symlink from /etc/apcupsd # directory in case of apcupsd initiating a shutdown/reboot. Can also be used # interactively or from any script to cause a hibernate. # 可以在这里加一些在休眠之前执行的操作，例如让 bot 发个邮件提醒停电了之类的 # Wall message # 广播消息 wall -n System will be hibernate soon sleep 1 # Do the hibernate # 执行休眠 /usr/bin/systemctl hibernate # At this point system should be hibernated - when it comes back, we resume this script here # 现在，系统应当已经休眠了，当系统恢复运行的时候，脚本会继续从这里执行 # 可以在这里加一些在系统恢复之后的操作，例如让 bot 发个邮件提醒电力恢复了啥的 # On resume, tell controlling script (/etc/apcupsd/apccontrol) NOT to continue with default action (i.e. shutdown). exit 99 别忘了赋予可执行权限。\n# chmod +x /usr/local/bin/hibernate 创建软链接把脚本链接到 /etc/apcupsd 目录下面。\n# ln -s /usr/local/bin/hibernate /etc/apcupsd/doshutdown 此时给 UPS 断电后，NAS 会自动休眠，等一两分钟 NAS 会完成休眠，但 UPS 仍处于运行状态没有关机，长时间停电的话，UPS 的电量会耗尽。\nUPS 接回电源后，NAS 会从休眠中恢复。\n配置休眠后关闭 UPS 电源 创建 /usr/lib/systemd/system-sleep/ups-kill：\n#!/bin/bash case $2 in # In the event the computer is hibernating. hibernate) case $1 in # Going into a hibernate state. pre) # See if this is a powerfail situation. if [ -f /etc/apcupsd/powerfail ]; then echo echo \"ACPUPSD will now power off the UPS\" echo /etc/apcupsd/apccontrol killpower echo echo \"Please ensure that the UPS has powered off before rebooting\" echo \"Otherwise, the UPS may cut the power during the reboot!!!\" echo fi ;; # Coming out of a hibernate state. post) # If there are remnants from a powerfail situation, remove them. if [ -f /etc/apcupsd/powerfail ]; then rm /etc/apcupsd/powerfail fi # This may also exist, need to remove it. if [ -f /etc/nologin ]; then rm /etc/nologin fi # Restart the daemon; otherwise it may be unresponsive in a # second powerfailure situation. systemctl restart apcupsd ;; esac ;; esac 赋予可执行权限：\n# chmod +x /usr/lib/systemd/system-sleep/ups-kill 接下来给 UPS 断电，NAS 会自动休眠，等 NAS 休眠后再过几分钟 UPS 也会关机。\nUPS 关机后，给 UPS 接上电源，这时 UPS 会自动开机，然后 NAS 也会从休眠中恢复。\n不要在 UPS 还没关机的时候给 UPS 重新接回电源，会导致 UPS 关机后 NAS 刚从休眠中恢复就被强制断电。\n其他 折腾 UPS 的时候顺手给 NAS 换了个散热器升级了一下内存。AMD 原装散热器有亿点点吵所以换成了咱之前买的 ITX 散热器。\n用咱写的 telebot 查看一下空载时的 CPU 温度才不到 30 度。\nCPU: +28.2°C Uptime: 0.15 Hour TotalRAM: 46.45G FreeRAM: 42.66G AvailableRAM: 43.91G TotalSwap: 46.00G FreeSwap: 46.00G 运行一个虚拟机一个 MineCraft 服务器，CPU 温度不到 40，所以很安静。\n但是 UPS 它有噪音，晚上睡觉的时候能听见 UPS 它嗡嗡响，比 AMD 散热器的风扇动静还大，这个实在是无解，算了就先这样吧。\n",
  "wordCount" : "1399",
  "inLanguage": "zh",
  "image": "https://blog.starry-s.moe/web-app-manifest-512x512.png","datePublished": "2023-01-08T11:05:02+08:00",
  "dateModified": "2023-01-08T11:05:02+08:00",
  "author":{
    "@type": "Person",
    "name": "STARRY-S"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://blog.starry-s.moe/posts/2023/apc-ups/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "STARRY-S' Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://blog.starry-s.moe/favicon.ico"
    }
  }
}
</script>
</head>
<body id="top">
    <header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://blog.starry-s.moe/" accesskey="h" title="Home (Alt + H)">
                <img src="https://blog.starry-s.moe/web-app-manifest-192x192.png" alt="" aria-label="logo"
                    height="24">Home</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://blog.starry-s.moe/gallery/" title="相册">
                    <span>相册</span>
                </a>
            </li>
            <li>
                <a href="https://blog.starry-s.moe/archives/" title="归档">
                    <span>归档</span>
                </a>
            </li>
            <li>
                <a href="https://blog.starry-s.moe/tags/" title="标签">
                    <span>标签</span>
                </a>
            </li>
            <li>
                <a href="https://blog.starry-s.moe/categories/" title="分类">
                    <span>分类</span>
                </a>
            </li>
            <li>
                <a href="https://blog.starry-s.moe/search/" title="搜索 (Alt &#43; /)" accesskey=/>
                    <span>搜索</span>
                </a>
            </li>
            <li>
                <a href="https://blog.starry-s.moe/projects/" title="项目">
                    <span>项目</span>
                </a>
            </li>
            <li>
                <a href="https://blog.starry-s.moe/about/" title="关于">
                    <span>关于</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://blog.starry-s.moe/">主页</a>&nbsp;»&nbsp;<a href="https://blog.starry-s.moe/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      入手一台家用级 APC UPS
    </h1>
    <div class="post-meta"><span title='2023-01-08 11:05:02 +0800 +0800'>2023-01-08 11:05:02 +0800</span>&nbsp;·&nbsp;<span>3 分钟</span>&nbsp;·&nbsp;<span>1399 字</span>&nbsp;·&nbsp;<span>STARRY-S</span>&nbsp;|&nbsp;<span>
    <a href="https://github.com/STARRY-S/blog/edit/main/content/posts/2023/apc-ups/index.md" rel="noopener noreferrer edit" target="_blank">Edit Text</a>
</span>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li><a href="#安装-apcupsd">安装 apcupsd</a></li>
    <li><a href="#配置自动休眠">配置自动休眠</a>
      <ul>
        <li><a href="#配置休眠后关闭-ups-电源">配置休眠后关闭 UPS 电源</a></li>
      </ul>
    </li>
    <li><a href="#其他">其他</a></li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><p>为了让咱的 NAS 长时间稳定运行，斥巨资买了一台 APC BK650M2-CH，在 Arch Wiki 上看 APC 的 UPS 对 Linux 的支持比较友好，于是挑了个最便宜的带停电自动关机的 APC UPS，防止咱啥时候忘了交电费导致停电数据受损。</p>
<blockquote>
<p>参烤链接: <a href="https://wiki.archlinux.org/title/APC_UPS">APC UPS - ArchWiki</a></p>
</blockquote>
<hr>
<p>UPS 到手后花了半个多小时读使用说明书，然后第一件事是把 UPS 的断电报警蜂鸣器关掉，省得我不在公寓的时候停电了 UPS 叫个没完吵到邻居。</p>
<p>之后在装 UPS 之前先把我电脑支架背面一团电线重新整理了一遍，现在是台式机、显示器、NAS、光猫、路由器、无线 AP 都放在一起了，他们的电源线、网线、数据线、显示器线都团在了一起，整理起来炒鸡麻烦。</p>
<p>先把漏油器、光猫和 NAS 的电源都插 UPS 上，然后接好 UPS 的 USB 数据线到 NAS 上。</p>
<h2 id="安装-apcupsd">安装 apcupsd<a hidden class="anchor" aria-hidden="true" href="#安装-apcupsd">#</a></h2>
<p>安装 <code>apcupsd</code>，然后 <code>systemctl enable --now apcupsd.service</code>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> sudo apcaccess status
</span></span><span class="line"><span class="cl"><span class="go">APC      : 001,036,0869
</span></span></span><span class="line"><span class="cl"><span class="go">DATE     : 2023-01-08 11:09:23 +0800
</span></span></span><span class="line"><span class="cl"><span class="go">HOSTNAME : ApertureNAS
</span></span></span><span class="line"><span class="cl"><span class="go">VERSION  : 3.14.14 (31 May 2016) unknown
</span></span></span><span class="line"><span class="cl"><span class="go">UPSNAME  : ApertureNAS
</span></span></span><span class="line"><span class="cl"><span class="go">CABLE    : USB Cable
</span></span></span><span class="line"><span class="cl"><span class="go">DRIVER   : USB UPS Driver
</span></span></span><span class="line"><span class="cl"><span class="go">UPSMODE  : Stand Alone
</span></span></span><span class="line"><span class="cl"><span class="go">STARTTIME: 2023-01-02 23:57:44 +0800
</span></span></span><span class="line"><span class="cl"><span class="go">MODEL    : Back-UPS BK650M2-CH
</span></span></span><span class="line"><span class="cl"><span class="go">STATUS   : ONLINE
</span></span></span><span class="line"><span class="cl"><span class="go">......
</span></span></span></code></pre></div><p>先把 NAS 里所有的应用都停掉，之后编辑 <code>/etc/apcupsd/apcupsd.conf</code>，把 <code>TIMEOUT</code> 改为 <code>1</code>，然后给 UPS 断电，这时 NAS 会自动关机。</p>
<blockquote>
<p>UPS 重新连接电源后，NAS 可能会自动开机，我的 NAS 是这样，但不确定所有 NAS 都这样。</p>
</blockquote>
<h2 id="配置自动休眠">配置自动休眠<a hidden class="anchor" aria-hidden="true" href="#配置自动休眠">#</a></h2>
<p>按照 Wiki 配置停电后自动休眠 (Hibernate / 休眠到硬盘)。</p>
<blockquote>
<p>在此之前，需要创建 swap 分区 (或 swap file)，然后配置休眠需要的内核参数并重构 <code>initramfs</code>。</p>
</blockquote>
<p>以 root 用户创建 <code>/usr/local/bin/hibernate</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="c1"># Hibernate the system - designed to be called via symlink from /etc/apcupsd</span>
</span></span><span class="line"><span class="cl"><span class="c1"># directory in case of apcupsd initiating a shutdown/reboot.  Can also be used</span>
</span></span><span class="line"><span class="cl"><span class="c1"># interactively or from any script to cause a hibernate.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 可以在这里加一些在休眠之前执行的操作，例如让 bot 发个邮件提醒停电了之类的</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Wall message</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 广播消息</span>
</span></span><span class="line"><span class="cl">wall -n System will be hibernate soon
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sleep <span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Do the hibernate</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 执行休眠</span>
</span></span><span class="line"><span class="cl">/usr/bin/systemctl hibernate
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># At this point system should be hibernated - when it comes back, we resume this script here</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 现在，系统应当已经休眠了，当系统恢复运行的时候，脚本会继续从这里执行</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 可以在这里加一些在系统恢复之后的操作，例如让 bot 发个邮件提醒电力恢复了啥的</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># On resume, tell controlling script (/etc/apcupsd/apccontrol) NOT to continue with default action (i.e. shutdown).</span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">99</span>
</span></span></code></pre></div><p>别忘了赋予可执行权限。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">#</span> chmod +x /usr/local/bin/hibernate
</span></span></code></pre></div><p>创建软链接把脚本链接到 <code>/etc/apcupsd</code> 目录下面。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">#</span> ln -s /usr/local/bin/hibernate /etc/apcupsd/doshutdown
</span></span></code></pre></div><p>此时给 UPS 断电后，NAS 会自动休眠，等一两分钟 NAS 会完成休眠，但 UPS 仍处于运行状态没有关机，长时间停电的话，UPS 的电量会耗尽。</p>
<p>UPS 接回电源后，NAS 会从休眠中恢复。</p>
<h3 id="配置休眠后关闭-ups-电源">配置休眠后关闭 UPS 电源<a hidden class="anchor" aria-hidden="true" href="#配置休眠后关闭-ups-电源">#</a></h3>
<p>创建 <code>/usr/lib/systemd/system-sleep/ups-kill</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">case</span> <span class="nv">$2</span> in
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># In the event the computer is hibernating.</span>
</span></span><span class="line"><span class="cl">  hibernate<span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nv">$1</span> in
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">       <span class="c1"># Going into a hibernate state.</span>
</span></span><span class="line"><span class="cl">       pre<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         <span class="c1"># See if this is a powerfail situation.</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="o">[</span> -f /etc/apcupsd/powerfail <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">           <span class="nb">echo</span>
</span></span><span class="line"><span class="cl">           <span class="nb">echo</span> <span class="s2">&#34;ACPUPSD will now power off the UPS&#34;</span>
</span></span><span class="line"><span class="cl">           <span class="nb">echo</span>
</span></span><span class="line"><span class="cl">           /etc/apcupsd/apccontrol killpower
</span></span><span class="line"><span class="cl">           <span class="nb">echo</span>
</span></span><span class="line"><span class="cl">           <span class="nb">echo</span> <span class="s2">&#34;Please ensure that the UPS has powered off before rebooting&#34;</span>
</span></span><span class="line"><span class="cl">           <span class="nb">echo</span> <span class="s2">&#34;Otherwise, the UPS may cut the power during the reboot!!!&#34;</span>
</span></span><span class="line"><span class="cl">           <span class="nb">echo</span>
</span></span><span class="line"><span class="cl">         <span class="k">fi</span>
</span></span><span class="line"><span class="cl">       <span class="p">;;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">       <span class="c1"># Coming out of a hibernate state.</span>
</span></span><span class="line"><span class="cl">       post<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         <span class="c1"># If there are remnants from a powerfail situation, remove them.</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="o">[</span> -f /etc/apcupsd/powerfail <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">           rm /etc/apcupsd/powerfail
</span></span><span class="line"><span class="cl">         <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         <span class="c1"># This may also exist, need to remove it.</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="o">[</span> -f /etc/nologin <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">           rm /etc/nologin
</span></span><span class="line"><span class="cl">         <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	 <span class="c1"># Restart the daemon; otherwise it may be unresponsive in a</span>
</span></span><span class="line"><span class="cl">         <span class="c1"># second powerfailure situation.</span>
</span></span><span class="line"><span class="cl">	 systemctl restart apcupsd
</span></span><span class="line"><span class="cl">       <span class="p">;;</span>
</span></span><span class="line"><span class="cl">    <span class="k">esac</span>
</span></span><span class="line"><span class="cl">  <span class="p">;;</span>
</span></span><span class="line"><span class="cl"><span class="k">esac</span>
</span></span></code></pre></div><p>赋予可执行权限：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">#</span> chmod +x /usr/lib/systemd/system-sleep/ups-kill
</span></span></code></pre></div><p>接下来给 UPS 断电，NAS 会自动休眠，等 NAS 休眠后再过几分钟 UPS 也会关机。</p>
<p>UPS 关机后，给 UPS 接上电源，这时 UPS 会自动开机，然后 NAS 也会从休眠中恢复。</p>
<blockquote>
<p>不要在 UPS 还没关机的时候给 UPS 重新接回电源，会导致 UPS 关机后 NAS 刚从休眠中恢复就被强制断电。</p>
</blockquote>
<h2 id="其他">其他<a hidden class="anchor" aria-hidden="true" href="#其他">#</a></h2>
<p>折腾 UPS 的时候顺手给 NAS 换了个散热器升级了一下内存。AMD 原装散热器有亿点点吵所以换成了咱之前买的 ITX 散热器。</p>
<figure>
    <img loading="lazy" src="images/1.jpg"/> 
</figure>

<p>用咱写的 telebot 查看一下空载时的 CPU 温度才不到 30 度。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">CPU: +28.2°C
</span></span><span class="line"><span class="cl">Uptime: 0.15 Hour
</span></span><span class="line"><span class="cl">TotalRAM: 46.45G
</span></span><span class="line"><span class="cl">FreeRAM: 42.66G
</span></span><span class="line"><span class="cl">AvailableRAM: 43.91G
</span></span><span class="line"><span class="cl">TotalSwap: 46.00G
</span></span><span class="line"><span class="cl">FreeSwap: 46.00G
</span></span></code></pre></div><p>运行一个虚拟机一个 MineCraft 服务器，CPU 温度不到 40，所以很安静。</p>
<p>但是 UPS 它有噪音，晚上睡觉的时候能听见 UPS 它嗡嗡响，比 AMD 散热器的风扇动静还大，这个实在是无解，算了就先这样吧。</p>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://blog.starry-s.moe/tags/%E7%A2%8E%E7%A2%8E%E5%BF%B5/">碎碎念</a></li>
      <li><a href="https://blog.starry-s.moe/tags/%E6%97%A5%E5%B8%B8/">日常</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://blog.starry-s.moe/posts/2023/canon-eos-r7/">
    <span class="title">« 上一页</span>
    <br>
    <span>“关于我逛了一趟漫展然后换了新的相机和镜头这件事”</span>
  </a>
  <a class="next" href="https://blog.starry-s.moe/posts/2023/hello-2023/">
    <span class="title">下一页 »</span>
    <br>
    <span>Hello 2023</span>
  </a>
</nav>

  </footer><div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "starry-s-blog" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</article>
    </main>
    
<footer class="footer">
        <span>© 2016 - 2026 STARRY-S | <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> | Hosted on <a href="https://pages.github.com">GitHub Pages</a><br /></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a><script>
  const pathname = window.location.pathname;
  const images = document.querySelectorAll('img');

  Array.from(images).forEach(image => {
    if (!pathname.includes("/posts/")) {
      return;
    }
    if (image.src.indexOf('images') < 0) {
      return
    }
    image.addEventListener('load', () => fitImage(image));
    if (image.complete && image.naturalWidth !== 0) {
      fitImage(image);
    }
  });

  function fitImage(image) {
    image.style.marginLeft = 'auto';
    image.style.marginRight = 'auto';
    
    if (image.naturalWidth / image.naturalHeight < 1.1) {
      image.style.maxWidth = '60%';
      image.style.height = 'auto';
    }
  }
</script>

<script src="/js/home-info.js"></script>


<script>
    let menu = document.getElementById('menu');
    if (menu) {
        
        const scrollPosition = localStorage.getItem("menu-scroll-position");
        if (scrollPosition) {
            menu.scrollLeft = parseInt(scrollPosition, 10);
        }
        
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        const html = document.querySelector("html");
        if (html.dataset.theme === "dark") {
            html.dataset.theme = 'light';
            localStorage.setItem("pref-theme", 'light');
        } else {
            html.dataset.theme = 'dark';
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
