<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>使用树莓派搭建一个NAS | STARRY-S' Blog</title><meta name=keywords content="树莓派,Arch Linux,Samba,NAS"><meta name=description content="把吃灰了好久的树莓派带了过来，打算搞个NAS玩一下，简短的记录一下整个过程。"><meta name=author content="STARRY-S"><link rel=canonical href=https://blog.starry-s.moe/posts/2021/raspberry_pi_nas/><link crossorigin=anonymous href=/assets/css/stylesheet.6c90a77e0bb06670e5068e51e589ed8b237ada0173c304780a7491b96adcf310.css integrity="sha256-bJCnfguwZnDlBo5R5YntiyN62gFzwwR4CnSRuWrc8xA=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.starry-s.moe/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://blog.starry-s.moe/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.starry-s.moe/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.starry-s.moe/apple-touch-icon.png><link rel=mask-icon href=https://blog.starry-s.moe/apple-touch-icon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://blog.starry-s.moe/posts/2021/raspberry_pi_nas/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/aplayer/dist/APlayer.min.css><script src=https://fastly.jsdelivr.net/npm/aplayer/dist/APlayer.min.js></script><script src=https://fastly.jsdelivr.net/npm/meting/dist/Meting.min.js></script><script>var meting_api="https://api.injahow.cn/meting/?server=:server&type=:type&id=:id&auth=:auth&r=:r"</script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#232323"><meta property="og:url" content="https://blog.starry-s.moe/posts/2021/raspberry_pi_nas/"><meta property="og:site_name" content="STARRY-S' Blog"><meta property="og:title" content="使用树莓派搭建一个NAS"><meta property="og:description" content="把吃灰了好久的树莓派带了过来，打算搞个NAS玩一下，简短的记录一下整个过程。"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-09-25T22:20:03+08:00"><meta property="article:modified_time" content="2021-09-29T01:07:48+08:00"><meta property="article:tag" content="树莓派"><meta property="article:tag" content="Arch Linux"><meta property="article:tag" content="Samba"><meta property="article:tag" content="NAS"><meta property="og:image" content="https://blog.starry-s.moe/avatar.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.starry-s.moe/avatar.png"><meta name=twitter:title content="使用树莓派搭建一个NAS"><meta name=twitter:description content="把吃灰了好久的树莓派带了过来，打算搞个NAS玩一下，简短的记录一下整个过程。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.starry-s.moe/posts/"},{"@type":"ListItem","position":2,"name":"使用树莓派搭建一个NAS","item":"https://blog.starry-s.moe/posts/2021/raspberry_pi_nas/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"使用树莓派搭建一个NAS","name":"使用树莓派搭建一个NAS","description":"把吃灰了好久的树莓派带了过来，打算搞个NAS玩一下，简短的记录一下整个过程。\n","keywords":["树莓派","Arch Linux","Samba","NAS"],"articleBody":"把吃灰了好久的树莓派带了过来，打算搞个NAS玩一下，简短的记录一下整个过程。\n这歌太魔性了哈哈哈哈哈……\n准备工作 树莓派以及所需的电源（废话） 16G以上的高速内存卡用来写系统镜像 硬盘（可以选择买移动硬盘或者直接买硬盘盒和机械硬盘自己组装） 网络设备：路由器、网线 （非必须）键盘、显示器、连接线等 树莓派我使用的是高一时买的树莓派3B（满满的回忆），硬盘是上半年为了存照片而买的西数2T移动硬盘，因为暂时闲置所以拿来一起组个云盘玩。\n内存卡需要质量好的不容易坏而且读写比较快的卡。\n装系统 系统咱安装的是ArchLinux ARM，安装教程直接看官方文档即可。\n一开始咱为了发挥树莓派3B的64位CPU的性能，我下载了64位的系统镜像，但是在配置无线连接的时候（可能是）驱动问题卡死，因为急着睡觉所以重新格式化内存卡后被迫安装32位的系统。\n安装教程咱就不重复写到博客里了，直接翻Wiki，尽管是纯英文的但是不难，都能看懂。咱就不打算在这翻译了。\n在格式化root分区时一开始想尝试一下树莓派上跑btrfs，但是开机时进了linux的救援(rescue)模式，懒得折腾还是老老实实换回了ext4，不然我一晚上不用睡觉了。\n在分区时除了boot和root之外，我额外分了2G的swap分区，树莓派1G内存有些小不过只是搭个人用的NAS的话实际上是不影响使用的。（这话咋读着这么别扭呢）\n因为咱要做NAS肯定得往树莓派上外接个硬盘之类的，树莓派3B只有USB 2.0 + 百兆网口，尽管速度很慢但是作为个人网盘来说不到10MB/S的速度还是比某些恶心网盘快很多的，在线看个1080P视频还是蛮轻松的，BD蓝光想想还是算了。\n把移动硬盘接到树莓派后lsblk查看一下分区表。因为咱这是块几乎全新的硬盘所以需要重新分区并格式化一下。\n如果你不熟悉在命令行上进行分区格式化的话，建议自行翻阅Wiki (fdisk)，因为往博客上写的话太难理解了别人肯定看不懂。\n最后咱把2T移动硬盘格式化成这个样子：\n# fdisk -l /dev/sda Device Start End Sectors Size Type /dev/sda1 2048 2147485695 2147483648 1T Linux filesystem /dev/sda2 2147485696 3907029133 1759543438 839G Microsoft basic data 其中的1T打算格式化为btrfs给Samba用，其余的800G打算格式化为NTFS留着给Windows当个移动硬盘。\n创建分区时别忘了更改分区类型，给Linux用的就是Linux filesystem，给Windows用的就是Microsoft basic data， 不然机械硬盘连接到Windows系统中将不显示分区，或者就是一直提醒你：该分区不可用，然后让你格式化，到时候一不小心点错了可是会丢数据的。\n安装btrfs-progs和ntfs-3g，之后格式化硬盘（NTFS还是建议到Windows系统中格式化）。\n格式化btrfs的时候加个-L参数设置分区的标签，这样方便在fstab中设置开机自动挂载。\n$ lsblk # 一定要看清楚自己格式化的分区名字 $ sudo mkfs.btrfs /dev/sdaX -L samba # -L 参数设置分区的标签 最后改一下/etc/fstab让设备在开机时自动挂载交换分区和移动硬盘。\n# /dev/mmcblk0p1 /boot vfat defaults 0 0 LABEL=swap none swap defaults 0 0 LABEL=samba /samba btrfs defaults 0 0 重启系统后如果正常的话，分区会被自动挂载。\n配置网络 配置网络部分不适合在SSH中操作，建议使用显示器和键盘连接到树莓派上操作。\n除非你能保证你执行的每个命令都肥肠正确。\n无线网络 因为我电脑离路由器肥肠远，所以为了方便我还要给树莓派配置无线网络。首先照着Wiki上的netctl页面安装了wifi-menu所需要用的dialog，然后就用wifi-menu连接wifi了。不过为了方便以后连接，我需要给他设置静态IP：\n首先使用你比较喜欢的文本编辑器打开wifi-menu自动生成的配置文件，并修改成以下的样子\n# /etc/netctl.d/wlan0-YourWifiName Description='Automatically generated profile by wifi-menu' Interface=wlan0 Connection=wireless Security=wpa ESSID=Your Wifi Name IP=static Address=('192.168.xxx.xxx/24') Gateway='192.168.xxx.1' DNS='8.8.8.8' Key=YOUR WIFI PASSWORD 其中修改Address为你想设置的CIDR地址、Gateway为默认网关、以及DNS。\n最后修改Key为Wifi密码（明文），如果需要加密的话可以去wiki上找相应方法。\n之后sudo netctl enable wlan0-YourWifiName设置好开机自动连接即可。\n这时候聪明的小伙伴会想到：我想使用网线联网并配置静态IP，该怎么办呢？\n配置有线网络 默认情况下，有线接口eth0使用systemd-network配置了DHCP，所以我们不需要改netctl的配置文件，只编辑/etc/systemd/network/eth0.network这个配置文件改成静态IP地址就好了。\n[Match] Name=eth0 [Network] Address=192.168.xxx.xxx/24 Gateway=192.168.xxx.1 DNS=8.8.8.8 重启系统后，使用ip addr检查设备的IP地址是否正确。\n配置防火墙 首先安装ufw。（因为对iptables不是十分熟悉，ufw比ip桌子好用一些，毕竟他叫Uncomplicated Filewall，所以咱先用ufw配置防火墙）\n食用方法请参见Wiki页面。\n因为咱打算搭一个Samba服务器，所以别忘了配置防火墙允许Samba的端口，按照Arch Linux Wiki：\n# Create or Edit /etc/ufw/applications.d/samba, add following content: [Samba] title=LanManager-like file and printer server for Unix description=Samba ports=137,138/udp|139,445/tcp 之后root账户执行ufw app update Samba加载配置文件，然后ufw allow Samba允许Samba的端口。\n如果你的树莓派上还装有其他服务（比如http，https等），别忘了ufw allow PORT开放端口，尤其是别忘了开SSH端口。\n最后ufw status查看防火墙状态信息，ufw enable开启防火墙。\nSamba 配合Arch Wiki食用。\n首先我们需要新建一个分组，然后在挂载的分区中新建一个文件夹作为Samba服务器的共享目录：\n$ sudo groupadd -r sambausers # 新建用户组 $ sudo usermod -aG sambausers username # 添加当前用户至分组中 $ sudo smbpasswd -a sambausers # 设置Samba用户的密码 $ sudo mkdir /samba/sharefolder # 新建文件夹用来存储共享的文件 $ sudo chown :username /samba/sharefolder # 修改文件夹的所属分组 $ sudo chmod 0770 /samba/sharefolder # 修改权限 （咱写的很详细了吧\n配置服务器 安装好samba安装包后，需要手动去/etc/samba/创建smb.conf配置文件，可以到Samba git repository中获取样例配置文件，咱只需要把它复制粘贴再简单修改一下就好了。\n# /etc/samba/smb.conf [global] # 修改工作组的名字 workgroup = MYGROUP # 服务器描述 server string = Raspberry pi Samba Server # 在文件末尾添加共享文件夹目录及相关配置 [sambashare] comment = Sample share file. path = /path/to/your/samba/folder writable = yes browsable = yes create mask = 0755 directory mask = 0755 read only = no guest ok = no # 允许访客随意登录 配置好文件后，启动smb.service和nmb.service\n$ sudo systemctl enable --now smb.service $ sudo systemctl enable --now nmb.service 访问服务器 咱GNOME用户直接打开文件管理器，选择左边的“+ Other Locations”，在底部输入服务器连接smb://192.168.xxx.xxx， 输入用户组、用户名和密码登录就可以访问共享文件夹。\nWindows系统中，首先需要到 控制面板-\u003e程序-\u003e启用或关闭Windows功能 里面，选中 SMB1.0/CIFS文件共享直通，保存后等一会安装完， 打开文件资源管理器输入地址\\\\192.168.xxx.xxx\\，登录后就能访问共享文件夹了。\nFrp内网穿透 配合frp文档食用更佳\n首先在frp的GitHub Release页面下载安装包。\n如果是树莓派用的话就下载arm版本的安装包即可。Arch Linux可以在ArchLinux CN源或AUR中安装frpc和frps作为客户端和服务端。\n# 树莓派上下载编译好的文件 $ wget https://github.com/fatedier/frp/releases/download/v0.37.1/frp_0.37.1_linux_arm.tar.gz # 解压 $ tar -zxvf ./frp_0.37.1_linux_arm.tar.gz $ cd frp_0.37.1_linux_arm/ # 编辑配置文件 $ vim ./frpc.ini $ ./frpc -c ./frpc.ini 客户端配置文件的格式可参考如下：\n[common] server_addr = server ip server_port = 6000 [samba] type = tcp local_ip = 127.0.0.1 local_port = 445 remote_port = 6003 其中端口号和token按需要自行更改，Samba服务的tcp端口号为445。\n服务端配置文件格式如下：\n[common] bind_port = 6000 为了安全，别忘了配置权限验证，同时别忘了修改服务器的防火墙设置。\nOthers 所以到此为止，咱的Samba服务器就搭建好了。\n随便传了个大文件试了一下，内网上传速度在6MB/S左右，有些慢但是还没搞清楚到底是什么原因导致的。\n","wordCount":"3101","inLanguage":"zh","image":"https://blog.starry-s.moe/avatar.png","datePublished":"2021-09-25T22:20:03+08:00","dateModified":"2021-09-29T01:07:48+08:00","author":{"@type":"Person","name":"STARRY-S"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.starry-s.moe/posts/2021/raspberry_pi_nas/"},"publisher":{"@type":"Organization","name":"STARRY-S' Blog","logo":{"@type":"ImageObject","url":"https://blog.starry-s.moe/favicon-32x32.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.starry-s.moe/ accesskey=h title="Blog (Alt + H)"><img src=https://blog.starry-s.moe/apple-touch-icon.png alt aria-label=logo height=24>Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.starry-s.moe/gallery/ title=相册><span>相册</span></a></li><li><a href=https://blog.starry-s.moe/archives/ title=归档><span>归档</span></a></li><li><a href=https://blog.starry-s.moe/tags/ title=标签><span>标签</span></a></li><li><a href=https://blog.starry-s.moe/categories/ title=分类><span>分类</span></a></li><li><a href=https://blog.starry-s.moe/search/ title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li><li><a href=https://blog.starry-s.moe/projects/ title=项目><span>项目</span></a></li><li><a href=https://blog.starry-s.moe/about/ title=关于><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.starry-s.moe/>主页</a>&nbsp;»&nbsp;<a href=https://blog.starry-s.moe/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">使用树莓派搭建一个NAS</h1><div class=post-meta><span title='2021-09-25 22:20:03 +0800 +0800'>2021-09-25 22:20:03 +0800</span>&nbsp;·&nbsp;7 分钟&nbsp;·&nbsp;3101 字&nbsp;·&nbsp;STARRY-S&nbsp;|&nbsp;<a href=https://github.com/STARRY-S/blog/edit/main/content/posts/2021/raspberry_pi_nas/index.md rel="noopener noreferrer edit" target=_blank>Edit Text</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#准备工作>准备工作</a></li><li><a href=#装系统>装系统</a></li><li><a href=#配置网络>配置网络</a><ul><li><a href=#无线网络>无线网络</a></li><li><a href=#配置有线网络>配置有线网络</a></li><li><a href=#配置防火墙>配置防火墙</a></li></ul></li><li><a href=#samba>Samba</a><ul><li><a href=#配置服务器>配置服务器</a></li><li><a href=#访问服务器>访问服务器</a></li></ul></li><li><a href=#frp内网穿透>Frp内网穿透</a></li><li><a href=#others>Others</a></li></ul></nav></div></details></div><div class=post-content><p>把吃灰了好久的树莓派带了过来，打算搞个NAS玩一下，简短的记录一下整个过程。</p><meting-js server=netease type=song id=750905 theme=#233333></meting-js><blockquote><p>这歌太魔性了哈哈哈哈哈……</p></blockquote><h2 id=准备工作>准备工作<a hidden class=anchor aria-hidden=true href=#准备工作>#</a></h2><ul><li>树莓派以及所需的电源（废话）</li><li>16G以上的高速内存卡用来写系统镜像</li><li>硬盘（可以选择买移动硬盘或者直接买硬盘盒和机械硬盘自己组装）</li><li>网络设备：路由器、网线</li><li>（非必须）键盘、显示器、连接线等</li></ul><p>树莓派我使用的是高一时买的树莓派3B（满满的回忆），硬盘是上半年为了存照片而买的西数2T移动硬盘，因为暂时闲置所以拿来一起组个云盘玩。</p><p>内存卡需要质量好的不容易坏而且读写比较快的卡。</p><h2 id=装系统>装系统<a hidden class=anchor aria-hidden=true href=#装系统>#</a></h2><p>系统咱安装的是<a href=https://archlinuxarm.org/platforms/armv8/broadcom/raspberry-pi-3>ArchLinux ARM</a>，安装教程直接看官方文档即可。</p><p>一开始咱为了发挥树莓派3B的64位CPU的性能，我下载了64位的系统镜像，但是在配置无线连接的时候（可能是）驱动问题卡死，因为急着睡觉所以重新格式化内存卡后被迫安装32位的系统。</p><p>安装教程咱就不重复写到博客里了，直接翻Wiki，尽管是纯英文的但是不难，都能看懂。咱就不打算在这翻译了。</p><p>在格式化<code>root</code>分区时一开始想尝试一下树莓派上跑<code>btrfs</code>，但是开机时进了linux的救援(rescue)模式，懒得折腾还是老老实实换回了<code>ext4</code>，<del>不然我一晚上不用睡觉了</del>。</p><p>在分区时除了<code>boot</code>和<code>root</code>之外，我额外分了2G的<code>swap</code>分区，树莓派1G内存有些小不过只是搭个人用的NAS的话实际上是不影响使用的。（<del>这话咋读着这么别扭呢</del>）</p><p>因为咱要做NAS肯定得往树莓派上外接个硬盘之类的，树莓派3B只有USB 2.0 + 百兆网口，尽管速度很慢但是作为个人网盘来说不到10MB/S的速度还是比某些恶心网盘快很多的，在线看个1080P视频还是蛮轻松的，BD蓝光想想还是算了。</p><p>把移动硬盘接到树莓派后<code>lsblk</code>查看一下分区表。因为咱这是块几乎全新的硬盘所以需要重新分区并格式化一下。</p><p>如果你不熟悉在命令行上进行分区格式化的话，建议自行翻阅<a href=https://wiki.archlinux.org/title/fdisk>Wiki (fdisk)</a>，因为往博客上写的话太难理解了别人肯定看不懂。</p><p>最后咱把2T移动硬盘格式化成这个样子：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl># fdisk -l /dev/sda
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Device          Start        End    Sectors  Size Type
</span></span><span class=line><span class=cl>/dev/sda1        2048 2147485695 2147483648    1T Linux filesystem
</span></span><span class=line><span class=cl>/dev/sda2  2147485696 3907029133 1759543438  839G Microsoft basic data
</span></span></code></pre></div><p>其中的1T打算格式化为<code>btrfs</code>给Samba用，其余的800G打算格式化为<code>NTFS</code>留着给Windows当个移动硬盘。</p><p>创建分区时别忘了更改分区类型，给Linux用的就是<code>Linux filesystem</code>，给Windows用的就是<code>Microsoft basic data</code>，
不然机械硬盘连接到Windows系统中将不显示分区，或者就是一直提醒你：该分区不可用，然后让你格式化，到时候一不小心点错了可是会丢数据的。</p><p>安装<code>btrfs-progs</code>和<code>ntfs-3g</code>，之后格式化硬盘（NTFS还是建议到Windows系统中格式化）。</p><p>格式化btrfs的时候加个<code>-L</code>参数设置分区的标签，这样方便在fstab中设置开机自动挂载。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>$ lsblk                                # 一定要看清楚自己格式化的分区名字
</span></span><span class=line><span class=cl>$ sudo mkfs.btrfs /dev/sdaX -L samba   # -L 参数设置分区的标签
</span></span></code></pre></div><p>最后改一下<code>/etc/fstab</code>让设备在开机时自动挂载交换分区和移动硬盘。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># &lt;file system&gt; &lt;dir&gt; &lt;type&gt; &lt;options&gt; &lt;dump&gt; &lt;pass&gt;
</span></span><span class=line><span class=cl>/dev/mmcblk0p1  /boot   vfat    defaults        0       0
</span></span><span class=line><span class=cl>LABEL=swap      none    swap    defaults        0       0
</span></span><span class=line><span class=cl>LABEL=samba     /samba  btrfs   defaults        0       0
</span></span></code></pre></div><p>重启系统后如果正常的话，分区会被自动挂载。</p><h2 id=配置网络>配置网络<a hidden class=anchor aria-hidden=true href=#配置网络>#</a></h2><blockquote><p>配置网络部分不适合在SSH中操作，建议使用显示器和键盘连接到树莓派上操作。</p><p>除非你能保证你执行的每个命令都肥肠正确。</p></blockquote><h3 id=无线网络>无线网络<a hidden class=anchor aria-hidden=true href=#无线网络>#</a></h3><p>因为我电脑离路由器肥肠远，所以为了方便我还要给树莓派配置无线网络。首先照着<a href=https://wiki.archlinux.org/title/Netctl>Wiki上的netctl页面</a>安装了<code>wifi-menu</code>所需要用的<code>dialog</code>，然后就用<code>wifi-menu</code>连接wifi了。不过为了方便以后连接，我需要给他设置静态IP：</p><p>首先使用你比较喜欢的文本编辑器打开<code>wifi-menu</code>自动生成的配置文件，并修改成以下的样子</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># /etc/netctl.d/wlan0-YourWifiName
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Description=&#39;Automatically generated profile by wifi-menu&#39;
</span></span><span class=line><span class=cl>Interface=wlan0
</span></span><span class=line><span class=cl>Connection=wireless
</span></span><span class=line><span class=cl>Security=wpa
</span></span><span class=line><span class=cl>ESSID=Your Wifi Name
</span></span><span class=line><span class=cl>IP=static
</span></span><span class=line><span class=cl>Address=(&#39;192.168.xxx.xxx/24&#39;)
</span></span><span class=line><span class=cl>Gateway=&#39;192.168.xxx.1&#39;
</span></span><span class=line><span class=cl>DNS=&#39;8.8.8.8&#39;
</span></span><span class=line><span class=cl>Key=YOUR WIFI PASSWORD
</span></span></code></pre></div><p>其中修改<code>Address</code>为你想设置的CIDR地址、<code>Gateway</code>为默认网关、以及<code>DNS</code>。</p><p>最后修改<code>Key</code>为Wifi密码（明文），如果需要加密的话可以去wiki上找相应方法。</p><p>之后<code>sudo netctl enable wlan0-YourWifiName</code>设置好开机自动连接即可。</p><p>这时候聪明的小伙伴会想到：我想使用网线联网并配置静态IP，该怎么办呢？</p><h3 id=配置有线网络>配置有线网络<a hidden class=anchor aria-hidden=true href=#配置有线网络>#</a></h3><p>默认情况下，有线接口<code>eth0</code>使用<code>systemd-network</code>配置了<code>DHCP</code>，所以我们不需要改<code>netctl</code>的配置文件，只编辑<code>/etc/systemd/network/eth0.network</code>这个配置文件改成静态IP地址就好了。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[Match]
</span></span><span class=line><span class=cl>Name=eth0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[Network]
</span></span><span class=line><span class=cl>Address=192.168.xxx.xxx/24
</span></span><span class=line><span class=cl>Gateway=192.168.xxx.1
</span></span><span class=line><span class=cl>DNS=8.8.8.8
</span></span></code></pre></div><p>重启系统后，使用<code>ip addr</code>检查设备的IP地址是否正确。</p><h3 id=配置防火墙>配置防火墙<a hidden class=anchor aria-hidden=true href=#配置防火墙>#</a></h3><p>首先安装<code>ufw</code>。（因为对iptables不是十分熟悉，ufw比ip桌子好用一些，毕竟他叫<strong>Uncomplicated Filewall</strong>，所以咱先用ufw配置防火墙）</p><p>食用方法请参见<a href=https://wiki.archlinux.org/title/Uncomplicated_Firewall>Wiki页面</a>。</p><p>因为咱打算搭一个Samba服务器，所以别忘了配置防火墙允许Samba的端口，按照Arch Linux Wiki：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># Create or Edit /etc/ufw/applications.d/samba, add following content:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[Samba]
</span></span><span class=line><span class=cl>title=LanManager-like file and printer server for Unix
</span></span><span class=line><span class=cl>description=Samba
</span></span><span class=line><span class=cl>ports=137,138/udp|139,445/tcp
</span></span></code></pre></div><p>之后root账户执行<code>ufw app update Samba</code>加载配置文件，然后<code>ufw allow Samba</code>允许Samba的端口。</p><p>如果你的树莓派上还装有其他服务（比如http，https等），别忘了<code>ufw allow PORT</code>开放端口，尤其是别忘了开SSH端口。</p><p>最后<code>ufw status</code>查看防火墙状态信息，<code>ufw enable</code>开启防火墙。</p><h2 id=samba>Samba<a hidden class=anchor aria-hidden=true href=#samba>#</a></h2><p>配合<a href=https://wiki.archlinux.org/title/Samba>Arch Wiki</a>食用。</p><p>首先我们需要新建一个分组，然后在挂载的分区中新建一个文件夹作为Samba服务器的共享目录：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ sudo groupadd -r sambausers          # 新建用户组
</span></span><span class=line><span class=cl>$ sudo usermod -aG sambausers username # 添加当前用户至分组中
</span></span><span class=line><span class=cl>$ sudo smbpasswd -a sambausers         # 设置Samba用户的密码
</span></span><span class=line><span class=cl>$ sudo mkdir /samba/sharefolder        # 新建文件夹用来存储共享的文件
</span></span><span class=line><span class=cl>$ sudo chown :username /samba/sharefolder   # 修改文件夹的所属分组
</span></span><span class=line><span class=cl>$ sudo chmod 0770 /samba/sharefolder   # 修改权限
</span></span></code></pre></div><p>（咱写的很详细了吧</p><h3 id=配置服务器>配置服务器<a hidden class=anchor aria-hidden=true href=#配置服务器>#</a></h3><p>安装好<code>samba</code>安装包后，需要手动去<code>/etc/samba/</code>创建<code>smb.conf</code>配置文件，可以到<a href="https://git.samba.org/samba.git/?p=samba.git;a=blob_plain;f=examples/smb.conf.default;hb=HEAD">Samba git repository</a>中获取样例配置文件，咱只需要把它复制粘贴再简单修改一下就好了。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># /etc/samba/smb.conf
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[global]
</span></span><span class=line><span class=cl># 修改工作组的名字
</span></span><span class=line><span class=cl>workgroup = MYGROUP
</span></span><span class=line><span class=cl># 服务器描述
</span></span><span class=line><span class=cl>server string = Raspberry pi Samba Server
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># 在文件末尾添加共享文件夹目录及相关配置
</span></span><span class=line><span class=cl>[sambashare]
</span></span><span class=line><span class=cl>comment = Sample share file.
</span></span><span class=line><span class=cl>path = /path/to/your/samba/folder
</span></span><span class=line><span class=cl>writable = yes
</span></span><span class=line><span class=cl>browsable = yes
</span></span><span class=line><span class=cl>create mask = 0755
</span></span><span class=line><span class=cl>directory mask = 0755
</span></span><span class=line><span class=cl>read only = no
</span></span><span class=line><span class=cl>guest ok = no  # 允许访客随意登录
</span></span></code></pre></div><p>配置好文件后，启动<code>smb.service</code>和<code>nmb.service</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo systemctl <span class=nb>enable</span> --now smb.service
</span></span><span class=line><span class=cl>$ sudo systemctl <span class=nb>enable</span> --now nmb.service
</span></span></code></pre></div><h3 id=访问服务器>访问服务器<a hidden class=anchor aria-hidden=true href=#访问服务器>#</a></h3><p>咱GNOME用户直接打开文件管理器，选择左边的“+ Other Locations”，在底部输入服务器连接<code>smb://192.168.xxx.xxx</code>，
输入用户组、用户名和密码登录就可以访问共享文件夹。</p><p>Windows系统中，首先需要到 控制面板->程序->启用或关闭Windows功能 里面，选中 SMB1.0/CIFS文件共享直通，保存后等一会安装完，
打开文件资源管理器输入地址<code>\\192.168.xxx.xxx\</code>，登录后就能访问共享文件夹了。</p><h2 id=frp内网穿透>Frp内网穿透<a hidden class=anchor aria-hidden=true href=#frp内网穿透>#</a></h2><blockquote><p>配合<a href=https://gofrp.org/docs/>frp文档</a>食用更佳</p></blockquote><p>首先在frp的<a href=https://github.com/fatedier/frp/releases>GitHub Release</a>页面下载安装包。</p><p>如果是树莓派用的话就下载<code>arm</code>版本的安装包即可。Arch Linux可以在ArchLinux CN源或AUR中安装<code>frpc</code>和<code>frps</code>作为客户端和服务端。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># 树莓派上下载编译好的文件</span>
</span></span><span class=line><span class=cl>$ wget https://github.com/fatedier/frp/releases/download/v0.37.1/frp_0.37.1_linux_arm.tar.gz
</span></span><span class=line><span class=cl><span class=c1># 解压</span>
</span></span><span class=line><span class=cl>$ tar -zxvf ./frp_0.37.1_linux_arm.tar.gz
</span></span><span class=line><span class=cl>$ <span class=nb>cd</span> frp_0.37.1_linux_arm/
</span></span><span class=line><span class=cl><span class=c1># 编辑配置文件</span>
</span></span><span class=line><span class=cl>$ vim ./frpc.ini
</span></span><span class=line><span class=cl>$ ./frpc -c ./frpc.ini
</span></span></code></pre></div><p>客户端配置文件的格式可参考如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[common]
</span></span><span class=line><span class=cl>server_addr = server ip
</span></span><span class=line><span class=cl>server_port = 6000
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[samba]
</span></span><span class=line><span class=cl>type = tcp
</span></span><span class=line><span class=cl>local_ip = 127.0.0.1
</span></span><span class=line><span class=cl>local_port = 445
</span></span><span class=line><span class=cl>remote_port = 6003
</span></span></code></pre></div><p>其中端口号和<code>token</code>按需要自行更改，Samba服务的<code>tcp</code>端口号为<code>445</code>。</p><p>服务端配置文件格式如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[common]
</span></span><span class=line><span class=cl>bind_port = 6000
</span></span></code></pre></div><p>为了安全，别忘了配置<a href=https://gofrp.org/docs/reference/server-configures/#%E6%9D%83%E9%99%90%E9%AA%8C%E8%AF%81>权限验证</a>，同时别忘了修改服务器的防火墙设置。</p><h2 id=others>Others<a hidden class=anchor aria-hidden=true href=#others>#</a></h2><p>所以到此为止，咱的Samba服务器就搭建好了。</p><p>随便传了个大文件试了一下，内网上传速度在6MB/S左右，有些慢但是还没搞清楚到底是什么原因导致的。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.starry-s.moe/tags/%E6%A0%91%E8%8E%93%E6%B4%BE/>树莓派</a></li><li><a href=https://blog.starry-s.moe/tags/arch-linux/>Arch Linux</a></li><li><a href=https://blog.starry-s.moe/tags/samba/>Samba</a></li><li><a href=https://blog.starry-s.moe/tags/nas/>NAS</a></li></ul><nav class=paginav><a class=prev href=https://blog.starry-s.moe/posts/2022/hello-2022/><span class=title>« 上一页</span><br><span>Hello 2022</span>
</a><a class=next href=https://blog.starry-s.moe/posts/2021/build-desktop/><span class=title>下一页 »</span><br><span>我们来组装一台电脑吧</span></a></nav></footer><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//starry-s-blog.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>© 2016 - 2025 STARRY-S | <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a> | Hosted on <a href=https://pages.github.com>GitHub Pages</a><br></span>·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>const pathname=window.location.pathname,images=document.querySelectorAll("img");Array.from(images).forEach(e=>{if(!pathname.includes("/posts/"))return;if(e.src.indexOf("images")<0)return;e.addEventListener("load",()=>fitImage(e)),e.complete&&e.naturalWidth!==0&&fitImage(e)});function fitImage(e){e.style.marginLeft="auto",e.style.marginRight="auto",e.naturalWidth/e.naturalHeight<1.1&&(e.style.maxWidth="60%",e.style.height="auto")}</script><script src=/js/home-info.js></script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>