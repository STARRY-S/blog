<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>一些 Arch Linux 的常用组件整理 | STARRY-S' Blog</title>
<meta name=keywords content="Arch Linux"><meta name=description content="用这么久 Arch 了，但是却很少写 Arch 相关的博客……
最近常需要在虚拟机上装 Arch，所以把常用工具及配置整理在这儿，省得每次 pacstrap 时都要想半天咱需要装什么……"><meta name=author content="STARRY-S"><link rel=canonical href=https://blog.starry-s.moe/posts/2024/archlinux-utils/><link crossorigin=anonymous href=/assets/css/stylesheet.b00f06743954711b22a4a15ad0b966b18e6a0f7e39cea412e471d345bc6b85ca.css integrity="sha256-sA8GdDlUcRsipKFa0LlmsY5qD345zqQS5HHTRbxrhco=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.starry-s.moe/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://blog.starry-s.moe/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.starry-s.moe/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.starry-s.moe/apple-touch-icon.png><link rel=mask-icon href=https://blog.starry-s.moe/apple-touch-icon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://blog.starry-s.moe/posts/2024/archlinux-utils/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/aplayer/dist/APlayer.min.css><script src=https://fastly.jsdelivr.net/npm/aplayer/dist/APlayer.min.js></script><script src=https://fastly.jsdelivr.net/npm/meting/dist/Meting.min.js></script><script>var meting_api="https://api.injahow.cn/meting/?server=:server&type=:type&id=:id&auth=:auth&r=:r"</script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#232323"><meta property="og:url" content="https://blog.starry-s.moe/posts/2024/archlinux-utils/"><meta property="og:site_name" content="STARRY-S' Blog"><meta property="og:title" content="一些 Arch Linux 的常用组件整理"><meta property="og:description" content="用这么久 Arch 了，但是却很少写 Arch 相关的博客……
最近常需要在虚拟机上装 Arch，所以把常用工具及配置整理在这儿，省得每次 pacstrap 时都要想半天咱需要装什么……"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-30T18:44:07+08:00"><meta property="article:modified_time" content="2024-01-30T18:44:07+08:00"><meta property="article:tag" content="Arch Linux"><meta property="og:image" content="https://blog.starry-s.moe/avatar.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.starry-s.moe/avatar.png"><meta name=twitter:title content="一些 Arch Linux 的常用组件整理"><meta name=twitter:description content="用这么久 Arch 了，但是却很少写 Arch 相关的博客……
最近常需要在虚拟机上装 Arch，所以把常用工具及配置整理在这儿，省得每次 pacstrap 时都要想半天咱需要装什么……"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.starry-s.moe/posts/"},{"@type":"ListItem","position":2,"name":"一些 Arch Linux 的常用组件整理","item":"https://blog.starry-s.moe/posts/2024/archlinux-utils/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"一些 Arch Linux 的常用组件整理","name":"一些 Arch Linux 的常用组件整理","description":"用这么久 Arch 了，但是却很少写 Arch 相关的博客……\n最近常需要在虚拟机上装 Arch，所以把常用工具及配置整理在这儿，省得每次 pacstrap 时都要想半天咱需要装什么……\n","keywords":["Arch Linux"],"articleBody":"用这么久 Arch 了，但是却很少写 Arch 相关的博客……\n最近常需要在虚拟机上装 Arch，所以把常用工具及配置整理在这儿，省得每次 pacstrap 时都要想半天咱需要装什么……\n装系统 Arch Wiki 的 Installation Guide 在使用 pacstrap 装系统时只写了最基础的软件包 base, linux 和 linux-firmware，可以在这一步补充亿些常用的软件。\npacstrap -K /mnt base linux linux-firmware \\ base-devel gcc grub amd-ucode intel-ucode \\ zsh zsh-syntax-highlighting zsh-autosuggestions \\ vim neovim git openbsd-netcat \\ sudo man-db htop wget \\ neofetch 进 chroot 后编辑 /etc/pacman.conf，添加以下配置，启用 Arch Linux CN。\n# /etc/pacman.conf [archlinuxcn] # Server = https://repo.archlinuxcn.org/$arch Server = https://mirrors.bfsu.edu.cn/archlinuxcn/$arch 之后安装 yay:\nsudo pacman -Syy \u0026\u0026 sudo pacman -S archlinuxcn-keyring sudo pacman -S yay 如果电脑上安装了其他系统的话，需要额外安装 os-prober，让 GRUB 在生成配置文件时搜索安装了其他系统的磁盘。\nsudo pacman -S os-prober 如果是为 QEMU KVM 虚拟机装系统的话，在执行 grub-install 配置 UEFI 启动引导时记得加一个 --removable 参数。\nsudo pacman -S efibootmgr sudo grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=GRUB --removable sudo grub-mkconfig -o /boot/grub/grub.cfg 如果不装其他网络工具，只使用 systemd-networkd 的话，需要创建一份默认的配置文件使用 DHCP，否则连不上网。\n# /etc/systemd/network/10-default.network [Match] Name=enp* [Network] DHCP=yes 如果需要配置静态网络地址：\n（这里只配置了静态 IPv4，如需要禁用 IPv6 的 DHCP，请参照下方桥接网络）\n# /etc/systemd/network/10-static.network [Match] Name=eth0 [Network] Address=10.128.0.100/16 Gateway=10.128.0.1 DNS=10.128.0.1 并启用 systemd-networkd Systemd Service：\nsudo systemctl enable systemd-networkd 基本上到这里就可以愉快的 reboot 了，一个精简的系统所需要的软件就基本装好了。\n桥接网络 如果需要使用虚拟机的桥接网络，需要在物理网卡的基础上配置一个桥接网卡，然后为这个桥接网卡配置网络。\n先创建一个 br0 网卡设备。\n# /etc/systemd/network/25-br0.netdev [NetDev] Name=br0 Kind=bridge 将 br0 绑定到某个物理网卡设备。\n# /etc/systemd/network/25-br0-en.network [Match] Name=en* [Network] Bridge=br0 为 br0 桥接网卡配置静态 IP 地址，这里禁用了 IPv4 和 IPv6 的 DHCP。\n# /etc/systemd/network/25-br0.network [Match] Name=br0 [Network] DHCP=no DNS=10.128.0.1 IPv6AcceptRA=false [Address] Address=10.128.0.100/16 # IPv6 static address # [Address] # Address=fd00:cafe:abcd::1001/64 [Route] Gateway=10.128.0.1 GatewayOnLink=yes 常用命令行工具 如果只作为服务器 / 不包含图形的虚拟机使用的话，装这些咱常用软件，这部分因人而异，仅供参考。\nsudo pacman -S go \\ kubectl helm \\ docker docker-buildx \\ podman \\ privoxy \\ proxychains \\ wireguard-tools \\ axel aria2 \\ ffmpeg \\ jq go-yq \\ jdk8-openjdk \\ lm_sensors \\ net-tools traceroute \\ openssh \\ nodejs npm \\ python3 python-pip \\ btrfs-progs \\ bind \\ ethtool \\ bc \\ age # golangci-lint yay -S golangci-lint-bin \\ krew-bin # 装完 Docker 后把普通用户添加到 docker group 中 sudo usermod -aG docker $USER 创建 Docker Daemon 的配置文件 /etc/docker/daemon.json，设定国内的 Mirror，这里用的是咱自己搭的反向代理：\n{ \"insecure-registries\" : [ \"127.0.0.1:5000\" ], \"registry-mirrors\": [ \"https://docker.hxstarrys.me/\" ] } 除了 Docker，还建议使用 Podman 运行一些容器，使用方式和 Docker 没什么大区别，以免去 Daemon 依赖并支持 Systemd。\n如果需要跑虚拟机，需要装 QEMU 和 libvirt 相关的组件（咱用 virsh 管理虚拟机，不手搓 qemu 指令）：\nsudo pacman -S qemu-full libvirt K3s / RKE2 Server 在 Arch Linux 上安装了 K3s 或 RKE2，关机时会卡在 a stop is running for libcontainer containerd... 一分多钟……\n参考 这个 Issue，创建一个 /etc/systemd/system/shutdown-k3s.service Systemd 文件。\n(如果用的是 RKE2，把文件的 k3s 替换为 rke2)\n[Unit] Description=Kill containerd-shims on shutdown DefaultDependencies=false Before=shutdown.target umount.target [Service] ExecStart=/usr/local/bin/k3s-killall.sh Type=oneshot [Install] WantedBy=shutdown.target 之后启用 shutdown-k3s.service，在关机时 Kill 掉 K3s。\nsudo systemctl daemon-reload sudo systemctl enable shutdown-k3s.service WireGuard Client 如果 Arch Linux 还配置了 WireGuard 客户端，而这台 Arch Linux Server 被放在了家里，只能通过有公网 IP 的 WireGuard 服务器连接进去，这时尽管设置了 WireGuard 的 persistent keepalive，但在运营商更换了你家的公网 IP 后，还是会碰到无法自动连接回去的情况，这时可以用咱的 这个简单粗暴的脚本，在 WireGuard 断连一段时间后，自动重启接口。\n图形界面 显卡驱动：\n# AMD sudo pacman -S xf86-video-amdgpu # NVIDIA # (咱并不喜欢 DKMS 因为每次更新内核都得编译一遍 Kernel Module，所以这里使用的和 Linux 内核一同更新的 NVIDIA Open Driver) sudo pacman -S nvidia-open nvidia-utils nvidia-container-toolkit X11/Wayland 这些相关组件会随着桌面环境一起安装，所以只需要装桌面环境即可，这里就不需要你额外装 X 了。\nWayland on NVIDIA 在 NVIDIA 显卡上运行 Wayland 需要一些额外操作。\n增加 nvidia_drm.modeset=1 内核参数（记得重新生成 grub.cfg）\n# /etc/default/grub GRUB_CMDLINE_LINUX=\"nvidia_drm.modeset=1\" 禁用 nouveau。\n$ echo \"blacklist nouveau\" \u003e\u003e /etc/modprobe.d/blacklist.conf KMS Early Load。\n# /etc/mkinitcpio.conf MODULES=(nvidia nvidia_modeset nvidia_uvm nvidia_drm) # 然后移除 HOOKS 那一行里的 kms 以完全禁用 nouveau 记得重新 mkinitcpio -P。\nGNOME 如果使用 GNOME Desktop（咱默认使用这个桌面），需要安装这些组件\nsudo pacman -S gnome # 通常不直接装 gnome-extra，而是从里面选咱需要的 sudo pacman -S gnome-tweaks # GNOME 系统使用的 NetworkManager 需要额外安装并手动启用，否则无法联网 sudo pacman -S networkmanager sudo systemctl enable --now NetworkManager XFCE 对于服务器或 NAS 的图形界面，咱用 XFCE + TigerVNC Server。\nsudo pacman -S xfce4 tigervnc # 配置 VNC Server mkdir ~/.vnc cat \u003e ~/.vnc/config \u003c\u003c EOF session=xfce geometry=1920x1080 localhost=no alwaysshared EOF # VNC 登录密码 vncpasswd echo \":1=\" \u003e\u003e /etc/tigervnc/vncserver.users # 为用户配置使用 VNC 端口 5901 sudo systemctl enable --now vncserver@:1 常用的 GUI 软件 装好图形界面并顺利跑起来之后，就可以装常用的桌面软件了，下面这些是部分可能用到的软件，这些因人而异，仅供参考。\nsudo pacman -S vlc \\ virt-manager \\ ttf-monaco \\ noto-fonts noto-fonts-cjk noto-fonts-emoji ttf-dejavu \\ ibus ibus-rime \\ firefox \\ emacs 在 AUR 中安装的软件：\nyay -S google-chrome \\ visual-studio-code-bin 启用 Multilib 启用 Multilib 以安装那些 32 位的软件，例如 Steam。\n# /etc/pacman.conf [multilib] Include = /etc/pacman.d/mirrorlist 之后安装 Steam。\nsudo pacman -S steam 如果需要加速 Steam 游戏，可以安装 uuplugin-bin，把电脑伪装成 Steam Deck，酱紫路由器有 UU 加速器插件的话就能给 Steam 加速。\nyay -S uuplugin-bin 如果要运行 Windows 游戏，还要安装 Proton。\nyay -S proton 音乐 netease-cloud-music 这个包已经很久没更新了，现在很多功能用不了，除了这个还有一些基于 GTK4 写的网易云音乐客户端也能用。\n# yay -S netease-cloud-music # 网易云音乐 (很久未更新，不太好用) sudo pacman -S netease-cloud-music-gtk4 # GTK4 版本的网易云音乐 sudo pacman -S electron-netease-cloud-music # Electron 网易云音乐 yay -S cider2-bin # Apple Music （Cider2 软件需要购买） 流程图 Draw.io 这个工具画流程图很好用，而且支持 Linux，可以直接从 Arch Linux CN 安装。\nsudo pacman -S drawio-desktop-bin iPhone 如果需要挂载 iPhone 手机（安分守己）到电脑上，需要安装这些软件。\nsudo pacman -Sy ifuse usbmuxd libplist libimobiledevice 之后挂载 iPhone 的数据到某个文件夹下，就可以把手机的照片通过数据线拷贝到电脑上了。\nmkdir -p iPhone ifuse ~/iPhone 未完待续，如果还想到了别的再补充到这儿。\n","wordCount":"2073","inLanguage":"zh","image":"https://blog.starry-s.moe/avatar.png","datePublished":"2024-01-30T18:44:07+08:00","dateModified":"2024-01-30T18:44:07+08:00","author":{"@type":"Person","name":"STARRY-S"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.starry-s.moe/posts/2024/archlinux-utils/"},"publisher":{"@type":"Organization","name":"STARRY-S' Blog","logo":{"@type":"ImageObject","url":"https://blog.starry-s.moe/favicon-32x32.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.starry-s.moe/ accesskey=h title="Blog (Alt + H)"><img src=https://blog.starry-s.moe/apple-touch-icon.png alt aria-label=logo height=24>Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.starry-s.moe/gallery/ title=相册><span>相册</span></a></li><li><a href=https://blog.starry-s.moe/archives/ title=归档><span>归档</span></a></li><li><a href=https://blog.starry-s.moe/tags/ title=标签><span>标签</span></a></li><li><a href=https://blog.starry-s.moe/categories/ title=分类><span>分类</span></a></li><li><a href=https://blog.starry-s.moe/search/ title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li><li><a href=https://blog.starry-s.moe/projects/ title=项目><span>项目</span></a></li><li><a href=https://blog.starry-s.moe/about/ title=关于><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.starry-s.moe/>主页</a>&nbsp;»&nbsp;<a href=https://blog.starry-s.moe/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">一些 Arch Linux 的常用组件整理</h1><div class=post-meta><span title='2024-01-30 18:44:07 +0800 +0800'>2024-01-30 18:44:07 +0800</span>&nbsp;·&nbsp;5 分钟&nbsp;·&nbsp;2073 字&nbsp;·&nbsp;STARRY-S&nbsp;|&nbsp;<a href=https://github.com/STARRY-S/blog/edit/main/content/posts/2024/archlinux-utils/index.md rel="noopener noreferrer" target=_blank>Edit Text</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#装系统>装系统</a><ul><li><a href=#桥接网络>桥接网络</a></li></ul></li><li><a href=#常用命令行工具>常用命令行工具</a><ul><li><a href=#k3s--rke2-server>K3s / RKE2 Server</a></li><li><a href=#wireguard-client>WireGuard Client</a></li></ul></li><li><a href=#图形界面>图形界面</a><ul><li><a href=#wayland-on-nvidia>Wayland on NVIDIA</a></li><li><a href=#gnome>GNOME</a></li><li><a href=#xfce>XFCE</a></li></ul></li><li><a href=#常用的-gui-软件>常用的 GUI 软件</a><ul><li><a href=#启用-multilib>启用 Multilib</a></li><li><a href=#音乐>音乐</a></li><li><a href=#流程图>流程图</a></li><li><a href=#iphone>iPhone</a></li></ul></li></ul></nav></div></details></div><div class=post-content><p>用这么久 Arch 了，但是却很少写 Arch 相关的博客……</p><p>最近常需要在虚拟机上装 Arch，所以把常用工具及配置整理在这儿，省得每次 <code>pacstrap</code> 时都要想半天咱需要装什么……</p><meting-js server=netease type=song id=2104716079 theme=#233333></meting-js><hr><h2 id=装系统>装系统<a hidden class=anchor aria-hidden=true href=#装系统>#</a></h2><p>Arch Wiki 的 Installation Guide 在使用 <code>pacstrap</code> 装系统时只写了最基础的软件包 <code>base</code>, <code>linux</code> 和 <code>linux-firmware</code>，可以在这一步补充亿些常用的软件。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>pacstrap -K /mnt base linux linux-firmware <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    base-devel gcc grub amd-ucode intel-ucode <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    zsh zsh-syntax-highlighting zsh-autosuggestions <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    vim neovim git openbsd-netcat <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    sudo man-db htop wget <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    neofetch
</span></span></code></pre></div><p>进 chroot 后编辑 <code>/etc/pacman.conf</code>，添加以下配置，启用 Arch Linux CN。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># /etc/pacman.conf
</span></span><span class=line><span class=cl>[archlinuxcn]
</span></span><span class=line><span class=cl># Server = https://repo.archlinuxcn.org/$arch
</span></span><span class=line><span class=cl>Server = https://mirrors.bfsu.edu.cn/archlinuxcn/$arch
</span></span></code></pre></div><p>之后安装 <code>yay</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>sudo pacman -Syy <span class=o>&amp;&amp;</span> sudo pacman -S archlinuxcn-keyring
</span></span><span class=line><span class=cl>sudo pacman -S yay
</span></span></code></pre></div><p>如果电脑上安装了其他系统的话，需要额外安装 <code>os-prober</code>，让 GRUB 在生成配置文件时搜索安装了其他系统的磁盘。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>sudo pacman -S os-prober
</span></span></code></pre></div><p>如果是为 QEMU KVM 虚拟机装系统的话，在执行 <code>grub-install</code> 配置 UEFI 启动引导时记得加一个 <code>--removable</code> 参数。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>sudo pacman -S efibootmgr
</span></span><span class=line><span class=cl>sudo grub-install --target<span class=o>=</span>x86_64-efi --efi-directory<span class=o>=</span>/boot --bootloader-id<span class=o>=</span>GRUB --removable
</span></span><span class=line><span class=cl>sudo grub-mkconfig -o /boot/grub/grub.cfg
</span></span></code></pre></div><p>如果不装其他网络工具，只使用 <code>systemd-networkd</code> 的话，需要创建一份默认的配置文件使用 DHCP，否则连不上网。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># /etc/systemd/network/10-default.network
</span></span><span class=line><span class=cl>[Match]
</span></span><span class=line><span class=cl>Name=enp*
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[Network]
</span></span><span class=line><span class=cl>DHCP=yes
</span></span></code></pre></div><p>如果需要配置静态网络地址：<br>（这里只配置了静态 IPv4，如需要禁用 IPv6 的 DHCP，请参照下方<a href=/posts/2024/archlinux-utils/#%e6%a1%a5%e6%8e%a5%e7%bd%91%e7%bb%9c>桥接网络</a>）</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># /etc/systemd/network/10-static.network
</span></span><span class=line><span class=cl>[Match]
</span></span><span class=line><span class=cl>Name=eth0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[Network]
</span></span><span class=line><span class=cl>Address=10.128.0.100/16
</span></span><span class=line><span class=cl>Gateway=10.128.0.1
</span></span><span class=line><span class=cl>DNS=10.128.0.1
</span></span></code></pre></div><p>并启用 <code>systemd-networkd</code> Systemd Service：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>sudo systemctl enable systemd-networkd
</span></span></span></code></pre></div><p>基本上到这里就可以愉快的 <code>reboot</code> 了，一个精简的系统所需要的软件就基本装好了。</p><h3 id=桥接网络>桥接网络<a hidden class=anchor aria-hidden=true href=#桥接网络>#</a></h3><p>如果需要使用虚拟机的桥接网络，需要在物理网卡的基础上配置一个<a href=https://wiki.archlinux.org/title/Systemd-networkd#Bridge_interface>桥接网卡</a>，然后为这个桥接网卡配置网络。</p><p>先创建一个 <code>br0</code> 网卡设备。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># /etc/systemd/network/25-br0.netdev
</span></span><span class=line><span class=cl>[NetDev]
</span></span><span class=line><span class=cl>Name=br0
</span></span><span class=line><span class=cl>Kind=bridge
</span></span></code></pre></div><p>将 <code>br0</code> 绑定到某个物理网卡设备。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># /etc/systemd/network/25-br0-en.network
</span></span><span class=line><span class=cl>[Match]
</span></span><span class=line><span class=cl>Name=en*
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[Network]
</span></span><span class=line><span class=cl>Bridge=br0
</span></span></code></pre></div><p>为 <code>br0</code> 桥接网卡配置静态 IP 地址，这里禁用了 IPv4 和 IPv6 的 DHCP。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># /etc/systemd/network/25-br0.network
</span></span><span class=line><span class=cl>[Match]
</span></span><span class=line><span class=cl>Name=br0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[Network]
</span></span><span class=line><span class=cl>DHCP=no
</span></span><span class=line><span class=cl>DNS=10.128.0.1
</span></span><span class=line><span class=cl>IPv6AcceptRA=false
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[Address]
</span></span><span class=line><span class=cl>Address=10.128.0.100/16
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># IPv6 static address
</span></span><span class=line><span class=cl># [Address]
</span></span><span class=line><span class=cl># Address=fd00:cafe:abcd::1001/64
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[Route]
</span></span><span class=line><span class=cl>Gateway=10.128.0.1
</span></span><span class=line><span class=cl>GatewayOnLink=yes
</span></span></code></pre></div><h2 id=常用命令行工具>常用命令行工具<a hidden class=anchor aria-hidden=true href=#常用命令行工具>#</a></h2><p>如果只作为服务器 / 不包含图形的虚拟机使用的话，装这些咱常用软件，这部分因人而异，仅供参考。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>sudo pacman -S go <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    kubectl helm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    docker docker-buildx <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    podman <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    privoxy <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    proxychains <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    wireguard-tools <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    axel aria2 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    ffmpeg <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    jq go-yq <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    jdk8-openjdk <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    lm_sensors <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    net-tools traceroute <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    openssh <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    nodejs npm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    python3 python-pip <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    btrfs-progs <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=nb>bind</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    ethtool <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    bc <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    age
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># golangci-lint</span>
</span></span><span class=line><span class=cl>yay -S golangci-lint-bin <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    krew-bin
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 装完 Docker 后把普通用户添加到 docker group 中</span>
</span></span><span class=line><span class=cl>sudo usermod -aG docker <span class=nv>$USER</span>
</span></span></code></pre></div><p>创建 Docker Daemon 的配置文件 <code>/etc/docker/daemon.json</code>，设定国内的 Mirror，这里用的是咱自己搭的反向代理：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;insecure-registries&#34;</span> <span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;127.0.0.1:5000&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;registry-mirrors&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;https://docker.hxstarrys.me/&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>除了 Docker，还建议使用 Podman 运行一些容器，使用方式和 Docker 没什么大区别，以免去 Daemon 依赖并支持 Systemd。</p><p>如果需要跑虚拟机，需要装 QEMU 和 <code>libvirt</code> 相关的组件（咱用 <code>virsh</code> 管理虚拟机，不手搓 qemu 指令）：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>sudo pacman -S qemu-full libvirt
</span></span></code></pre></div><h3 id=k3s--rke2-server>K3s / RKE2 Server<a hidden class=anchor aria-hidden=true href=#k3s--rke2-server>#</a></h3><p>在 Arch Linux 上安装了 K3s 或 RKE2，关机时会卡在 <code>a stop is running for libcontainer containerd...</code> 一分多钟……</p><p>参考 <a href=https://github.com/k3s-io/k3s/issues/2400#issuecomment-1312621468>这个 Issue</a>，创建一个 <code>/etc/systemd/system/shutdown-k3s.service</code> Systemd 文件。</p><p>(如果用的是 RKE2，把文件的 <code>k3s</code> 替换为 <code>rke2</code>)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[Unit]
</span></span><span class=line><span class=cl>Description=Kill containerd-shims on shutdown
</span></span><span class=line><span class=cl>DefaultDependencies=false
</span></span><span class=line><span class=cl>Before=shutdown.target umount.target
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[Service]
</span></span><span class=line><span class=cl>ExecStart=/usr/local/bin/k3s-killall.sh
</span></span><span class=line><span class=cl>Type=oneshot
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[Install]
</span></span><span class=line><span class=cl>WantedBy=shutdown.target
</span></span></code></pre></div><p>之后启用 <code>shutdown-k3s.service</code>，在关机时 Kill 掉 K3s。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>sudo systemctl daemon-reload
</span></span><span class=line><span class=cl>sudo systemctl <span class=nb>enable</span> shutdown-k3s.service
</span></span></code></pre></div><h3 id=wireguard-client>WireGuard Client<a hidden class=anchor aria-hidden=true href=#wireguard-client>#</a></h3><p>如果 Arch Linux 还配置了 WireGuard 客户端，而这台 Arch Linux Server 被放在了家里，只能通过有公网 IP 的 WireGuard 服务器连接进去，这时尽管设置了 WireGuard 的 <code>persistent keepalive</code>，但在运营商更换了你家的公网 IP 后，还是会碰到无法自动连接回去的情况，这时可以用咱的 <a href=https://github.com/STARRY-S/wireguard-keepalive>这个简单粗暴的脚本</a>，在 WireGuard 断连一段时间后，自动重启接口。</p><h2 id=图形界面>图形界面<a hidden class=anchor aria-hidden=true href=#图形界面>#</a></h2><p>显卡驱动：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># AMD</span>
</span></span><span class=line><span class=cl>sudo pacman -S xf86-video-amdgpu
</span></span><span class=line><span class=cl><span class=c1># NVIDIA</span>
</span></span><span class=line><span class=cl><span class=c1># (咱并不喜欢 DKMS 因为每次更新内核都得编译一遍 Kernel Module，所以这里使用的和 Linux 内核一同更新的 NVIDIA Open Driver)</span>
</span></span><span class=line><span class=cl>sudo pacman -S nvidia-open nvidia-utils nvidia-container-toolkit
</span></span></code></pre></div><p>X11/Wayland 这些相关组件会随着桌面环境一起安装，所以只需要装桌面环境即可，<span class=spoiler>这里就不需要你额外装 X 了</span>。</p><h3 id=wayland-on-nvidia>Wayland on NVIDIA<a hidden class=anchor aria-hidden=true href=#wayland-on-nvidia>#</a></h3><p>在 NVIDIA 显卡上运行 Wayland 需要一些额外操作。</p><ul><li><p>增加 <code>nvidia_drm.modeset=1</code> 内核参数（记得重新生成 <code>grub.cfg</code>）</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># /etc/default/grub
</span></span><span class=line><span class=cl>GRUB_CMDLINE_LINUX=&#34;nvidia_drm.modeset=1&#34;
</span></span></code></pre></div></li><li><p>禁用 <code>nouveau</code>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> <span class=nb>echo</span> <span class=s2>&#34;blacklist nouveau&#34;</span> &gt;&gt; /etc/modprobe.d/blacklist.conf
</span></span></code></pre></div></li><li><p>KMS Early Load。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># /etc/mkinitcpio.conf
</span></span><span class=line><span class=cl>MODULES=(nvidia nvidia_modeset nvidia_uvm nvidia_drm)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># 然后移除 HOOKS 那一行里的 kms 以完全禁用 nouveau
</span></span></code></pre></div><p>记得重新 <code>mkinitcpio -P</code>。</p></li></ul><h3 id=gnome>GNOME<a hidden class=anchor aria-hidden=true href=#gnome>#</a></h3><p>如果使用 GNOME Desktop（咱默认使用这个桌面），需要安装这些组件</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>sudo pacman -S gnome
</span></span><span class=line><span class=cl><span class=c1># 通常不直接装 gnome-extra，而是从里面选咱需要的</span>
</span></span><span class=line><span class=cl>sudo pacman -S gnome-tweaks
</span></span><span class=line><span class=cl><span class=c1># GNOME 系统使用的 NetworkManager 需要额外安装并手动启用，否则无法联网</span>
</span></span><span class=line><span class=cl>sudo pacman -S networkmanager
</span></span><span class=line><span class=cl>sudo systemctl <span class=nb>enable</span> --now NetworkManager
</span></span></code></pre></div><h3 id=xfce>XFCE<a hidden class=anchor aria-hidden=true href=#xfce>#</a></h3><p>对于服务器或 NAS 的图形界面，咱用 XFCE + TigerVNC Server。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>sudo pacman -S xfce4 tigervnc
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 配置 VNC Server</span>
</span></span><span class=line><span class=cl>mkdir ~/.vnc
</span></span><span class=line><span class=cl>cat &gt; ~/.vnc/config <span class=s>&lt;&lt; EOF
</span></span></span><span class=line><span class=cl><span class=s>session=xfce
</span></span></span><span class=line><span class=cl><span class=s>geometry=1920x1080
</span></span></span><span class=line><span class=cl><span class=s>localhost=no
</span></span></span><span class=line><span class=cl><span class=s>alwaysshared
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># VNC 登录密码</span>
</span></span><span class=line><span class=cl>vncpasswd
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;:1=&lt;USERNAME&gt;&#34;</span> &gt;&gt; /etc/tigervnc/vncserver.users <span class=c1># 为用户配置使用 VNC 端口 5901 </span>
</span></span><span class=line><span class=cl>sudo systemctl <span class=nb>enable</span> --now vncserver@:1
</span></span></code></pre></div><h2 id=常用的-gui-软件>常用的 GUI 软件<a hidden class=anchor aria-hidden=true href=#常用的-gui-软件>#</a></h2><p>装好图形界面并顺利跑起来之后，就可以装常用的桌面软件了，下面这些是部分可能用到的软件，这些因人而异，仅供参考。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>sudo pacman -S vlc <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    virt-manager <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    ttf-monaco <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    noto-fonts noto-fonts-cjk noto-fonts-emoji ttf-dejavu <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    ibus ibus-rime <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    firefox <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    emacs
</span></span></code></pre></div><p>在 AUR 中安装的软件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>yay -S google-chrome <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    visual-studio-code-bin
</span></span></code></pre></div><h3 id=启用-multilib>启用 Multilib<a hidden class=anchor aria-hidden=true href=#启用-multilib>#</a></h3><p>启用 Multilib 以安装那些 32 位的软件，例如 Steam。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># /etc/pacman.conf
</span></span><span class=line><span class=cl>[multilib]
</span></span><span class=line><span class=cl>Include = /etc/pacman.d/mirrorlist
</span></span></code></pre></div><p>之后安装 Steam。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>sudo pacman -S steam
</span></span></code></pre></div><p>如果需要加速 Steam 游戏，可以安装 <a href=https://aur.archlinux.org/packages/uuplugin-bin>uuplugin-bin</a>，把电脑伪装成 Steam Deck，酱紫路由器有 UU 加速器插件的话就能给 Steam 加速。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>yay -S uuplugin-bin
</span></span></code></pre></div><p>如果要运行 Windows 游戏，还要安装 Proton。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>yay -S proton
</span></span></code></pre></div><h3 id=音乐>音乐<a hidden class=anchor aria-hidden=true href=#音乐>#</a></h3><p><code>netease-cloud-music</code> 这个包已经很久没更新了，现在很多功能用不了，除了这个还有一些基于 GTK4 写的网易云音乐客户端也能用。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># yay -S netease-cloud-music # 网易云音乐 (很久未更新，不太好用)</span>
</span></span><span class=line><span class=cl>sudo pacman -S netease-cloud-music-gtk4     <span class=c1># GTK4 版本的网易云音乐</span>
</span></span><span class=line><span class=cl>sudo pacman -S electron-netease-cloud-music <span class=c1># Electron 网易云音乐</span>
</span></span><span class=line><span class=cl>yay -S cider2-bin  <span class=c1># Apple Music （Cider2 软件需要购买）</span>
</span></span></code></pre></div><h3 id=流程图>流程图<a hidden class=anchor aria-hidden=true href=#流程图>#</a></h3><p>Draw.io 这个工具画流程图很好用，而且支持 Linux，可以直接从 Arch Linux CN 安装。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>sudo pacman -S drawio-desktop-bin
</span></span></code></pre></div><h3 id=iphone>iPhone<a hidden class=anchor aria-hidden=true href=#iphone>#</a></h3><p>如果需要挂载 iPhone 手机（<span class=spoiler>安分守己</span>）到电脑上，需要安装这些软件。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>sudo pacman -Sy ifuse usbmuxd libplist libimobiledevice
</span></span></code></pre></div><p>之后挂载 iPhone 的数据到某个文件夹下，就可以把手机的照片通过数据线拷贝到电脑上了。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>mkdir -p iPhone
</span></span><span class=line><span class=cl>ifuse ~/iPhone
</span></span></code></pre></div><hr><p>未完待续，如果还想到了别的再补充到这儿。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.starry-s.moe/tags/arch-linux/>Arch Linux</a></li></ul><nav class=paginav><a class=prev href=https://blog.starry-s.moe/posts/2024/k3s-multus-macvlan/><span class=title>« 上一页</span><br><span>K3s + Multus CNI 插件使用 Macvlan</span>
</a><a class=next href=https://blog.starry-s.moe/posts/2024/hello-2024/><span class=title>下一页 »</span><br><span>Hello 2024</span></a></nav></footer><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//starry-s-blog.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>© 2016 - 2025 STARRY-S | <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a> | Hosted on <a href=https://pages.github.com>GitHub Pages</a><br></span>·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>const pathname=window.location.pathname,images=document.querySelectorAll("img");Array.from(images).forEach(e=>{if(!pathname.includes("/posts/"))return;if(e.src.indexOf("images")<0)return;e.addEventListener("load",()=>fitImage(e)),e.complete&&e.naturalWidth!==0&&fitImage(e)});function fitImage(e){e.style.marginLeft="auto",e.style.marginRight="auto",e.naturalWidth/e.naturalHeight<1.1&&(e.style.maxWidth="60%",e.style.height="auto")}</script><script src=/js/home-info.js></script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>