<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>再探容器网络 | STARRY-S' Blog</title>
<meta name=keywords content="Network,Container,Kubernetes"><meta name=description content="在写之前的 初探容器网络 时是想过什么时候写后续的，这期间鸽了不到半年，嗯也不算很久，忙完手头的事情继续更一下容器网络系列……"><meta name=author content="STARRY-S"><link rel=canonical href=https://blog.starry-s.moe/posts/2024/container-network-2/><link crossorigin=anonymous href=/assets/css/stylesheet.20f252ab267ef2389457f4b928262f7d68d73a65f570c2208c1f47dbefb17a72.css integrity="sha256-IPJSqyZ+8jiUV/S5KCYvfWjXOmX1cMIgjB9H2++xenI=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.starry-s.moe/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://blog.starry-s.moe/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.starry-s.moe/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.starry-s.moe/apple-touch-icon.png><link rel=mask-icon href=https://blog.starry-s.moe/apple-touch-icon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://blog.starry-s.moe/posts/2024/container-network-2/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/aplayer/dist/APlayer.min.css><script src=https://fastly.jsdelivr.net/npm/aplayer/dist/APlayer.min.js></script><script src=https://fastly.jsdelivr.net/npm/meting/dist/Meting.min.js></script><script>var meting_api="https://api.injahow.cn/meting/?server=:server&type=:type&id=:id&auth=:auth&r=:r"</script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#232323"><meta property="og:title" content="再探容器网络"><meta property="og:description" content="在写之前的 初探容器网络 时是想过什么时候写后续的，这期间鸽了不到半年，嗯也不算很久，忙完手头的事情继续更一下容器网络系列……"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.starry-s.moe/posts/2024/container-network-2/"><meta property="og:image" content="https://blog.starry-s.moe/avatar.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-07-11T01:12:36+08:00"><meta property="article:modified_time" content="2024-07-11T01:12:36+08:00"><meta property="og:site_name" content="STARRY-S' Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.starry-s.moe/avatar.png"><meta name=twitter:title content="再探容器网络"><meta name=twitter:description content="在写之前的 初探容器网络 时是想过什么时候写后续的，这期间鸽了不到半年，嗯也不算很久，忙完手头的事情继续更一下容器网络系列……"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.starry-s.moe/posts/"},{"@type":"ListItem","position":2,"name":"再探容器网络","item":"https://blog.starry-s.moe/posts/2024/container-network-2/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"再探容器网络","name":"再探容器网络","description":"在写之前的 初探容器网络 时是想过什么时候写后续的，这期间鸽了不到半年，嗯也不算很久，忙完手头的事情继续更一下容器网络系列……\n","keywords":["Network","Container","Kubernetes"],"articleBody":"在写之前的 初探容器网络 时是想过什么时候写后续的，这期间鸽了不到半年，嗯也不算很久，忙完手头的事情继续更一下容器网络系列……\n在上篇 初探容器网络 中咱简单的写了 Linux Network Namespace 和容器相关的东西，所以这篇会继续上一篇的内容拓展一下 CNI 网络插件和他的好朋友们……\nContainer Network Interface (CNI) 有关 CNI 的介绍可以在他的官网 找到，CNI 定义了一套 Linux 容器的网络接口规范和相关代码库，还提供了一些简单的样例网络插件代码。Kubernetes 使用 CNI 网络插件为 Pod 创建网络。 需要注意的是 Docker 的容器网络不是由 CNI 插件创建的，而是由 Docker 自己的 Driver 负责创建，这里需要注意别弄混了，其他的容器运行时也不完全是使用 CNI 网络插件，也可能是用的别的插件的标准。\n不过 CNI 在 Kubernetes 中广为使用，学起来也不是很难（），所以本篇就先围绕着 CNI 进行简单的介绍，熟悉完 CNI 后其他种类的网络插件也相对的能更容易上手一些。\n首先来熟悉一下到底什么是 CNI 插件，有关 CNI 的定义和详细介绍可以在这里找到，但新手可能单凭这个介绍，无法对 CNI 有详细的了解，实际上官网的定义介绍感觉更像是给一个熟悉 CNI 网络插件的查阅的手册而不是帮一个萌新去了解的入门指南。\n需要知道的是，CNI 插件是一个可执行文件，一个最简单的 CNI 插件可以是一个有执行权限的脚本，执行 ip link, ip route 等命令，为 Pod 的 Network Namespace 实现添加、删除虚拟接口等操作，就可以算得上是一个 CNI 插件。但强大一点的 CNI 插件都是由更灵活的编程语言写的程序，编译成二进制文件放在系统的某个路径下面。Kubernetes 集群可以指定默认使用的 CNI 网络插件（比如广为人知的 Calico、Flannel、Cilium 等），除此之外还可以使用一些额外插件为 Pod 创建多个虚拟网卡（例如 Multus CNI）。在 Pod 创建时，执行 CNI 插件为 Pod 的 Network Namespace 创建网卡接口。这里网卡接口类型不再局限为单纯的 Veth Pair，而可以是其他复杂类型的接口（比如 Macvlan、IPvlan 甚至你自己可以写个网络驱动）。在部署一个 Kubernetes 集群后，节点上执行 ip link 能看到一大堆名称为 vethXXXX@ifN 的虚拟接口，这些其实是由集群使用的 CNI 插件创建的 Veth Pair，因为这些 NS 的文件被放在了 /run/netns 路径下面，所以可以被 ip link 命令识别到，而 Docker 的 NS 文件不在这个路径里面，所以用 Docker 跑容器时，执行 ip link 不会有许多 Veth 虚拟设备输出在屏幕上。\nCNI 参数 执行 CNI 时，通过一些环境变量向 CNI 传递参数，传递的环境变量为：\nCNI_COMMAND: CNI 插件执行的命令，在 CNI Spec 1.0.0 中，CNI 插件支持 ADD, DEL, CHECK, VERSION 这四个命令。 CNI_CONTAINERID: 容器的 Container ID，由 Container Runtime 管理。 CNI_NETNS: 容器的 Network Namespace 在节点上的路径，通常是在 /run/netns/[nsname] 路径下面。 CNI_IFNAME: 待创建的网卡名称，例如最常见的情况是容器里有一块网卡，名为 eth0。 CNI_ARGS: 向 CNI 插件传递的一些其他参数，格式为 KEY=VALUE，由分号分隔，例如 FOO=BAR;ABC=123。 CNI_PATH: CNI 可执行文件所在路径列表。 CNI 返回值 如果 CNI 成功执行并完成了指定的命令，它的返回值为 0，其他非 0 的返回值代表错误，输出一串 JSON，包含错误的详细内容，关于 CNI Errors 的定义可以看这里。\nCNI 命令 在 CNI Spec 0.4.0 之前，CNI 插件只定义了 ADD, DEL, VERSION 这三个命令，分别对应 “添加网络”、“删除网络”、“支持版本”。CNI Spec 0.4.0 新引入了 CHECK 命令，用于对已创建网络的容器进行校验。\n配置文件 CNI 配置文件为 JSON 格式，以下是一个样例配置文件：\n{ // CNI Spec Version \"cniVersion\": \"1.0.0\", // Network name. \"name\": \"dbnet\", \"plugins\": [ { // CNI Plugin Binary name \"type\": \"bridge\", // CNI Plugin specific parameters... \"bridge\": \"cni0\", // Dictionary with IPAM (IP Address Management) specific values. \"ipam\": { // IPAM Plugin Binary name \"type\": \"host-local\", // IPAM specific params... \"subnet\": \"10.1.0.0/16\", \"gateway\": \"10.1.0.1\", \"routes\": [ { \"dst\": \"0.0.0.0/0\" } ] }, \"dns\": { \"nameservers\": [ \"10.1.0.1\" ] } } ] } 通常高级的 CNI 插件可以自动的由 Controller 生成他所需的 CNI Config，而简易的 CNI 插件需要手动的编写 Config 文件放在 /etc/cni/net.d/ 目录下面（不同类型的集群的 Config 路径可能不一致）。\n光凭上面这一大堆 Specification 定义比较难理解这个抽象的 CNI 插件，所以接下来我们拆解一个样例 CNI 插件，并手撮一个简易的 CNI 插件。\n样例 CNI 插件 在 GitHub 的 containernetworking Org 里能找到许多 CNI Plugin 代码，这里为样例 p2p CNI Plugin 插件代码，这个插件能为容器和主机之间创建一对 Veth Pair，可以主机和容器之间的点对点访问。在这里还能找到一些其他样例插件代码，例如为容器创建 Linux Kernel 的 bridge、macvlan、ipvlan 等类型的网卡接口。\n样例插件由 Go 语言编写，所以这里需要你熟悉 Go 编程语言。为了折腾 CNI 插件，你需要有一个调试使用的 Kubernetes 集群，因为 Pod 需要具备跨节点通信的能力，所以集群最好至少有一个 Master (etcd, controlplane, scheduler) 和 2 个 Worker (scheduler) 节点，将 Pod 调度到不同节点上验证节点之间 Pod 连同性，因为折腾 CNI 时很可能同一个节点的 Pod 能互相访问而不能跨节点访问，也可能节点能访问其他节点上的 Pod 但无法访问运行在当前节点的 Pod 等一堆复杂问题。集群的节点最好是可以灵活重启抗造的物理机或 KVM 虚拟机（因公有云的网路环境略微复杂且大多数公有云都不支持 KVM，所以不是很建议在公有云上折腾 CNI 网络插件）。 同时本篇需要你具备一些基本的计算机网络基础，例如可以先看一下 IPv4/IPv6 的网络编址/子网划分、OSI 七层模型的 L2 和 L3 层，例如 2 层交换机 (Switch) 和 3 层交换机 (Router) 的区别，更复杂一点的地方需要你清楚常见的 VLAN (IEEE 802.1Q、802.1ad) 以及后续衍生出来的 VXLAN 等 *VLAN 协议……\n往简单来说 CNI 插件基本的功能就是执行 ip link, ip route, ip netns 等一系列命令为 Pod 的 Network Namespace 和主机的 Default Network Namespace 之间创建虚拟网卡实现互相通信。Go 语言同样有 Library 提供了 Linux ip 命令的代码，常用的 Go Library 包含以下的：\nhttps://github.com/vishvananda/netlink: Go 语言实现的 iproute2 命令行工具的 API，可以执行类似 ip link, ip route 等命令 https://github.com/vishvananda/netns: Go 语言实现的处理 Linux Network Namespace API https://github.com/containernetworking/cni: 包含 CNI 定义 Types 和常用组件 打开样例 p2p CNI 插件代码，先看他的 main 函数只有简洁的一行 skel.PluginMain，这个方法会处理环境变量传入的 CNI 参数，加载 Config，执行相应的 COMMAND。\nfunc main() { skel.PluginMain(cmdAdd, cmdCheck, cmdDel, version.All, bv.BuildString(\"ptp\")) } ADD 命令 ADD 命令用于为容器创建网卡（或修改已有的网卡），找一下 p2p CNI 插件的 cmdAdd 函数，大致简化一下里面的代码流程为：\nfunc cmdAdd(args *skel.CmdArgs) error { // Load CNI Config conf := NetConf{} if err := json.Unmarshal(args.StdinData, \u0026conf); err != nil { return fmt.Errorf(\"failed to load netconf: %v\", err) } // --------------------------------------------- // Execute IPAM command to get IP address r, err := ipam.ExecAdd(conf.IPAM.Type, args.StdinData) if err != nil { return err } result, err := current.NewResultFromResult(r) if err != nil { return err } if len(result.IPs) == 0 { return errors.New(\"IPAM plugin returned missing IP config\") } if err := ip.EnableForward(result.IPs); err != nil { return fmt.Errorf(\"Could not enable IP forwarding: %v\", err) } // --------------------------------------------- // Create Veth Pair for Pod Network Namespace netns, err := ns.GetNS(args.Netns) if err != nil { return fmt.Errorf(\"failed to open netns %q: %v\", args.Netns, err) } defer netns.Close() hostInterface, _, err := setupContainerVeth(netns, args.IfName, conf.MTU, result) if err != nil { return err } // --------------------------------------------- // Setup Veth Pair for default Network Namespace if err = setupHostVeth(hostInterface.Name, result); err != nil { return err } // Some other IP forward (masquerade) operations... return types.PrintResult(result, conf.CNIVersion) } 简单概括样例 P2P Plugin 的 ADD 命令流程大致为：\n加载 CNI Config 配置文件 执行 IPAM 获取 Pod IP 创建一对 Veth Pair，其中一个 Iface 接口放在 Pod NS 中，配置 IP、路由等 另一个 Veth Pair 的 Iface 接口放在 default NS 中，配置 IP、路由…… 配置 Default NS 的 Masquerade 等额外操作 输出运行结果 DEL 命令 DEL 命令用于释放容器和主机的网卡接口资源，在 Pod 删除时被执行，以下是简化的样例 P2P Plugin 的 cmdDel 函数代码：\nfunc cmdDel(args *skel.CmdArgs) error { // Load CNI Config conf := NetConf{} if err := json.Unmarshal(args.StdinData, \u0026conf); err != nil { return fmt.Errorf(\"failed to load netconf: %v\", err) } // --------------------------------------------- // Execute IPAM command to release IP address if err := ipam.ExecDel(conf.IPAM.Type, args.StdinData); err != nil { return err } // --------------------------------------------- // Release link interface \u0026 masquerades... var ipnets []*net.IPNet err := ns.WithNetNSPath(args.Netns, func(_ ns.NetNS) error { var err error ipnets, err = ip.DelLinkByNameAddr(args.IfName) if err != nil \u0026\u0026 err == ip.ErrLinkNotFound { return nil } return err }) if err != nil { ... } if len(ipnets) != 0 \u0026\u0026 conf.IPMasq { for _, ipn := range ipnets { err = ip.TeardownIPMasq(ipn, ...) } } return err } 简单概括 DEL 命令流程大致为：\n加载 CNI Config 配置文件 执行 IPAM 释放 Pod IP 释放 Veth Pair 和其他配置 (Masquerade…) CHECK 命令 CHECK 命令用于校验 Pod 网络，CNI Spec 0.4.0 中，Config 新增了 prevResult 字段，记录了 CNI 插件上一次执行 ADD 命令的执行结果。 CHECK 命令将 prevResult 记录的状态信息和设定的期望值进行比对，输出校验结果。\n未完待续\n","wordCount":"2858","inLanguage":"zh","datePublished":"2024-07-11T01:12:36+08:00","dateModified":"2024-07-11T01:12:36+08:00","author":{"@type":"Person","name":"STARRY-S"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.starry-s.moe/posts/2024/container-network-2/"},"publisher":{"@type":"Organization","name":"STARRY-S' Blog","logo":{"@type":"ImageObject","url":"https://blog.starry-s.moe/favicon-32x32.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.starry-s.moe/ accesskey=h title="Blog (Alt + H)"><img src=https://blog.starry-s.moe/apple-touch-icon.png alt aria-label=logo height=24>Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://blog.starry-s.moe/en/ title=English aria-label=English>En</a></li></ul></div></div><ul id=menu><li><a href=https://blog.starry-s.moe/gallery/ title=相册><span>相册</span></a></li><li><a href=https://blog.starry-s.moe/archives/ title=归档><span>归档</span></a></li><li><a href=https://blog.starry-s.moe/tags/ title=标签><span>标签</span></a></li><li><a href=https://blog.starry-s.moe/categories/ title=分类><span>分类</span></a></li><li><a href=https://blog.starry-s.moe/search/ title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li><li><a href=https://blog.starry-s.moe/projects/ title=项目><span>项目</span></a></li><li><a href=https://blog.starry-s.moe/about/ title=关于><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.starry-s.moe/>主页</a>&nbsp;»&nbsp;<a href=https://blog.starry-s.moe/posts/>Posts</a></div><h1 class=post-title>再探容器网络</h1><div class=post-meta><span title='2024-07-11 01:12:36 +0800 +0800'>2024-07-11 01:12:36 +0800</span>&nbsp;·&nbsp;6 分钟&nbsp;·&nbsp;2858 字&nbsp;·&nbsp;STARRY-S&nbsp;|&nbsp;<a href=https://github.com/STARRY-S/blog/edit/main/content/posts/2024/container-network-2/index.md rel="noopener noreferrer" target=_blank>Edit Text</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#container-network-interface-cni>Container Network Interface (CNI)</a><ul><li><a href=#cni-参数>CNI 参数</a></li><li><a href=#cni-返回值>CNI 返回值</a></li><li><a href=#cni-命令>CNI 命令</a></li><li><a href=#配置文件>配置文件</a></li><li><a href=#样例-cni-插件>样例 CNI 插件</a></li></ul></li></ul></nav></div></details></div><div class=post-content><p>在写之前的 <a href=../container-network-1/>初探容器网络</a> 时是想过什么时候写后续的，这期间鸽了不到半年，嗯也不算很久，忙完手头的事情继续更一下容器网络系列……</p><meting-js server=netease type=song id=1416321955 theme=#233333></meting-js><p>在上篇 <a href=../container-network-1/>初探容器网络</a> 中咱简单的写了 Linux Network Namespace 和容器相关的东西，所以这篇会继续上一篇的内容拓展一下 CNI 网络插件和他的好朋友们……</p><h2 id=container-network-interface-cni>Container Network Interface (CNI)<a hidden class=anchor aria-hidden=true href=#container-network-interface-cni>#</a></h2><p>有关 CNI 的介绍可以在他的<a href=https://www.cni.dev/>官网</a> 找到，CNI 定义了一套 Linux 容器的网络接口规范和相关代码库，还提供了一些简单的样例网络插件代码。Kubernetes 使用 CNI 网络插件为 Pod 创建网络。
需要注意的是 Docker 的容器网络不是由 CNI 插件创建的，而是由 Docker 自己的 <a href=https://docs.docker.com/network/drivers/>Driver</a> 负责创建，这里需要注意别弄混了，其他的容器运行时也不完全是使用 CNI 网络插件，也可能是用的别的插件的标准。</p><p>不过 CNI 在 Kubernetes 中广为使用，学起来也不是很难（），所以本篇就先围绕着 CNI 进行简单的介绍，熟悉完 CNI 后其他种类的网络插件也相对的能更容易上手一些。</p><p>首先来熟悉一下到底什么是 CNI 插件，有关 CNI 的定义和详细介绍可以在<a href=https://www.cni.dev/docs/spec/>这里</a>找到，但新手可能单凭这个介绍，无法对 CNI 有详细的了解，实际上官网的定义介绍感觉更像是给一个熟悉 CNI 网络插件的查阅的手册而不是帮一个萌新去了解的入门指南。</p><p>需要知道的是，CNI 插件是一个可执行文件，一个最简单的 CNI 插件可以是一个有执行权限的脚本，执行 <code>ip link</code>, <code>ip route</code> 等命令，为 Pod 的 Network Namespace 实现添加、删除虚拟接口等操作，就可以算得上是一个 CNI 插件。但强大一点的 CNI 插件都是由更灵活的编程语言写的程序，编译成二进制文件放在系统的某个路径下面。Kubernetes 集群可以指定默认使用的 CNI 网络插件（比如广为人知的 Calico、Flannel、Cilium 等），除此之外还可以使用一些额外插件为 Pod 创建多个虚拟网卡（例如 Multus CNI）。在 Pod 创建时，执行 CNI 插件为 Pod 的 Network Namespace 创建网卡接口。这里网卡接口类型不再局限为单纯的 Veth Pair，而可以是其他复杂类型的接口（比如 Macvlan、IPvlan 甚至你自己可以写个网络驱动）。在部署一个 Kubernetes 集群后，节点上执行 <code>ip link</code> 能看到一大堆名称为 <code>vethXXXX@ifN</code> 的虚拟接口，这些其实是由集群使用的 CNI 插件创建的 Veth Pair，因为这些 NS 的文件被放在了 <code>/run/netns</code> 路径下面，所以可以被 <code>ip link</code> 命令识别到，而 Docker 的 NS 文件不在这个路径里面，所以用 Docker 跑容器时，执行 <code>ip link</code> 不会有许多 Veth 虚拟设备输出在屏幕上。</p><h3 id=cni-参数>CNI 参数<a hidden class=anchor aria-hidden=true href=#cni-参数>#</a></h3><p>执行 CNI 时，通过一些环境变量向 CNI 传递参数，传递的环境变量为：</p><ul><li><code>CNI_COMMAND</code>: CNI 插件执行的命令，在 CNI Spec 1.0.0 中，CNI 插件支持 <code>ADD</code>, <code>DEL</code>, <code>CHECK</code>, <code>VERSION</code> 这四个命令。</li><li><code>CNI_CONTAINERID</code>: 容器的 Container ID，由 Container Runtime 管理。</li><li><code>CNI_NETNS</code>: 容器的 Network Namespace 在节点上的路径，通常是在 <code>/run/netns/[nsname]</code> 路径下面。</li><li><code>CNI_IFNAME</code>: 待创建的网卡名称，例如最常见的情况是容器里有一块网卡，名为 <code>eth0</code>。</li><li><code>CNI_ARGS</code>: 向 CNI 插件传递的一些其他参数，格式为 <code>KEY=VALUE</code>，由分号分隔，例如 <code>FOO=BAR;ABC=123</code>。</li><li><code>CNI_PATH</code>: CNI 可执行文件所在路径列表。</li></ul><h3 id=cni-返回值>CNI 返回值<a hidden class=anchor aria-hidden=true href=#cni-返回值>#</a></h3><p>如果 CNI 成功执行并完成了指定的命令，它的返回值为 0，其他非 0 的返回值代表错误，输出一串 JSON，包含错误的详细内容，关于 CNI Errors 的定义可以看<a href=https://www.cni.dev/docs/spec/#error>这里</a>。</p><h3 id=cni-命令>CNI 命令<a hidden class=anchor aria-hidden=true href=#cni-命令>#</a></h3><p>在 CNI Spec 0.4.0 之前，CNI 插件只定义了 <code>ADD</code>, <code>DEL</code>, <code>VERSION</code> 这三个命令，分别对应 “添加网络”、“删除网络”、“支持版本”。CNI Spec 0.4.0 新引入了 <code>CHECK</code> 命令，用于对已创建网络的容器进行校验。</p><h3 id=配置文件>配置文件<a hidden class=anchor aria-hidden=true href=#配置文件>#</a></h3><p>CNI 配置文件为 JSON 格式，以下是一个样例配置文件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// CNI Spec Version
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nt>&#34;cniVersion&#34;</span><span class=p>:</span> <span class=s2>&#34;1.0.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Network name.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;dbnet&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;plugins&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// CNI Plugin Binary name
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;bridge&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=c1>// CNI Plugin specific parameters...
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nt>&#34;bridge&#34;</span><span class=p>:</span> <span class=s2>&#34;cni0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Dictionary with IPAM (IP Address Management) specific values.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nt>&#34;ipam&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// IPAM Plugin Binary name
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;host-local&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=c1>// IPAM specific params...
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nt>&#34;subnet&#34;</span><span class=p>:</span> <span class=s2>&#34;10.1.0.0/16&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;gateway&#34;</span><span class=p>:</span> <span class=s2>&#34;10.1.0.1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;routes&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span> <span class=nt>&#34;dst&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0.0.0/0&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;dns&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;nameservers&#34;</span><span class=p>:</span> <span class=p>[</span> <span class=s2>&#34;10.1.0.1&#34;</span> <span class=p>]</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>通常高级的 CNI 插件可以自动的由 Controller 生成他所需的 CNI Config，而简易的 CNI 插件需要手动的编写 Config 文件放在 <code>/etc/cni/net.d/</code> 目录下面（不同类型的集群的 Config 路径可能不一致）。</p><p>光凭上面这一大堆 Specification 定义比较难理解这个抽象的 CNI 插件，所以接下来我们拆解一个样例 CNI 插件，并手撮一个简易的 CNI 插件。</p><h3 id=样例-cni-插件>样例 CNI 插件<a hidden class=anchor aria-hidden=true href=#样例-cni-插件>#</a></h3><p>在 GitHub 的 <code>containernetworking</code> Org 里能找到许多 CNI Plugin 代码，<a href=https://github.com/containernetworking/plugins/tree/main/plugins/main/ptp>这里</a>为样例 <code>p2p</code> CNI Plugin 插件代码，这个插件能为容器和主机之间创建一对 Veth Pair，可以主机和容器之间的点对点访问。在<a href=https://github.com/containernetworking/plugins>这里</a>还能找到一些其他样例插件代码，例如为容器创建 Linux Kernel 的 <code>bridge</code>、<code>macvlan</code>、<code>ipvlan</code> 等类型的网卡接口。</p><p>样例插件由 Go 语言编写，所以这里需要你熟悉 Go 编程语言。为了折腾 CNI 插件，你需要有一个调试使用的 Kubernetes 集群，因为 Pod 需要具备跨节点通信的能力，所以集群最好至少有一个 Master (etcd, controlplane, scheduler) 和 2 个 Worker (scheduler) 节点，将 Pod 调度到不同节点上验证节点之间 Pod 连同性，因为折腾 CNI 时很可能同一个节点的 Pod 能互相访问而不能跨节点访问，也可能节点能访问其他节点上的 Pod 但无法访问运行在当前节点的 Pod 等一堆复杂问题。集群的节点最好是可以灵活重启抗造的物理机或 KVM 虚拟机（因公有云的网路环境略微复杂且大多数公有云都不支持 KVM，所以不是很建议在公有云上折腾 CNI 网络插件）。
同时本篇需要你具备一些基本的计算机网络基础，例如可以先看一下 IPv4/IPv6 的网络编址/子网划分、OSI 七层模型的 L2 和 L3 层，例如 2 层交换机 (Switch) 和 3 层交换机 (Router) 的区别，更复杂一点的地方需要你清楚常见的 VLAN (<a href=https://en.wikipedia.org/wiki/IEEE_802.1Q>IEEE 802.1Q</a>、<a href=https://en.wikipedia.org/wiki/IEEE_802.1ad>802.1ad</a>) 以及后续衍生出来的 <a href=https://en.wikipedia.org/wiki/Virtual_Extensible_LAN>VXLAN</a> 等 *VLAN 协议……</p><p>往简单来说 CNI 插件基本的功能就是执行 <code>ip link</code>, <code>ip route</code>, <code>ip netns</code> 等一系列命令为 Pod 的 Network Namespace 和主机的 Default Network Namespace 之间创建虚拟网卡实现互相通信。Go 语言同样有 Library 提供了 Linux <code>ip</code> 命令的代码，常用的 Go Library 包含以下的：</p><ul><li><a href=https://github.com/vishvananda/netlink>https://github.com/vishvananda/netlink</a>: Go 语言实现的 <code>iproute2</code> 命令行工具的 API，可以执行类似 <code>ip link</code>, <code>ip route</code> 等命令</li><li><a href=https://github.com/vishvananda/netns>https://github.com/vishvananda/netns</a>: Go 语言实现的处理 Linux Network Namespace API</li><li><a href=https://github.com/containernetworking/cni>https://github.com/containernetworking/cni</a>: 包含 CNI 定义 Types 和常用组件</li></ul><p>打开<a href=https://github.com/containernetworking/plugins/blob/main/plugins/main/ptp/ptp.go>样例 p2p CNI 插件代码</a>，先看他的 <code>main</code> 函数只有简洁的一行 <code>skel.PluginMain</code>，这个方法会处理环境变量传入的 CNI 参数，加载 Config，执行相应的 COMMAND。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>skel</span><span class=p>.</span><span class=nf>PluginMain</span><span class=p>(</span><span class=nx>cmdAdd</span><span class=p>,</span> <span class=nx>cmdCheck</span><span class=p>,</span> <span class=nx>cmdDel</span><span class=p>,</span> <span class=nx>version</span><span class=p>.</span><span class=nx>All</span><span class=p>,</span> <span class=nx>bv</span><span class=p>.</span><span class=nf>BuildString</span><span class=p>(</span><span class=s>&#34;ptp&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=add-命令>ADD 命令<a hidden class=anchor aria-hidden=true href=#add-命令>#</a></h4><p>ADD 命令用于为容器创建网卡（或修改已有的网卡），找一下 p2p CNI 插件的 <code>cmdAdd</code> 函数，大致简化一下里面的代码流程为：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>cmdAdd</span><span class=p>(</span><span class=nx>args</span> <span class=o>*</span><span class=nx>skel</span><span class=p>.</span><span class=nx>CmdArgs</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Load CNI Config
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>conf</span> <span class=o>:=</span> <span class=nx>NetConf</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=nx>args</span><span class=p>.</span><span class=nx>StdinData</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>conf</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to load netconf: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// ---------------------------------------------
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// Execute IPAM command to get IP address
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>r</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ipam</span><span class=p>.</span><span class=nf>ExecAdd</span><span class=p>(</span><span class=nx>conf</span><span class=p>.</span><span class=nx>IPAM</span><span class=p>.</span><span class=nx>Type</span><span class=p>,</span> <span class=nx>args</span><span class=p>.</span><span class=nx>StdinData</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>result</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>current</span><span class=p>.</span><span class=nf>NewResultFromResult</span><span class=p>(</span><span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>result</span><span class=p>.</span><span class=nx>IPs</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;IPAM plugin returned missing IP config&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ip</span><span class=p>.</span><span class=nf>EnableForward</span><span class=p>(</span><span class=nx>result</span><span class=p>.</span><span class=nx>IPs</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Could not enable IP forwarding: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// ---------------------------------------------
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// Create Veth Pair for Pod Network Namespace
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>netns</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ns</span><span class=p>.</span><span class=nf>GetNS</span><span class=p>(</span><span class=nx>args</span><span class=p>.</span><span class=nx>Netns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to open netns %q: %v&#34;</span><span class=p>,</span> <span class=nx>args</span><span class=p>.</span><span class=nx>Netns</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>netns</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>hostInterface</span><span class=p>,</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>setupContainerVeth</span><span class=p>(</span><span class=nx>netns</span><span class=p>,</span> <span class=nx>args</span><span class=p>.</span><span class=nx>IfName</span><span class=p>,</span> <span class=nx>conf</span><span class=p>.</span><span class=nx>MTU</span><span class=p>,</span> <span class=nx>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// ---------------------------------------------
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// Setup Veth Pair for default Network Namespace
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>err</span> <span class=p>=</span> <span class=nf>setupHostVeth</span><span class=p>(</span><span class=nx>hostInterface</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>result</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Some other IP forward (masquerade) operations...
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>return</span> <span class=nx>types</span><span class=p>.</span><span class=nf>PrintResult</span><span class=p>(</span><span class=nx>result</span><span class=p>,</span> <span class=nx>conf</span><span class=p>.</span><span class=nx>CNIVersion</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>简单概括样例 P2P Plugin 的 ADD 命令流程大致为：</p><ol><li>加载 CNI Config 配置文件</li><li>执行 IPAM 获取 Pod IP</li><li>创建一对 Veth Pair，其中一个 Iface 接口放在 Pod NS 中，配置 IP、路由等</li><li>另一个 Veth Pair 的 Iface 接口放在 default NS 中，配置 IP、路由……</li><li>配置 Default NS 的 Masquerade 等额外操作</li><li>输出运行结果</li></ol><h4 id=del-命令>DEL 命令<a hidden class=anchor aria-hidden=true href=#del-命令>#</a></h4><p>DEL 命令用于释放容器和主机的网卡接口资源，在 Pod 删除时被执行，以下是简化的样例 P2P Plugin 的 <code>cmdDel</code> 函数代码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>cmdDel</span><span class=p>(</span><span class=nx>args</span> <span class=o>*</span><span class=nx>skel</span><span class=p>.</span><span class=nx>CmdArgs</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Load CNI Config
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>conf</span> <span class=o>:=</span> <span class=nx>NetConf</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=nx>args</span><span class=p>.</span><span class=nx>StdinData</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>conf</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to load netconf: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// ---------------------------------------------
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// Execute IPAM command to release IP address
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ipam</span><span class=p>.</span><span class=nf>ExecDel</span><span class=p>(</span><span class=nx>conf</span><span class=p>.</span><span class=nx>IPAM</span><span class=p>.</span><span class=nx>Type</span><span class=p>,</span> <span class=nx>args</span><span class=p>.</span><span class=nx>StdinData</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// ---------------------------------------------
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// Release link interface &amp; masquerades...
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kd>var</span> <span class=nx>ipnets</span> <span class=p>[]</span><span class=o>*</span><span class=nx>net</span><span class=p>.</span><span class=nx>IPNet</span>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>ns</span><span class=p>.</span><span class=nf>WithNetNSPath</span><span class=p>(</span><span class=nx>args</span><span class=p>.</span><span class=nx>Netns</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>_</span> <span class=nx>ns</span><span class=p>.</span><span class=nx>NetNS</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kd>var</span> <span class=nx>err</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>		<span class=nx>ipnets</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>ip</span><span class=p>.</span><span class=nf>DelLinkByNameAddr</span><span class=p>(</span><span class=nx>args</span><span class=p>.</span><span class=nx>IfName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>err</span> <span class=o>==</span> <span class=nx>ip</span><span class=p>.</span><span class=nx>ErrLinkNotFound</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=o>...</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>ipnets</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nx>conf</span><span class=p>.</span><span class=nx>IPMasq</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>ipn</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>ipnets</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>err</span> <span class=p>=</span> <span class=nx>ip</span><span class=p>.</span><span class=nf>TeardownIPMasq</span><span class=p>(</span><span class=nx>ipn</span><span class=p>,</span> <span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>简单概括 DEL 命令流程大致为：</p><ol><li>加载 CNI Config 配置文件</li><li>执行 IPAM 释放 Pod IP</li><li>释放 Veth Pair 和其他配置 (Masquerade&mldr;)</li></ol><h4 id=check-命令>CHECK 命令<a hidden class=anchor aria-hidden=true href=#check-命令>#</a></h4><p>CHECK 命令用于校验 Pod 网络，CNI Spec 0.4.0 中，Config 新增了 <code>prevResult</code> 字段，记录了 CNI 插件上一次执行 ADD 命令的执行结果。
CHECK 命令将 <code>prevResult</code> 记录的状态信息和设定的期望值进行比对，输出校验结果。</p><blockquote><p>未完待续</p></blockquote></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.starry-s.moe/tags/network/>Network</a></li><li><a href=https://blog.starry-s.moe/tags/container/>Container</a></li><li><a href=https://blog.starry-s.moe/tags/kubernetes/>Kubernetes</a></li></ul><nav class=paginav><a class=next href=https://blog.starry-s.moe/posts/2024/leader-election/><span class=title>下一页 »</span><br><span>Leader Election 折腾小记</span></a></nav></footer><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//starry-s-blog.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>© 2016 - 2024 STARRY-S | <a href=https://creativecommons.org/licenses/by-nc-nd/4.0/>CC BY-NC-ND 4.0</a> | Hosted on <a href=https://pages.github.com>GitHub Pages</a><br></span><span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>const pathname=window.location.pathname,images=document.querySelectorAll("img");Array.from(images).forEach(e=>{if(!pathname.includes("/posts/"))return;if(e.src.indexOf("images")<0)return;e.addEventListener("load",()=>fitImage(e)),e.complete&&e.naturalWidth!==0&&fitImage(e)});function fitImage(e){e.style.marginLeft="auto",e.style.marginRight="auto",e.naturalWidth/e.naturalHeight<1.1&&(e.style.maxWidth="60%",e.style.height="auto")}</script><script src=/js/home-info.js></script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>