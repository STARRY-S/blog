<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>折腾一台 Arch Linux 服务器 | STARRY-S' Blog</title>
<meta name=keywords content="Arch Linux"><meta name=description content="又买了一堆电子垃圾，折腾了一台家用的服务器。"><meta name=author content="STARRY-S"><link rel=canonical href=https://blog.starry-s.moe/posts/2025/archlinux-server/><link crossorigin=anonymous href=/assets/css/stylesheet.82243f2445c1f83101fee8f6753a80b2b140ea4c8ea2f729a484fe488b619f89.css integrity="sha256-giQ/JEXB+DEB/uj2dTqAsrFA6kyOovcppIT+SIthn4k=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.starry-s.moe/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://blog.starry-s.moe/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.starry-s.moe/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.starry-s.moe/apple-touch-icon.png><link rel=mask-icon href=https://blog.starry-s.moe/apple-touch-icon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://blog.starry-s.moe/posts/2025/archlinux-server/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/aplayer/dist/APlayer.min.css><script src=https://fastly.jsdelivr.net/npm/aplayer/dist/APlayer.min.js></script><script src=https://fastly.jsdelivr.net/npm/meting/dist/Meting.min.js></script><script>var meting_api="https://api.injahow.cn/meting/?server=:server&type=:type&id=:id&auth=:auth&r=:r"</script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#232323"><meta property="og:url" content="https://blog.starry-s.moe/posts/2025/archlinux-server/"><meta property="og:site_name" content="STARRY-S' Blog"><meta property="og:title" content="折腾一台 Arch Linux 服务器"><meta property="og:description" content="又买了一堆电子垃圾，折腾了一台家用的服务器。"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-01-19T01:37:09+08:00"><meta property="article:modified_time" content="2025-01-19T01:37:09+08:00"><meta property="article:tag" content="Arch Linux"><meta property="og:image" content="https://blog.starry-s.moe/avatar.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.starry-s.moe/avatar.png"><meta name=twitter:title content="折腾一台 Arch Linux 服务器"><meta name=twitter:description content="又买了一堆电子垃圾，折腾了一台家用的服务器。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.starry-s.moe/posts/"},{"@type":"ListItem","position":2,"name":"折腾一台 Arch Linux 服务器","item":"https://blog.starry-s.moe/posts/2025/archlinux-server/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"折腾一台 Arch Linux 服务器","name":"折腾一台 Arch Linux 服务器","description":"又买了一堆电子垃圾，折腾了一台家用的服务器。\n","keywords":["Arch Linux"],"articleBody":"又买了一堆电子垃圾，折腾了一台家用的服务器。\n两年前，咱折腾了一台 ITX 主机作为 NAS 使用，以存储这几年相机拍的照片。不过一台迷你 ITX NAS 主机能运行的虚拟机数量已经满足不了咱对于折腾的需求了，于是又捡了些垃圾配件组了个配置差不多的 M-ATX 台式电脑，作为咱的服务器使用。\n配置清单：\n主板：华硕 B550M PLUS 重炮手 CPU：AMD R7 5700X 内存：旧电脑上拆下来的镁光 DDR4 3200 8G * 4 GPU：NVIDIA Tesla P4 硬盘：国产的杂牌 PCIE 3.0 速率的 NVME 固态，容量 2 TB 机箱：先马平头哥 M2 MESH 一些静音风扇 散热为旧电脑上换下来的双塔散热 因为是拿二手的电脑配件拼的电脑，CPU 也是买的是散片，内存用的是旧电脑上拆的 8G 条子，所以这个服务器有点灵车的性质，咱也不知道它能不能稳定运行，不过它并不作为 NAS 使用，不需要备份重要文件，所以稳定性不是非常重要，咱也没有给他配 UPS 备用电源。除此之外，因为是家用的服务器，所以选的无集显的 AMD 5700X CPU，插上了一个无视频输出的服务器 GPU 卡。装机过程中虽然主板插上了这个服务器显卡，但因为显卡没有视频输出接口，CPU 也没有集显，所以主板开机启动时 VGA 自检灯会一直白色常亮报警。不过搜了一下 NGA 论坛上的讨论，华硕的 550/570 系列的这个 AMD 主板的 BIOS 里虽然没有显卡无头启动的选项开关，但默认是已经支持无头启动了，虽然自检的 VGA 灯会一直白色常亮，但系统可以正常启动，只是显示器一直黑屏，没有画面输出（BIOS 也不能显示）。\n于是在装系统时，咱把之前装机时买的 GT730D 亮机卡插上去，进 BIOS 关掉亮瞎眼的 ARGB 灯，启用 SVM，配置好内存频率和 UEFI 启动，关掉安全启动，设置风扇为静音模式。之后用 U 盘把系统安装好，写好网络配置文件并启用 SSH 远程连接，之后关机（PCIE 不支持热插拔一定要关机再拔卡）把显卡换成没有视频输出的 Tesla P4。这样一台“无头”，但有 GPU 的服务器就装好了。\n其实咱试过要不要把这个 GT730D 亮机卡和 Tesla P4 一起插在主板上，因为毕竟这个主板有两个 PCIE x16 的槽子，一个是 PCIE 4.0，另一个是 PCIE 3.0。但是 GT730D 只支持 nvidia-470xx 版本的驱动（或 nouveau），Tesla P4 尽管不支持近几年新出的 nvidia-open 开源驱动（这个驱动只支持近几年新出的 Turing 图灵系列的卡而 P4 是 Pascal 架构）， 但是可以用最新的闭源 nvidia 驱动。咱不想装太旧的显卡驱动于是只好在装机配置电脑的过程中无数次关机，开机箱换显卡……\nTesla P4 显卡是一个半高卡（刀卡），仅需 PCIE 供电，功耗 75W，无主动散热风扇，因此需要改装风扇散热，咱使用的是网上买的 3D 打印风扇。\nTesla P4 改装散热\n安装好主板和 CPU、显卡之后是酱紫的。\n安装主板 CPU 和显卡\n最终安装上散热风扇和内存的样子。\n安装散热风扇和内存\nGPU Passthrough 为了能够在虚拟机里也能使用 GPU 资源，有一种方式是可以通过 GPU Passthrough 的方式将显卡设备直通至 KVM 虚拟机，在折腾 vGPU 之前，先试一下 Single GPU Passthrough。\nIOMMU Group 参照 Arch Wiki，主板在开启 SVM 后，默认就启用了 AMD VT-d 虚拟化并支持 IOMMU，所以默认情况下不需要配置 vfio，直接执行这个 iommu.sh 脚本就可以查看 PCIE 设备对应的 IOMMU Group。\n$ sudo dmesg | grep AMD-Vi [ 0.796858] pci 0000:00:00.2: AMD-Vi: IOMMU performance counters supported [ 0.799440] AMD-Vi: Extended features (0x58f77ef22294a5a, 0x0): PPR NX GT IA PC GA_vAPIC [ 0.799447] AMD-Vi: Interrupt remapping enabled $ sudo dmesg | grep IOMMU [ 0.741773] perf/amd_iommu: Detected AMD IOMMU #0 (2 banks, 4 counters/bank). $ iommu.sh ... IOMMU Group 14: 07:00.0 3D controller [0302]: NVIDIA Corporation GP104GL [Tesla P4] [10de:1abc] (rev a1) ... 咱的 Tesla P4 显卡插在华硕 B550M 重炮手的 PCIE 4.0x16 插槽上，执行 iommu.sh 可以看到 Tesla P4 这个卡只在一个 IOMMU Group 14 这个 Group 里面，因为显卡没有输出接口所以这个 Group 里也没有音频输出的 Audio Device。\n注意不能将显卡插在主板的 PCIE 3.0x16 插槽里，如果这么弄的话，这个卡设备会和 CPU 等好多主板设备共用一个 Group，这样就没办法只将显卡设备直通到虚拟机里。\n除此之外因为服务器只有一块显卡，所以当显卡被直通到虚拟机后，服务器将不能运行 X Server，且一个显卡只能直通给一个虚拟机使用，不能分成多个 vGPU。在这篇 Single GPU Passhrough Wiki 里介绍可以加内核参数 video=efifb:off，避免显卡设备从虚拟机返回到主机时遇到问题。\n配置 libvirt 服务器上面只有一块显卡，且这块卡要被直通给虚拟机使用，所以服务器不能跑 X Server 图形界面，也就是说只能手动配置 libvirt 的 Domain XML 启动虚拟机。或者先跑起来一个 VNC Server，使用 virt-manager 创建好虚拟机之后，再停掉 VNC Server 并 rmmod 主机上已加载的显卡驱动内核模块。\nlibvirt 的安装和配置教程可以直接参照 Wiki，这里不再赘述。\n最后编辑需要直通显卡设备的虚拟机 Domain XML，参照这里移除掉 Virtual Display，然后添加一段 hostdev 将主机的显卡设备直通到虚拟机。\n","wordCount":"2828","inLanguage":"zh","image":"https://blog.starry-s.moe/avatar.png","datePublished":"2025-01-19T01:37:09+08:00","dateModified":"2025-01-19T01:37:09+08:00","author":{"@type":"Person","name":"STARRY-S"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.starry-s.moe/posts/2025/archlinux-server/"},"publisher":{"@type":"Organization","name":"STARRY-S' Blog","logo":{"@type":"ImageObject","url":"https://blog.starry-s.moe/favicon-32x32.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.starry-s.moe/ accesskey=h title="Blog (Alt + H)"><img src=https://blog.starry-s.moe/apple-touch-icon.png alt aria-label=logo height=24>Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.starry-s.moe/gallery/ title=相册><span>相册</span></a></li><li><a href=https://blog.starry-s.moe/archives/ title=归档><span>归档</span></a></li><li><a href=https://blog.starry-s.moe/tags/ title=标签><span>标签</span></a></li><li><a href=https://blog.starry-s.moe/categories/ title=分类><span>分类</span></a></li><li><a href=https://blog.starry-s.moe/search/ title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li><li><a href=https://blog.starry-s.moe/projects/ title=项目><span>项目</span></a></li><li><a href=https://blog.starry-s.moe/about/ title=关于><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.starry-s.moe/>主页</a>&nbsp;»&nbsp;<a href=https://blog.starry-s.moe/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">折腾一台 Arch Linux 服务器</h1><div class=post-meta><span title='2025-01-19 01:37:09 +0800 +0800'>2025-01-19 01:37:09 +0800</span>&nbsp;·&nbsp;6 分钟&nbsp;·&nbsp;2828 字&nbsp;·&nbsp;STARRY-S&nbsp;|&nbsp;<a href=https://github.com/STARRY-S/blog/edit/main/content/posts/2025/archlinux-server/index.md rel="noopener noreferrer" target=_blank>Edit Text</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#gpu-passthrough>GPU Passthrough</a><ul><li><a href=#iommu-group>IOMMU Group</a></li><li><a href=#配置-libvirt>配置 libvirt</a></li></ul></li><li><a href=#vgpu-分割显卡>vGPU 分割显卡</a></li></ul></nav></div></details></div><div class=post-content><p>又买了一堆电子垃圾，折腾了一台家用的服务器。</p><meting-js server=netease type=song id=2102766948 theme=#233333></meting-js><hr><p>两年前，咱折腾了一台 ITX 主机作为 NAS 使用，以存储这几年相机拍的照片。不过一台迷你 ITX NAS 主机能运行的虚拟机数量已经满足不了咱对于折腾的需求了，于是又捡了些垃圾配件组了个配置差不多的 M-ATX 台式电脑，作为咱的服务器使用。</p><p>配置清单：</p><ul><li>主板：华硕 B550M PLUS 重炮手</li><li>CPU：AMD R7 5700X</li><li>内存：旧电脑上拆下来的镁光 DDR4 3200 8G * 4</li><li>GPU：NVIDIA Tesla P4</li><li>硬盘：国产的杂牌 PCIE 3.0 速率的 NVME 固态，容量 2 TB</li><li>机箱：先马平头哥 M2 MESH</li><li>一些静音风扇</li><li>散热为旧电脑上换下来的双塔散热</li></ul><p>因为是拿二手的电脑配件拼的电脑，CPU 也是买的是散片，内存用的是旧电脑上拆的 8G 条子，所以这个服务器有点灵车的性质，咱也不知道它能不能稳定运行，不过它并不作为 NAS 使用，不需要备份重要文件，所以稳定性不是非常重要，咱也没有给他配 UPS 备用电源。除此之外，因为是家用的服务器，所以选的无集显的 AMD 5700X CPU，插上了一个无视频输出的服务器 GPU 卡。装机过程中虽然主板插上了这个服务器显卡，但因为显卡没有视频输出接口，CPU 也没有集显，所以主板开机启动时 VGA 自检灯会一直白色常亮报警。不过搜了一下 NGA 论坛上的讨论，华硕的 550/570 系列的这个 AMD 主板的 BIOS 里虽然没有显卡无头启动的选项开关，但默认是已经支持无头启动了，虽然自检的 VGA 灯会一直白色常亮，但系统可以正常启动，只是显示器一直黑屏，没有画面输出（BIOS 也不能显示）。</p><p>于是在装系统时，咱把之前装机时买的 GT730D 亮机卡插上去，进 BIOS 关掉亮瞎眼的 ARGB 灯，启用 SVM，配置好内存频率和 UEFI 启动，关掉安全启动，设置风扇为静音模式。之后用 U 盘把系统安装好，写好网络配置文件并启用 SSH 远程连接，之后关机（PCIE 不支持热插拔一定要关机再拔卡）把显卡换成没有视频输出的 Tesla P4。这样一台“无头”，但有 GPU 的服务器就装好了。</p><blockquote><p>其实咱试过要不要把这个 GT730D 亮机卡和 Tesla P4 一起插在主板上，因为毕竟这个主板有两个 PCIE x16 的槽子，一个是 PCIE 4.0，另一个是 PCIE 3.0。但是 GT730D 只支持 nvidia-470xx 版本的驱动（或 nouveau），Tesla P4 尽管不支持近几年新出的 nvidia-open 开源驱动（这个驱动只支持近几年新出的 Turing 图灵系列的卡而 P4 是 Pascal 架构）， 但是可以用最新的闭源 <code>nvidia</code> 驱动。咱不想装太旧的显卡驱动于是只好在装机配置电脑的过程中无数次关机，开机箱换显卡……</p></blockquote><p>Tesla P4 显卡是一个半高卡（刀卡），仅需 PCIE 供电，功耗 75W，无主动散热风扇，因此需要改装风扇散热，咱使用的是网上买的 3D 打印风扇。</p><p><img loading=lazy src=images/2.jpg alt><p style=margin-bottom:-.8em class=image-title>Tesla P4 改装散热</p></p><p>安装好主板和 CPU、显卡之后是酱紫的。</p><p><img loading=lazy src=images/3.jpg alt><p style=margin-bottom:-.8em class=image-title>安装主板 CPU 和显卡</p></p><p>最终安装上散热风扇和内存的样子。</p><p><img loading=lazy src=images/4.jpg alt><p style=margin-bottom:-.8em class=image-title>安装散热风扇和内存</p></p><h2 id=gpu-passthrough>GPU Passthrough<a hidden class=anchor aria-hidden=true href=#gpu-passthrough>#</a></h2><p>为了能够在虚拟机里也能使用 GPU 资源，有一种方式是可以通过 GPU Passthrough 的方式将显卡设备直通至 KVM 虚拟机，在折腾 vGPU 之前，先试一下 Single GPU Passthrough。</p><h3 id=iommu-group>IOMMU Group<a hidden class=anchor aria-hidden=true href=#iommu-group>#</a></h3><p>参照 <a href=https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF>Arch Wiki</a>，主板在开启 SVM 后，默认就启用了 AMD VT-d 虚拟化并支持 IOMMU，所以默认情况下不需要配置 <code>vfio</code>，直接执行<a href=https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF#Ensuring_that_the_groups_are_valid>这个 <code>iommu.sh</code> 脚本</a>就可以查看 PCIE 设备对应的 IOMMU Group。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> sudo dmesg <span class=p>|</span> grep AMD-Vi
</span></span><span class=line><span class=cl><span class=go>[    0.796858] pci 0000:00:00.2: AMD-Vi: IOMMU performance counters supported
</span></span></span><span class=line><span class=cl><span class=go>[    0.799440] AMD-Vi: Extended features (0x58f77ef22294a5a, 0x0): PPR NX GT IA PC GA_vAPIC
</span></span></span><span class=line><span class=cl><span class=go>[    0.799447] AMD-Vi: Interrupt remapping enabled
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>$</span> sudo dmesg <span class=p>|</span> grep IOMMU
</span></span><span class=line><span class=cl><span class=go>[    0.741773] perf/amd_iommu: Detected AMD IOMMU #0 (2 banks, 4 counters/bank).
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>$</span> iommu.sh
</span></span><span class=line><span class=cl><span class=go>...
</span></span></span><span class=line><span class=cl><span class=go>IOMMU Group 14:
</span></span></span><span class=line><span class=cl><span class=go>	07:00.0 3D controller [0302]: NVIDIA Corporation GP104GL [Tesla P4] [10de:1abc] (rev a1)
</span></span></span><span class=line><span class=cl><span class=go>...
</span></span></span></code></pre></div><p>咱的 Tesla P4 显卡插在华硕 B550M 重炮手的 PCIE 4.0x16 插槽上，执行 <code>iommu.sh</code> 可以看到 Tesla P4 这个卡只在一个 <code>IOMMU Group 14</code> 这个 Group 里面，因为显卡没有输出接口所以这个 Group 里也没有音频输出的 Audio Device。</p><p>注意不能将显卡插在主板的 PCIE 3.0x16 插槽里，如果这么弄的话，这个卡设备会和 CPU 等好多主板设备共用一个 Group，这样就没办法只将显卡设备直通到虚拟机里。</p><p>除此之外因为服务器只有一块显卡，所以当显卡被直通到虚拟机后，服务器将不能运行 X Server，且一个显卡只能直通给一个虚拟机使用，不能分成多个 vGPU。在这篇 <a href=https://gitlab.com/risingprismtv/single-gpu-passthrough/-/wikis/2%29-Editing-your-Bootloader>Single GPU Passhrough Wiki</a> 里介绍可以加内核参数 <code>video=efifb:off</code>，避免显卡设备从虚拟机返回到主机时遇到问题。</p><h3 id=配置-libvirt>配置 libvirt<a hidden class=anchor aria-hidden=true href=#配置-libvirt>#</a></h3><p>服务器上面只有一块显卡，且这块卡要被直通给虚拟机使用，所以服务器不能跑 X Server 图形界面，也就是说只能手动配置 libvirt 的 Domain XML 启动虚拟机。或者先跑起来一个 VNC Server，使用 <code>virt-manager</code> 创建好虚拟机之后，再停掉 VNC Server 并 <code>rmmod</code> 主机上已加载的显卡驱动内核模块。</p><p>libvirt 的安装和配置教程可以直接参照 <a href=https://wiki.archlinux.org/title/Libvirt>Wiki</a>，这里不再赘述。</p><p>最后编辑需要直通显卡设备的虚拟机 Domain XML，参照这里<a href=https://gitlab.com/risingprismtv/single-gpu-passthrough/-/wikis/8%29-Attaching-the-GPU-to-your-VM#removing-the-virtual-display>移除掉 Virtual Display</a>，然后添加一段 <code>hostdev</code> 将主机的显卡设备直通到虚拟机。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;hostdev</span> <span class=na>mode=</span><span class=s>&#34;subsystem&#34;</span> <span class=na>type=</span><span class=s>&#34;pci&#34;</span> <span class=na>managed=</span><span class=s>&#34;yes&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;source&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;address</span> <span class=na>domain=</span><span class=s>&#34;0x0000&#34;</span> <span class=na>bus=</span><span class=s>&#34;0x07&#34;</span> <span class=na>slot=</span><span class=s>&#34;0x00&#34;</span> <span class=na>function=</span><span class=s>&#34;0x0&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/source&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;address</span> <span class=na>type=</span><span class=s>&#34;pci&#34;</span> <span class=na>domain=</span><span class=s>&#34;0x0000&#34;</span> <span class=na>bus=</span><span class=s>&#34;0x07&#34;</span> <span class=na>slot=</span><span class=s>&#34;0x00&#34;</span> <span class=na>function=</span><span class=s>&#34;0x0&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/hostdev&gt;</span>
</span></span></code></pre></div><p>这里咱的显卡为 <code>07:00.0</code>，对应 XML 中的 <code>domain="0x0000" bus="0x07" slot="0x00" function="0x0"</code>。</p><p>因为显卡被直通给虚拟机，所以主机上不能运行 X Server，如果 libvirt 在启动虚拟机时卡住，可能是因为显卡驱动还在被主机加载，显卡设备依旧被主机使用而无法被直通给虚拟机。
这是可以执行 <code>rmmod</code> 重新加载显卡驱动，让主机让出显卡给虚拟机使用。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1># reload-nvidia.sh</span>
</span></span><span class=line><span class=cl>sudo rmmod nvidia_drm nvidia_uvm nvidia_modeset nvidia
</span></span><span class=line><span class=cl>sudo modprobe nvidia nvidia_uvm
</span></span></code></pre></div><p>虚拟机启动后，需要通过 SSH 连接到虚拟机，或通过虚拟机的 VNC 图形界面连接到虚拟机，之后在虚拟机里安装好 <code>nvidia</code> 驱动，就可以看到一整块的显卡设备都被直通给这个虚拟机里了。</p><p><img loading=lazy src=images/1.png alt></p><h2 id=vgpu-分割显卡>vGPU 分割显卡<a hidden class=anchor aria-hidden=true href=#vgpu-分割显卡>#</a></h2><p>Single GPU Passthrough 的局限很明显，只能将显卡直通给一个虚拟机独享，且这期间主机不能使用图形界面。所以可以用 NVIDIA 的 vGPU 将显卡分为多个“虚拟的小卡”，这样每个虚拟机都有显卡资源使用，肥肠适合在虚拟机中模拟 GPU 集群的开发等折腾场景。</p><p>NVIDIA vGPU 驱动为付费使用，可以申请 90 天试用，vGPU 的驱动获取方式这里不赘述。</p><p>因为 Tesla P4 仅支持 G16 及之前版本的 vGPU 驱动，Arch Linux 的 <code>linux</code> 内核版本很别新，且 GCC 版本为 14，英伟达的 vGPU 驱动并没有已编译好的可直接无痛安装的版本，于是只能用 The Hard Way 来编译 NVIDIA 驱动内核模块了。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># 卸载已安装的显卡驱动</span>
</span></span><span class=line><span class=cl>pacman -R nvidia nvidia-utils
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#  解压显卡驱动安装文件</span>
</span></span><span class=line><span class=cl>./NVIDIA-Linux-x86_64-535.xxx-vgpu-kvm.run -x
</span></span><span class=line><span class=cl><span class=nb>cd</span> NVIDIA-Linux-x86_64*/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 编译 DKMS 内核模块并安装</span>
</span></span><span class=line><span class=cl>./nvidia-installer --dkms
</span></span></code></pre></div><p>首先需要解决一下 <code>error: implicit declaration of function 'follow_pfn'; did you mean 'folio_pfn'?</code> 报错，新版的内核移除了 <code>follow_pfn</code>，所以要参照<a href=https://forums.developer.nvidia.com/t/gpl-only-symbols-follow-pte-and-rcu-read-unlock-prevent-470-256-02-to-build-with-kernel-6-10/300052>这里</a>手动改下代码。</p><ol><li><p>编辑 <code>kernel/conftest.sh</code>，修改 <code>unsafe_follow_pfn</code> 为 <code>follow_pfn</code>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>        follow_pfn<span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=c1>#</span>
</span></span><span class=line><span class=cl>            <span class=c1># Determine if follow_pfn() is present.</span>
</span></span><span class=line><span class=cl>            <span class=c1>#</span>
</span></span><span class=line><span class=cl>            <span class=c1># follow_pfn() was added by commit 69bacee7f9ad</span>
</span></span><span class=line><span class=cl>            <span class=c1># (&#34;mm: Add follow_pfn&#34;) in v5.13-rc1.</span>
</span></span><span class=line><span class=cl>            <span class=c1>#</span>
</span></span><span class=line><span class=cl>            <span class=nv>CODE</span><span class=o>=</span><span class=s2>&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            #include &lt;linux/mm.h&gt;
</span></span></span><span class=line><span class=cl><span class=s2>            void conftest_follow_pfn(void) {
</span></span></span><span class=line><span class=cl><span class=s2>                follow_pfn();
</span></span></span><span class=line><span class=cl><span class=s2>            }&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            compile_check_conftest <span class=s2>&#34;</span><span class=nv>$CODE</span><span class=s2>&#34;</span> <span class=s2>&#34;NV_FOLLOW_PFN_PRESENT&#34;</span> <span class=s2>&#34;&#34;</span> <span class=s2>&#34;functions&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>;;</span>
</span></span></code></pre></div></li><li><p>编辑 <code>kernel/nvidia/nvidia.Kbuild</code>，改成 <code>follow_pfn</code>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>NV_CONFTEST_FUNCTION_COMPILE_TESTS += follow_pfn
</span></span></code></pre></div></li><li><p>编辑 <code>kernel/nvidia/os-mlock.c</code> 的 <code>nv_follow_pfn</code> 函数，修改为这样子。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>    <span class=k>static</span> <span class=kr>inline</span> <span class=kt>int</span> <span class=nf>nv_follow_pfn</span><span class=p>(</span><span class=k>struct</span> <span class=n>vm_area_struct</span> <span class=o>*</span><span class=n>vma</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>address</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=o>*</span><span class=n>pfn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cp>#if defined(NV_FOLLOW_PFN_PRESENT)
</span></span></span><span class=line><span class=cl><span class=cp></span>        <span class=k>return</span> <span class=nf>follow_pfn</span><span class=p>(</span><span class=n>vma</span><span class=p>,</span> <span class=n>address</span><span class=p>,</span> <span class=n>pfn</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=cp>#else
</span></span></span><span class=line><span class=cl><span class=cp></span>        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=p>}</span>
</span></span></code></pre></div></li></ol><p>之后再编译时还会遇到 <code>error: 'no_llseek' undeclared here (not in a function); did you mean 'noop_llseek'?</code> 报错，搜了一下发现在 Kernel 6.12 中 <code>no_llseek</code> <a href=https://github.com/google/gasket-driver/commit/4b2a1464f3b619daaf0f6c664c954a42c4b7ce00.patch>已被移除</a>，
可以直接编辑 <code>kernel/nvidia-vgpu-vfio/nvidia-vgpu-vfio.c</code> <a href=https://lore.kernel.org/linux-next/20220715140259.205ef267@canb.auug.org.au/>移除掉有 <code>no_llseek</code> 的行</a>。</p><p>然后在加载编译后的内核驱动模块时会遇到 <code>failing symbol_get of non-GPLONLY symbol nvidia_vgpu_vfio_get_ops.</code> 报错。这里为了能让内核模块被加载到内核里，只能编辑 <code>kernel/nvidia/nv-vgpu-vfio-interface.c</code> 将 <code>EXPORT_SYMBOL(nvidia_vgpu_vfio_get_ops)</code> 改成 <code>EXPORT_SYMBOL_GPL(nvidia_vgpu_vfio_get_ops)</code>，将 <code>EXPORT_SYMBOL(nvidia_vgpu_vfio_set_ops)</code> 改成 <code>EXPORT_SYMBOL_GPL(nvidia_vgpu_vfio_set_ops)</code>。尽管并不建议直接把非 GPL Symbol 改成 GPL，但如果要在最新的内核版本中安装这个驱动，只能这么修改，或者试着降级至某个 <code>linux-lts</code> 版本，不过降级至其他 LTS 版本还需要手动解决 LTS 版本内核编译时遇到的依赖冲突问题……</p><p>驱动安装好之后，就可以参照<a href=https://documentation.suse.com/sles/15-SP6/html/SLES-all/article-nvidia-vgpu.html#configure-nvidia-vgpu-passthrough>这个步骤</a>，将显卡的 <code>mdev</code> 设备分给虚拟机使用了。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.starry-s.moe/tags/arch-linux/>Arch Linux</a></li></ul><nav class=paginav><a class=next href=https://blog.starry-s.moe/posts/2025/neptune-4-max/><span class=title>下一页 »</span><br><span>海王星 4 MAX 3D 打印机入坑小记</span></a></nav></footer><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//starry-s-blog.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>© 2016 - 2025 STARRY-S | <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a> | Hosted on <a href=https://pages.github.com>GitHub Pages</a><br></span>·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>const pathname=window.location.pathname,images=document.querySelectorAll("img");Array.from(images).forEach(e=>{if(!pathname.includes("/posts/"))return;if(e.src.indexOf("images")<0)return;e.addEventListener("load",()=>fitImage(e)),e.complete&&e.naturalWidth!==0&&fitImage(e)});function fitImage(e){e.style.marginLeft="auto",e.style.marginRight="auto",e.naturalWidth/e.naturalHeight<1.1&&(e.style.maxWidth="60%",e.style.height="auto")}</script><script src=/js/home-info.js></script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>